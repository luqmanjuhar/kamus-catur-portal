// Google Apps Script for Voucher Management System with Automation
// This script handles voucher updates, redemptions, and automatic calculations

function doPost(e) {
  try {
    // Parse the incoming data
    const data = e.parameter;
    const action = data.action;
    
    // Get the spreadsheet
    const spreadsheet = SpreadsheetApp.openById('1YYz6hTQCGn0XfNNgJ0k_FpzqfSUWIiQOIBR3g_c4RHc');
    
    let result = {};
    
    if (action === 'updateVoucher') {
      result = updateVoucher(spreadsheet, data);
    } else if (action === 'redeemVouchers') {
      result = redeemVouchers(spreadsheet, data);
    } else if (action === 'refreshCalculations') {
      result = refreshAllCalculations(spreadsheet);
    } else {
      result = { success: false, error: 'Invalid action' };
    }
    
    return ContentService
      .createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    Logger.log('Error in doPost: ' + error.toString());
    return ContentService
      .createTextOutput(JSON.stringify({ 
        success: false, 
        error: error.toString() 
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  // Handle GET requests and trigger automatic calculations
  try {
    const spreadsheet = SpreadsheetApp.openById('1YYz6hTQCGn0XfNNgJ0k_FpzqfSUWIiQOIBR3g_c4RHc');
    refreshAllCalculations(spreadsheet);
    
    return ContentService
      .createTextOutput(JSON.stringify({ 
        success: true, 
        message: 'Voucher Management API is running - calculations updated' 
      }))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({ 
        success: false, 
        error: error.toString() 
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function updateVoucher(spreadsheet, data) {
  try {
    const vouchersSheet = spreadsheet.getSheetByName('VOUCHERS');
    
    if (!vouchersSheet) {
      return { success: false, error: 'VOUCHERS sheet not found' };
    }
    
    // Get all data from vouchers sheet
    const vouchersData = vouchersSheet.getDataRange().getValues();
    const headers = vouchersData[0];
    
    // Find the voucher row by Voucher ID
    let voucherRowIndex = -1;
    for (let i = 1; i < vouchersData.length; i++) {
      if (vouchersData[i][0] === data.voucherId) { // Voucher ID is in column A (index 0)
        voucherRowIndex = i;
        break;
      }
    }
    
    // Calculate days left and status automatically
    const calculatedData = calculateVoucherStatus(spreadsheet, data.voucherId, data.dateIssued);
    
    if (voucherRowIndex === -1) {
      // Voucher doesn't exist, add new row
      const newRow = [
        data.voucherId,
        parseFloat(data.value),
        data.description,
        data.dateIssued,
        calculatedData.status,
        calculatedData.daysLeft
      ];
      vouchersSheet.appendRow(newRow);
    } else {
      // Update existing voucher
      const rowNumber = voucherRowIndex + 1; // Convert to 1-based indexing
      vouchersSheet.getRange(rowNumber, 1, 1, 6).setValues([[
        data.voucherId,
        parseFloat(data.value),
        data.description,
        data.dateIssued,
        calculatedData.status,
        calculatedData.daysLeft
      ]]);
    }
    
    return { 
      success: true, 
      message: 'Voucher updated successfully',
      calculatedStatus: calculatedData.status,
      calculatedDaysLeft: calculatedData.daysLeft
    };
    
  } catch (error) {
    Logger.log('Error in updateVoucher: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

function redeemVouchers(spreadsheet, data) {
  try {
    const vouchersSheet = spreadsheet.getSheetByName('VOUCHERS');
    const usageSheet = spreadsheet.getSheetByName('USAGE');
    
    if (!vouchersSheet) {
      return { success: false, error: 'VOUCHERS sheet not found' };
    }
    
    if (!usageSheet) {
      return { success: false, error: 'USAGE sheet not found' };
    }
    
    // Parse vouchers data from the request
    const vouchers = JSON.parse(data.vouchers);
    
    // Get all data from vouchers sheet
    const vouchersData = vouchersSheet.getDataRange().getValues();
    
    // Process each voucher
    for (let voucher of vouchers) {
      // Find and update voucher status to REDEEMED with 0 days left
      for (let i = 1; i < vouchersData.length; i++) {
        if (vouchersData[i][0] === voucher.voucherId) { // Voucher ID is in column A
          // Update status to REDEEMED (column E, index 4) and days left to 0 (column F, index 5)
          vouchersSheet.getRange(i + 1, 5).setValue('REDEEMED');
          vouchersSheet.getRange(i + 1, 6).setValue(0);
          break;
        }
      }
      
      // Add usage record
      const usageRow = [
        voucher.voucherId,           // Voucher ID
        data.redemptionDate,         // Date Redeemed
        data.usageCategory,          // Usage Category
        data.usageDetails,           // Details
        data.customerName,           // Customer Name
        data.photos || ''            // Photos
      ];
      
      usageSheet.appendRow(usageRow);
    }
    
    return { 
      success: true, 
      message: `Successfully redeemed ${vouchers.length} voucher(s)` 
    };
    
  } catch (error) {
    Logger.log('Error in redeemVouchers: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

function calculateVoucherStatus(spreadsheet, voucherId, dateIssued) {
  try {
    const usageSheet = spreadsheet.getSheetByName('USAGE');
    
    // Check if voucher is redeemed (exists in USAGE table)
    if (usageSheet) {
      const usageData = usageSheet.getDataRange().getValues();
      for (let i = 1; i < usageData.length; i++) {
        if (usageData[i][0] === voucherId && usageData[i][1]) { // Voucher ID matches and Date Redeemed exists
          return {
            status: 'REDEEMED',
            daysLeft: 0
          };
        }
      }
    }
    
    // Check if Date Issued is blank
    if (!dateIssued || dateIssued.trim() === '') {
      return {
        status: 'NOT ISSUED',
        daysLeft: 0
      };
    }
    
    // Calculate days left (90 days validity)
    const issuedDate = new Date(dateIssued);
    const currentDate = new Date();
    const expiryDate = new Date(issuedDate);
    expiryDate.setDate(expiryDate.getDate() + 90); // Add 90 days
    
    const timeDiff = expiryDate.getTime() - currentDate.getTime();
    const daysLeft = Math.ceil(timeDiff / (1000 * 3600 * 24));
    
    // Determine status based on days left
    let status;
    if (daysLeft > 0) {
      status = 'ACTIVE';
    } else {
      status = 'EXPIRED';
    }
    
    return {
      status: status,
      daysLeft: Math.max(0, daysLeft) // Don't show negative days
    };
    
  } catch (error) {
    Logger.log('Error in calculateVoucherStatus: ' + error.toString());
    return {
      status: 'ERROR',
      daysLeft: 0
    };
  }
}

function refreshAllCalculations(spreadsheet) {
  try {
    const vouchersSheet = spreadsheet.getSheetByName('VOUCHERS');
    const usageSheet = spreadsheet.getSheetByName('USAGE');
    
    if (!vouchersSheet) {
      return { success: false, error: 'VOUCHERS sheet not found' };
    }
    
    // Get all voucher data
    const vouchersData = vouchersSheet.getDataRange().getValues();
    const headers = vouchersData[0];
    
    let updatedCount = 0;
    
    // Process each voucher (skip header row)
    for (let i = 1; i < vouchersData.length; i++) {
      const voucherId = vouchersData[i][0];
      const dateIssued = vouchersData[i][3];
      const currentStatus = vouchersData[i][4];
      const currentDaysLeft = vouchersData[i][5];
      
      // Calculate new status and days left
      const calculatedData = calculateVoucherStatus(spreadsheet, voucherId, dateIssued);
      
      // Update only if values have changed
      if (currentStatus !== calculatedData.status || currentDaysLeft !== calculatedData.daysLeft) {
        const rowNumber = i + 1; // Convert to 1-based indexing
        vouchersSheet.getRange(rowNumber, 5).setValue(calculatedData.status); // Status column
        vouchersSheet.getRange(rowNumber, 6).setValue(calculatedData.daysLeft); // Days Left column
        updatedCount++;
      }
    }
    
    return { 
      success: true, 
      message: `Refreshed calculations for ${updatedCount} voucher(s)`,
      updatedCount: updatedCount
    };
    
  } catch (error) {
    Logger.log('Error in refreshAllCalculations: ' + error.toString());
    return { success: false, error: error.toString() };
  }
}

// Helper function to find voucher by ID
function findVoucherById(vouchersData, voucherId) {
  for (let i = 1; i < vouchersData.length; i++) {
    if (vouchersData[i][0] === voucherId) {
      return {
        rowIndex: i,
        data: vouchersData[i]
      };
    }
  }
  return null;
}

// Helper function to validate voucher status
function isVoucherActive(vouchersData, voucherId) {
  const voucher = findVoucherById(vouchersData, voucherId);
  return voucher && voucher.data[4] === 'ACTIVE'; // Status is in column E (index 4)
}

// Function to set up automatic triggers (run this once to set up automation)
function setupAutomaticTriggers() {
  // Delete existing triggers
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => ScriptApp.deleteTrigger(trigger));
  
  // Create time-based trigger to run calculations daily at 6 AM
  ScriptApp.newTrigger('dailyCalculationUpdate')
    .timeBased()
    .everyDays(1)
    .atHour(6)
    .create();
  
  Logger.log('Automatic triggers set up successfully');
}

// Function that runs daily to update all calculations
function dailyCalculationUpdate() {
  try {
    const spreadsheet = SpreadsheetApp.openById('1YYz6hTQCGn0XfNNgJ0k_FpzqfSUWIiQOIBR3g_c4RHc');
    const result = refreshAllCalculations(spreadsheet);
    Logger.log('Daily calculation update completed: ' + JSON.stringify(result));
  } catch (error) {
    Logger.log('Error in daily calculation update: ' + error.toString());
  }
}

// Test function to verify the script works
function testScript() {
  const spreadsheet = SpreadsheetApp.openById('1YYz6hTQCGn0XfNNgJ0k_FpzqfSUWIiQOIBR3g_c4RHc');
  
  // Test automatic calculations
  const refreshResult = refreshAllCalculations(spreadsheet);
  Logger.log('Refresh result: ' + JSON.stringify(refreshResult));
  
  // Test voucher status calculation
  const statusResult = calculateVoucherStatus(spreadsheet, 'TEST001', '2024-01-15');
  Logger.log('Status calculation result: ' + JSON.stringify(statusResult));
}

// Function to manually trigger calculation refresh (can be called from web app)
function manualRefresh() {
  const spreadsheet = SpreadsheetApp.openById('1YYz6hTQCGn0XfNNgJ0k_FpzqfSUWIiQOIBR3g_c4RHc');
  return refreshAllCalculations(spreadsheet);
}
