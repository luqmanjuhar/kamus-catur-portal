<script>
    // Global variables
    let vouchersData = [];
    let usageData = [];
    let filteredVouchers = [];
    let currentPage = 1;
    const recordsPerPage = 10;
    let selectedVouchers = [];
    let isAdminAuthenticated = false;

    // URLs for Google Sheets
    const VOUCHERS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZ5cuf5grWyzDNcioLXA6OqeGTC4cBLkqW4sJHviXCK1FI2E4BY3YWPlicYd8DonlD5uIEFGfoEivl/pub?gid=0&single=true&output=csv';
    const USAGE_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZ5cuf5grWyzDNcioLXA6OqeGTC4cBLkqW4sJHviXCK1FI2E4BY3YWPlicYd8DonlD5uIEFGfoEivl/pub?gid=1706713915&single=true&output=csv';
    
    // Google Apps Script URL for real-time updates and photo uploads
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzKagwZ3z67ZGjAxcejbvoKNtEcOXGIcCTJWPDlVo5CT0AdHt7Re6kjBjwchl5m-zLm/exec';
    
    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
        showSection('dashboard');
        loadData();
        
        // Set today's date as default for redemption
        document.getElementById('redeemDate').valueAsDate = new Date();
        
        // Add Enter key support for voucher validation
        document.getElementById('voucherIdInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                validateVouchers();
            }
        });

        // Add Enter key support for admin password
        document.getElementById('adminPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                authenticateAdmin();
            }
        });

        // Add file input change listeners for photo preview
        document.getElementById('photoUpload').addEventListener('change', function(e) {
            previewPhotos(e.target.files, 'photoPreview');
        });

        document.getElementById('updatePhotoUpload').addEventListener('change', function(e) {
            previewPhotos(e.target.files, 'updatePhotoPreview');
        });
    });

    // Photo preview function
    function previewPhotos(files, previewContainerId) {
        const container = document.getElementById(previewContainerId);
        container.innerHTML = '';
        
        if (files.length === 0) {
            container.classList.add('hidden');
            return;
        }
        
        container.classList.remove('hidden');
        
        Array.from(files).forEach((file, index) => {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'photo-preview border border-gray-300';
                    img.title = file.name;
                    container.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        });
    }

    // Navigation functions
    function showSection(sectionName) {
        document.querySelectorAll('.section').forEach(section => section.classList.add('hidden'));
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        
        const sectionEl = document.getElementById(sectionName + '-section');
        sectionEl.classList.remove('hidden');
        sectionEl.classList.add('fade-in');
        
        document.getElementById(sectionName + '-tab').classList.add('active');
        
        if (sectionName === 'redeem') {
            resetRedemption();
        } else if (sectionName === 'update') {
            resetAdminAuth();
        }
    }

    // Admin authentication functions
    function authenticateAdmin() {
        const password = document.getElementById('adminPassword').value;
        const correctPassword = 'kamuscatur'; // Your password
        
        if (password === correctPassword) {
            isAdminAuthenticated = true;
            document.getElementById('adminAuthSection').classList.add('hidden');
            document.getElementById('updateFormContainer').classList.remove('hidden');
            document.getElementById('adminPassword').value = '';
            showMessage('Admin access granted! You can now update vouchers.', 'success');
        } else {
            showMessage('Incorrect password. Access denied.', 'error');
            document.getElementById('adminPassword').value = '';
        }
    }

    function resetAdminAuth() {
        isAdminAuthenticated = false;
        document.getElementById('adminAuthSection').classList.remove('hidden');
        document.getElementById('updateFormContainer').classList.add('hidden');
        document.getElementById('adminPassword').value = '';
        clearUpdateForm();
    }
    
    // Load existing voucher details into the 'Update' form
    function loadVoucherDetails() {
        const voucherId = document.getElementById('updateVoucherId').value.trim().toUpperCase();
        if (!voucherId) return;

        const voucher = vouchersData.find(v => v['Voucher ID'].toUpperCase() === voucherId);
        
        if (!voucher) {
            showMessage('Voucher not found. You can create a new voucher with this ID.', 'info');
            // Clear form except voucher ID
            document.getElementById('updateValue').value = '';
            document.getElementById('updateDescription').value = '';
            document.getElementById('updateDateIssued').value = '';
            document.getElementById('updateStatus').value = '';
            document.getElementById('updateDaysLeft').value = '';
            hideUsageDetails();
            return;
        }
        
        // Auto-fill voucher data
        document.getElementById('updateVoucherId').value = voucher['Voucher ID'];
        document.getElementById('updateValue').value = parseFloat(voucher['Value (RM)'] || 0);
        document.getElementById('updateDescription').value = voucher.Description || '';
        
        const dateIssued = voucher['Date Issued'] || '';
        if (dateIssued && dateIssued.includes('/')) {
            const [day, month, year] = dateIssued.split('/');
            document.getElementById('updateDateIssued').value = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        } else {
            document.getElementById('updateDateIssued').value = dateIssued;
        }
        
        document.getElementById('updateStatus').value = voucher.Status || '';
        document.getElementById('updateDaysLeft').value = parseInt(voucher['Days Left'] || 0);
        
        loadUsageDetails(voucherId);
        showMessage('Voucher details loaded successfully!', 'success');
    }

    // Load usage details for a specific voucher in the 'Update' form
    function loadUsageDetails(voucherId) {
        const usageRecord = usageData.find(usage => usage['Voucher ID'].toUpperCase() === voucherId.toUpperCase());
        const usageSection = document.getElementById('usageDetailsSection');
        
        if (usageRecord) {
            usageSection.classList.remove('hidden');
            document.getElementById('updateUsageCategory').value = usageRecord['Usage Category'] || '';
            document.getElementById('updateCustomerName').value = usageRecord['Customer Name'] || '';
            document.getElementById('updateRedemptionDate').value = usageRecord['Date Redeemed'] || '';
            document.getElementById('updateUsageDetails').value = usageRecord['Details'] || '';
            document.getElementById('updatePhotos').value = usageRecord['Photos'] || '';
            updateUsageDetailsPlaceholderInUpdate();
        } else {
            hideUsageDetails();
        }
    }

    function hideUsageDetails() {
        const usageSection = document.getElementById('usageDetailsSection');
        usageSection.classList.add('hidden');
        // Clear usage form fields
        document.getElementById('updateUsageCategory').value = '';
        document.getElementById('updateCustomerName').value = '';
        document.getElementById('updateRedemptionDate').value = '';
        document.getElementById('updateUsageDetails').value = '';
        document.getElementById('updatePhotos').value = '';
    }
    
    // Update placeholder text in the update form based on category
    function updateUsageDetailsPlaceholderInUpdate() {
        updateUsageDetailsPlaceholder('updateUsageCategory', 'updateUsageDetails');
    }

    // Data loading and parsing functions
    async function loadData() {
        showLoading(true);
        try {
            await Promise.all([loadVouchers(), loadUsage()]);
            displayVouchers();
        } catch (error) {
            showMessage('Error loading data: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    }

    async function loadVouchers() {
        const response = await fetch(VOUCHERS_URL + '&_cache=' + new Date().getTime());
        const csvText = await response.text();
        vouchersData = parseCSV(csvText);
        filteredVouchers = [...vouchersData];
    }

    async function loadUsage() {
        const response = await fetch(USAGE_URL + '&_cache=' + new Date().getTime());
        const csvText = await response.text();
        usageData = parseCSV(csvText);
    }

    function parseCSV(csvText) {
        const lines = csvText.trim().split('\n');
        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        return lines.slice(1).map(line => {
            const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
            let row = {};
            headers.forEach((header, index) => {
                row[header] = values[index] || '';
            });
            return row;
        });
    }

    // Dashboard table display functions
    function displayVouchers() {
        const tbody = document.getElementById('vouchersTableBody');
        const startIndex = (currentPage - 1) * recordsPerPage;
        const endIndex = startIndex + recordsPerPage;
        const pageVouchers = filteredVouchers.slice(startIndex, endIndex);
        
        tbody.innerHTML = '';
        
        pageVouchers.forEach(voucher => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            
            const usageRecord = usageData.find(usage => usage['Voucher ID'] === voucher['Voucher ID']);
            const usageDetailsHTML = usageRecord ? `
                <div class="text-sm">
                    <div class="font-medium text-gray-900">${usageRecord['Customer Name'] || 'N/A'}</div>
                    <div class="text-gray-600">${usageRecord['Usage Category'] || 'N/A'}</div>
                    <div class="text-gray-500 text-xs">${usageRecord['Details'] || 'No details'}</div>
                </div>` : '<span class="text-gray-400 text-sm">Not used</span>';

            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${voucher['Voucher ID']}</td>
                <td class="px-6 py-4 text-sm text-gray-900">${voucher.Description}</td>
                <td class="px-6 py-4 text-sm text-gray-900">
                    <div class="space-y-1">
                        <div class="font-medium">${voucher['Date Issued']}</div>
                        <div class="text-orange-600 font-semibold">RM ${parseFloat(voucher['Value (RM)'] || 0).toFixed(2)}</div>
                        <div class="text-gray-500 text-xs">${voucher['Days Left']} days left</div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusClass(voucher.Status)}">${voucher.Status}</span>
                </td>
                <td class="px-6 py-4 text-sm">${usageDetailsHTML}</td>
            `;
            tbody.appendChild(row);
        });
        updatePaginationInfo();
    }

    function getStatusClass(status) {
        switch (status) {
            case 'ACTIVE': return 'bg-green-100 text-green-800';
            case 'REDEEMED': return 'bg-blue-100 text-blue-800';
            case 'EXPIRED': return 'bg-red-100 text-red-800';
            default: return 'bg-gray-100 text-gray-800';
        }
    }

    function applyFilters() {
        const statusFilter = document.getElementById('statusFilter').value;
        const voucherIdFilter = document.getElementById('valueFilter').value.trim().toLowerCase();
        const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
        
        filteredVouchers = vouchersData.filter(voucher => {
            return (!statusFilter || voucher.Status === statusFilter) &&
                   (!voucherIdFilter || voucher['Voucher ID'].toLowerCase().includes(voucherIdFilter)) &&
                   (!searchFilter || voucher.Description.toLowerCase().includes(searchFilter));
        });
        
        currentPage = 1;
        displayVouchers();
    }

    // Pagination functions
    function updatePaginationInfo() {
        const totalRecords = filteredVouchers.length;
        const totalPages = Math.ceil(totalRecords / recordsPerPage) || 1;
        const startIndex = totalRecords > 0 ? (currentPage - 1) * recordsPerPage + 1 : 0;
        const endIndex = Math.min(currentPage * recordsPerPage, totalRecords);
        
        document.getElementById('showingStart').textContent = startIndex;
        document.getElementById('showingEnd').textContent = endIndex;
        document.getElementById('totalRecords').textContent = totalRecords;
        document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
        
        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = currentPage === totalPages;
    }

    function previousPage() {
        if (currentPage > 1) {
            currentPage--;
            displayVouchers();
        }
    }

    function nextPage() {
        const totalPages = Math.ceil(filteredVouchers.length / recordsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            displayVouchers();
        }
    }

    // Update Voucher Form submission
    document.getElementById('updateForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // This is a simplified version. A complete version would also handle photo uploads for updates.
        const payload = {
            action: 'updateVoucher',
            voucherId: document.getElementById('updateVoucherId').value,
            value: document.getElementById('updateValue').value,
            description: document.getElementById('updateDescription').value,
            dateIssued: document.getElementById('updateDateIssued').value
        };

        showLoading(true);
        try {
            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(payload), // Send as JSON
                headers: { 'Content-Type': 'application/json' }
            });
            const result = await response.json();
            
            if (result.success) {
                showMessage(`Voucher updated successfully! Status: ${result.calculatedStatus}`, 'success');
                clearUpdateForm();
                setTimeout(loadData, 1000); // Reload data after a short delay
            } else {
                showMessage('Error updating voucher: ' + (result.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            showMessage('Connection error during update.', 'error');
        } finally {
            showLoading(false);
        }
    });

    function clearUpdateForm() {
        document.getElementById('updateForm').reset();
        hideUsageDetails();
        document.getElementById('updatePhotoPreview').innerHTML = '';
        document.getElementById('updatePhotoPreview').classList.add('hidden');
    }

    // --- REDEEM VOUCHER FUNCTIONS ---

    // Step 1: Validate entered voucher IDs
    function validateVouchers() {
        const voucherInput = document.getElementById('voucherIdInput').value;
        if (!voucherInput) return;

        const voucherIds = voucherInput.split(',').map(id => id.trim().toUpperCase()).filter(Boolean);
        let validVouchers = [];
        let invalidMessages = { notFound: [], notActive: [], alreadySelected: [] };

        voucherIds.forEach(id => {
            if (selectedVouchers.some(v => v['Voucher ID'].toUpperCase() === id)) {
                invalidMessages.alreadySelected.push(id);
                return;
            }
            const voucher = vouchersData.find(v => v['Voucher ID'].toUpperCase() === id);
            if (voucher && voucher.Status === 'ACTIVE') {
                validVouchers.push(voucher);
            } else if (voucher) {
                invalidMessages.notActive.push(`${id} (${voucher.Status})`);
            } else {
                invalidMessages.notFound.push(id);
            }
        });

        displayValidationResult(validVouchers, invalidMessages);
        document.getElementById('voucherIdInput').value = '';
    }
    
    // Step 2: Display validation results and add valid vouchers to selection
    function displayValidationResult(validVouchers, invalidMessages) {
        let messages = [];
        if (validVouchers.length > 0) {
            selectedVouchers.push(...validVouchers);
            messages.push({ text: `Added ${validVouchers.length} valid voucher(s) to redemption list.`, type: 'success' });
        }
        if (invalidMessages.notFound.length > 0) {
            messages.push({ text: `Not Found: ${invalidMessages.notFound.join(', ')}`, type: 'error' });
        }
        if (invalidMessages.notActive.length > 0) {
            messages.push({ text: `Not Active: ${invalidMessages.notActive.join(', ')}`, type: 'error' });
        }
        if (invalidMessages.alreadySelected.length > 0) {
            messages.push({ text: `Already Selected: ${invalidMessages.alreadySelected.join(', ')}`, type: 'info' });
        }
        
        messages.forEach(msg => showMessage(msg.text, msg.type));
        
        if (selectedVouchers.length > 0) {
            updateSelectedVouchersUI();
            document.getElementById('selectedVouchersSection').classList.remove('hidden');
            document.getElementById('redemptionFormSection').classList.remove('hidden');
        }
    }
    
    // Update the UI showing the list of vouchers to be redeemed
    function updateSelectedVouchersUI() {
        const container = document.getElementById('selectedVouchers');
        container.innerHTML = '';
        let totalValue = 0;
        
        selectedVouchers.forEach(voucher => {
            const value = parseFloat(voucher['Value (RM)'] || 0);
            totalValue += value;
            
            const item = document.createElement('div');
            item.className = 'flex justify-between items-center p-3 bg-orange-50 rounded-lg';
            item.innerHTML = `
                <div>
                    <span class="font-medium">${voucher['Voucher ID']}</span>
                    <span class="text-sm text-gray-600 ml-2">${voucher.Description}</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="font-semibold text-orange-600">RM ${value.toFixed(2)}</span>
                    <button type="button" onclick="removeVoucher('${voucher['Voucher ID']}')" class="text-red-500 hover:text-red-700">🗑️</button>
                </div>
            `;
            container.appendChild(item);
        });
        
        document.getElementById('totalValue').textContent = totalValue.toFixed(2);
    }
    
    function removeVoucher(voucherId) {
        selectedVouchers = selectedVouchers.filter(v => v['Voucher ID'] !== voucherId);
        updateSelectedVouchersUI();
        if (selectedVouchers.length === 0) {
            document.getElementById('selectedVouchersSection').classList.add('hidden');
            document.getElementById('redemptionFormSection').classList.add('hidden');
        }
    }
    
    // Step 3: Handle the final redemption form submission
    document.getElementById('redeemForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (selectedVouchers.length === 0) {
            showMessage('Please add at least one valid voucher to redeem.', 'error');
            return;
        }

        const fileInput = document.getElementById('photoUpload');
        const file = fileInput.files[0]; // We'll handle the first selected file

        // If a file is selected, read it first. Otherwise, submit without it.
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                // This function is called once the file is loaded into memory
                const fileData = event.target.result; // This is the Base64 encoded string
                submitRedemptionData(fileData, file.name, file.type);
            };
            reader.readAsDataURL(file); // Start reading the file
        } else {
            // No file selected, submit form data immediately
            submitRedemptionData(null, null, null);
        }
    });

    async function submitRedemptionData(fileData, fileName, mimeType) {
        showLoading(true);
        
        // Prepare the data payload to send to Google Apps Script
        const payload = {
            action: 'redeemAndUpload', // This action must match your Apps Script
            vouchers: JSON.stringify(selectedVouchers.map(v => ({ voucherId: v['Voucher ID'] }))),
            redemptionDate: document.getElementById('redeemDate').value,
            usageCategory: document.getElementById('usageCategory').value,
            usageDetails: document.getElementById('usageDetails').value,
            customerName: document.getElementById('customerName').value,
            // Include file data only if it exists
            fileData: fileData || '',
            fileName: fileName || '',
            mimeType: mimeType || ''
        };
        
        try {
            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(payload),
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            const result = await response.json();
            
            if (result.success) {
                showRedemptionSuccessMessage();
                resetRedemption();
                setTimeout(loadData, 1000); // Reload data after a short delay
            } else {
                showMessage('Error redeeming vouchers: ' + (result.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            showMessage('Connection error. Please check your network and try again.', 'error');
        } finally {
            showLoading(false);
        }
    }

    // Reset the entire redemption process
    function resetRedemption() {
        selectedVouchers = [];
        document.getElementById('voucherIdInput').value = '';
        document.getElementById('validationResultSection').classList.add('hidden');
        document.getElementById('selectedVouchersSection').classList.add('hidden');
        document.getElementById('redemptionFormSection').classList.add('hidden');
        document.getElementById('redeemForm').reset();
        document.getElementById('redeemDate').valueAsDate = new Date();
        updateSelectedVouchersUI();
        document.getElementById('photoPreview').innerHTML = '';
        document.getElementById('photoPreview').classList.add('hidden');
    }

    // Update usage details placeholder based on selected category
    function updateUsageDetailsPlaceholder(categoryId = 'usageCategory', detailsId = 'usageDetails') {
        const category = document.getElementById(categoryId).value;
        const usageDetails = document.getElementById(detailsId);
        
        switch(category) {
            case 'Chess Class':
                usageDetails.placeholder = "e.g., 'Peribadi / Ogos – Coach Luqman' or 'Centre Pagi / April – Coach Marlia'";
                break;
            case 'Tournament Name':
                usageDetails.placeholder = "e.g., 'Battle of Duo (Under 17) – 2nd Series'";
                break;
            case 'Product Purchase':
                usageDetails.placeholder = "Describe the product purchased...";
                break;
            default:
                usageDetails.placeholder = "Select a category above to see specific examples...";
        }
    }
    
    // --- WHATSAPP & MESSAGING FUNCTIONS ---
    
    // The separate upload button is no longer needed, so this function is removed or can be left empty.
    function uploadPhotos() {
        showMessage('Please select a photo and click "Complete Redemption" to upload.', 'info');
    }

    function showRedemptionSuccessMessage() {
        const totalVouchers = selectedVouchers.length;
        const customerName = document.getElementById('customerName').value;
        showMessage(`✅ Redemption Successful! ${totalVouchers} voucher(s) redeemed for ${customerName}.`, 'success');
        // You can add the WhatsApp button back here if needed
    }

    // Utility functions
    function showLoading(show) {
        const overlay = document.getElementById('loadingOverlay');
        overlay.style.display = show ? 'flex' : 'none';
    }

    function showMessage(message, type = 'info') {
        const container = document.getElementById('messageContainer');
        const messageDiv = document.createElement('div');
        
        const typeClasses = {
            success: 'bg-green-500',
            error: 'bg-red-500',
            info: 'bg-blue-500'
        };
        
        messageDiv.className = `${typeClasses[type]} text-white px-6 py-3 rounded-lg shadow-lg mb-2 fade-in`;
        messageDiv.innerHTML = `
            <div class="flex justify-between items-center">
                <span>${message}</span>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-4 font-bold text-white hover:text-gray-200">✕</button>
            </div>
        `;
        container.appendChild(messageDiv);
        
        setTimeout(() => {
            if (messageDiv.parentElement) messageDiv.remove();
        }, 6000);
    }
</script>
