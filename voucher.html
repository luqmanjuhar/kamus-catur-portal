<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voucher Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .orange-gradient {
            background: linear-gradient(135deg, #ff7849 0%, #ff9500 100%);
        }
        .loading {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ff7849;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-orange-50 min-h-full">
    <!-- Header -->
    <header class="orange-gradient text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold">Voucher Management System</h1>

            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white shadow-md">
        <div class="container mx-auto px-4">
            <div class="flex justify-center space-x-8">
                <button onclick="showSection('redeem')" id="redeemTab" class="py-4 px-6 text-orange-600 border-b-2 border-orange-600 font-semibold">
                    Redeem Voucher
                </button>
                <button onclick="showSection('dashboard')" id="dashboardTab" class="py-4 px-6 text-gray-600 hover:text-orange-600 font-semibold">
                    Voucher Dashboard
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Redeem Voucher Section -->
        <div id="redeemSection" class="fade-in">
            <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Redeem Your Vouchers</h2>
                
                <!-- Voucher Input -->
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">Voucher IDs (separate multiple with commas)</label>
                    <input type="text" id="voucherIds" placeholder="e.g., KC001, KC002, KC003" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 uppercase">
                    <p class="text-sm text-gray-500 mt-1">Enter voucher IDs in UPPERCASE, separated by commas</p>
                </div>

                <!-- Validate Button -->
                <button onclick="validateVouchers()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 px-6 rounded-lg mb-6 transition duration-200">
                    <span id="validateText">Validate Vouchers</span>
                    <div id="validateLoading" class="loading mx-auto hidden"></div>
                </button>

                <!-- Validation Results -->
                <div id="validationResults" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-semibold text-gray-800 mb-2">Validation Results:</h3>
                    <div id="validVouchers" class="mb-2"></div>
                    <div id="invalidVouchers" class="mb-2"></div>
                    <div id="totalValue" class="text-xl font-bold text-green-600"></div>
                </div>

                <!-- Redemption Form -->
                <div id="redemptionForm" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Usage Category</label>
                            <select id="usageCategory" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                <option value="">Select Category</option>
                                <option value="Chess Class">Chess Class</option>
                                <option value="Tournament Name">Tournament Name</option>
                                <option value="Product Purchase">Product Purchase</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Customer Name</label>
                            <input type="text" id="customerName" placeholder="e.g., Luqman (Aryan)" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-2">Details</label>
                        <textarea id="details" rows="3" placeholder="Enter details based on category selected"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"></textarea>
                        <p class="text-sm text-gray-500 mt-1">
                            Chess Class: e.g., Peribadi/Ogos - Coach Luqman<br>
                            Tournament: e.g., Battle of Duo (Under 17) - 2nd Series
                        </p>
                    </div>

                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-2">Upload Photo</label>
                        <input type="file" id="photoUpload" accept="image/*" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                        <p class="text-sm text-gray-500 mt-1">Photo will be renamed to: Customer Name - Date Redeemed</p>
                    </div>

                    <button onclick="redeemVouchers()" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                        <span id="redeemText">Redeem Vouchers</span>
                        <div id="redeemLoading" class="loading mx-auto hidden"></div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Voucher Dashboard</h2>
                
                <!-- Filters -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Status Filter</label>
                        <select id="statusFilter" onchange="applyFilters()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                            <option value="">All Status</option>
                            <option value="ACTIVE">Active</option>
                            <option value="REDEEMED">Redeemed</option>
                            <option value="EXPIRED">Expired</option>
                            <option value="NOT ISSUE">Not Issued</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Value Range</label>
                        <select id="valueFilter" onchange="applyFilters()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                            <option value="">All Values</option>
                            <option value="0-50">RM 0 - 50</option>
                            <option value="51-100">RM 51 - 100</option>
                            <option value="101-200">RM 101 - 200</option>
                            <option value="201+">RM 201+</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Search Voucher ID</label>
                        <input type="text" id="searchFilter" onkeyup="applyFilters()" placeholder="Search by ID..." 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div class="flex items-end">
                        <button onclick="loadVouchers()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                            Refresh Data
                        </button>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="dashboardLoading" class="text-center py-8">
                    <div class="loading mx-auto mb-4"></div>
                    <p class="text-gray-600">Loading vouchers...</p>
                </div>

                <!-- Vouchers Table -->
                <div id="vouchersTable" class="hidden overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300">
                        <thead>
                            <tr class="bg-orange-100">
                                <th class="border border-gray-300 px-4 py-2 text-left">Voucher ID</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">Value (RM)</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">Description</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">Date Issued</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">Status</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">Days Left</th>
                            </tr>
                        </thead>
                        <tbody id="vouchersTableBody">
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div id="pagination" class="hidden flex justify-between items-center mt-6">
                    <div class="text-gray-600">
                        Showing <span id="showingStart">1</span> to <span id="showingEnd">10</span> of <span id="totalRecords">0</span> records
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="previousPage()" id="prevBtn" class="px-4 py-2 bg-gray-300 text-gray-600 rounded-lg hover:bg-gray-400 transition duration-200">
                            Previous
                        </button>
                        <span id="pageInfo" class="px-4 py-2 bg-orange-100 text-orange-800 rounded-lg font-semibold">
                            Page 1
                        </span>
                        <button onclick="nextPage()" id="nextBtn" class="px-4 py-2 bg-gray-300 text-gray-600 rounded-lg hover:bg-gray-400 transition duration-200">
                            Next
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>



    <!-- Success Modal -->
    <div id="successModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md mx-4">
            <div class="text-center">
                <div class="text-green-500 text-6xl mb-4">✓</div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Success!</h3>
                <p id="successMessage" class="text-gray-600 mb-6"></p>
                <button onclick="closeModal()" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-6 rounded-lg transition duration-200">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let allVouchers = [];
        let filteredVouchers = [];
        let usageData = [];
        let currentPage = 1;
        const recordsPerPage = 10;
        let validatedVouchers = [];

        // Configuration
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxsTH34UKNqibhLo8r9R13rq1yqxZohMsSdX5NLg2vMwxR-0t-djBHyrOlCvHROsWg3tQ/exec';
        const DEMO_MODE = false;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadVouchers();
        });

        // Navigation functions
        function showSection(section) {
            document.getElementById('redeemSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('redeemTab').classList.remove('border-b-2', 'border-orange-600', 'text-orange-600');
            document.getElementById('dashboardTab').classList.remove('border-b-2', 'border-orange-600', 'text-orange-600');
            document.getElementById('redeemTab').classList.add('text-gray-600');
            document.getElementById('dashboardTab').classList.add('text-gray-600');

            if (section === 'redeem') {
                document.getElementById('redeemSection').classList.remove('hidden');
                document.getElementById('redeemTab').classList.add('border-b-2', 'border-orange-600', 'text-orange-600');
                document.getElementById('redeemTab').classList.remove('text-gray-600');
            } else {
                document.getElementById('dashboardSection').classList.remove('hidden');
                document.getElementById('dashboardTab').classList.add('border-b-2', 'border-orange-600', 'text-orange-600');
                document.getElementById('dashboardTab').classList.remove('text-gray-600');
                loadVouchers();
            }
        }

        // Load vouchers from Google Sheets
        async function loadVouchers() {
            try {
                document.getElementById('dashboardLoading').classList.remove('hidden');
                document.getElementById('vouchersTable').classList.add('hidden');
                document.getElementById('pagination').classList.add('hidden');

                // Load vouchers data
                const vouchersResponse = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vRZ5cuf5grWyzDNcioLXA6OqeGTC4cBLkqW4sJHviXCK1FI2E4BY3YWPlicYd8DonlD5uIEFGfoEivl/pub?gid=0&single=true&output=csv');
                const vouchersText = await vouchersResponse.text();
                
                // Load usage data
                const usageResponse = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vRZ5cuf5grWyzDNcioLXA6OqeGTC4cBLkqW4sJHviXCK1FI2E4BY3YWPlicYd8DonlD5uIEFGfoEivl/pub?gid=1706713915&single=true&output=csv');
                const usageText = await usageResponse.text();

                allVouchers = parseCSV(vouchersText);
                usageData = parseCSV(usageText);
                
                // Process vouchers with status calculation
                allVouchers = allVouchers.map(voucher => processVoucherStatus(voucher));
                
                filteredVouchers = [...allVouchers];
                currentPage = 1;
                displayVouchers();
                
                document.getElementById('dashboardLoading').classList.add('hidden');
                document.getElementById('vouchersTable').classList.remove('hidden');
                document.getElementById('pagination').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('dashboardLoading').innerHTML = '<p class="text-red-600">Error loading data. Please check your internet connection.</p>';
            }
        }

        // Parse CSV data
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                data.push(row);
            }
            return data;
        }

        // Process voucher status based on business rules
        function processVoucherStatus(voucher) {
            const dateIssued = voucher['Date Issued'];
            const voucherId = voucher['Voucher ID'];
            
            // Check if voucher is redeemed
            const isRedeemed = usageData.some(usage => usage['Voucher ID'] && usage['Voucher ID'].includes(voucherId));
            
            if (isRedeemed) {
                voucher.Status = 'REDEEMED';
                voucher['Days Left'] = 'N/A';
            } else if (!dateIssued || dateIssued === '') {
                voucher.Status = 'NOT ISSUE';
                voucher['Days Left'] = 'N/A';
            } else {
                const issued = new Date(dateIssued);
                const now = new Date();
                const daysDiff = Math.ceil((now - issued) / (1000 * 60 * 60 * 24));
                
                if (daysDiff > 90) {
                    voucher.Status = 'EXPIRED';
                    voucher['Days Left'] = 'Expired';
                } else {
                    voucher.Status = 'ACTIVE';
                    voucher['Days Left'] = Math.max(0, 90 - daysDiff);
                }
            }
            
            return voucher;
        }

        // Display vouchers in table
        function displayVouchers() {
            const tbody = document.getElementById('vouchersTableBody');
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;
            const pageVouchers = filteredVouchers.slice(startIndex, endIndex);
            
            tbody.innerHTML = '';
            
            pageVouchers.forEach(voucher => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const statusClass = {
                    'ACTIVE': 'bg-green-100 text-green-800',
                    'REDEEMED': 'bg-blue-100 text-blue-800',
                    'EXPIRED': 'bg-red-100 text-red-800',
                    'NOT ISSUE': 'bg-gray-100 text-gray-800'
                };
                
                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-2 font-semibold">${voucher['Voucher ID']}</td>
                    <td class="border border-gray-300 px-4 py-2">RM ${voucher['Value (RM)']}</td>
                    <td class="border border-gray-300 px-4 py-2">${voucher['Description']}</td>
                    <td class="border border-gray-300 px-4 py-2">${voucher['Date Issued']}</td>
                    <td class="border border-gray-300 px-4 py-2">
                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusClass[voucher.Status] || 'bg-gray-100 text-gray-800'}">
                            ${voucher.Status}
                        </span>
                    </td>
                    <td class="border border-gray-300 px-4 py-2">${voucher['Days Left']}</td>
                `;
                tbody.appendChild(row);
            });
            
            updatePagination();
        }

        // Update pagination controls
        function updatePagination() {
            const totalPages = Math.ceil(filteredVouchers.length / recordsPerPage);
            const startRecord = (currentPage - 1) * recordsPerPage + 1;
            const endRecord = Math.min(currentPage * recordsPerPage, filteredVouchers.length);
            
            document.getElementById('showingStart').textContent = startRecord;
            document.getElementById('showingEnd').textContent = endRecord;
            document.getElementById('totalRecords').textContent = filteredVouchers.length;
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;
            
            if (currentPage === 1) {
                document.getElementById('prevBtn').classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                document.getElementById('prevBtn').classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            if (currentPage === totalPages) {
                document.getElementById('nextBtn').classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                document.getElementById('nextBtn').classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // Pagination functions
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                displayVouchers();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredVouchers.length / recordsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                displayVouchers();
            }
        }

        // Apply filters
        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const valueFilter = document.getElementById('valueFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
            
            filteredVouchers = allVouchers.filter(voucher => {
                let matches = true;
                
                // Status filter
                if (statusFilter && voucher.Status !== statusFilter) {
                    matches = false;
                }
                
                // Value filter
                if (valueFilter) {
                    const value = parseFloat(voucher['Value (RM)']) || 0;
                    switch (valueFilter) {
                        case '0-50':
                            if (value > 50) matches = false;
                            break;
                        case '51-100':
                            if (value < 51 || value > 100) matches = false;
                            break;
                        case '101-200':
                            if (value < 101 || value > 200) matches = false;
                            break;
                        case '201+':
                            if (value < 201) matches = false;
                            break;
                    }
                }
                
                // Search filter
                if (searchFilter && !voucher['Voucher ID'].toLowerCase().includes(searchFilter)) {
                    matches = false;
                }
                
                return matches;
            });
            
            currentPage = 1;
            displayVouchers();
        }

        // Validate vouchers
        async function validateVouchers() {
            const input = document.getElementById('voucherIds').value.trim().toUpperCase();
            if (!input) {
                alert('Please enter voucher IDs');
                return;
            }
            
            document.getElementById('validateText').classList.add('hidden');
            document.getElementById('validateLoading').classList.remove('hidden');
            
            // Ensure data is loaded
            if (allVouchers.length === 0) {
                await loadVouchers();
            }
            
            const voucherIds = input.split(',').map(id => id.trim()).filter(id => id);
            const validVouchers = [];
            const invalidVouchers = [];
            let totalValue = 0;
            
            voucherIds.forEach(id => {
                const voucher = allVouchers.find(v => v['Voucher ID'] === id);
                if (voucher && voucher.Status === 'ACTIVE') {
                    validVouchers.push(voucher);
                    totalValue += parseFloat(voucher['Value (RM)']) || 0;
                } else {
                    invalidVouchers.push(id);
                }
            });
            
            // Display results
            document.getElementById('validVouchers').innerHTML = validVouchers.length > 0 
                ? `<p class="text-green-600"><strong>Valid Vouchers:</strong> ${validVouchers.map(v => v['Voucher ID']).join(', ')}</p>`
                : '';
            
            document.getElementById('invalidVouchers').innerHTML = invalidVouchers.length > 0 
                ? `<p class="text-red-600"><strong>Invalid/Inactive Vouchers:</strong> ${invalidVouchers.join(', ')}</p>`
                : '';
            
            document.getElementById('totalValue').innerHTML = validVouchers.length > 0 
                ? `<strong>Total Value: RM ${totalValue.toFixed(2)}</strong>`
                : '';
            
            document.getElementById('validationResults').classList.remove('hidden');
            
            if (validVouchers.length > 0) {
                validatedVouchers = validVouchers;
                document.getElementById('redemptionForm').classList.remove('hidden');
            } else {
                document.getElementById('redemptionForm').classList.add('hidden');
            }
            
            document.getElementById('validateText').classList.remove('hidden');
            document.getElementById('validateLoading').classList.add('hidden');
        }

        // Redeem vouchers - Using JSONP to avoid CORS issues
        async function redeemVouchers() {
            const usageCategory = document.getElementById('usageCategory').value;
            const customerName = document.getElementById('customerName').value;
            const details = document.getElementById('details').value;
            const photoFile = document.getElementById('photoUpload').files[0];
            
            if (!usageCategory || !customerName || !details) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            if (!photoFile) {
                showNotification('Please upload a photo', 'error');
                return;
            }
            
            document.getElementById('redeemText').classList.add('hidden');
            document.getElementById('redeemLoading').classList.remove('hidden');
            
            try {
                const currentDate = new Date().toISOString().split('T')[0];
                const currentDateTime = new Date().toLocaleString();
                
                // Convert photo to base64 for upload
                const photoBase64 = await fileToBase64(photoFile);
                const photoName = `${customerName} - ${currentDate}`;
                
                // Prepare data for all voucher redemptions
                const redemptionData = {
                    action: 'redeemVouchers',
                    voucherIds: validatedVouchers.map(v => v['Voucher ID']).join(','),
                    dateRedeemed: currentDateTime,
                    usageCategory: usageCategory,
                    details: details,
                    customerName: customerName,
                    photoName: photoName,
                    photoData: photoBase64,
                    photoType: photoFile.type
                };
                
                // Use JSONP approach to avoid CORS
                const success = await submitToGoogleSheets(redemptionData);
                
                if (success) {
                    const totalValue = validatedVouchers.reduce((sum, v) => sum + (parseFloat(v['Value (RM)']) || 0), 0);
                    
                    document.getElementById('successMessage').textContent = 
                        `Successfully redeemed ${validatedVouchers.length} voucher(s) for ${customerName}. Total value: RM ${totalValue.toFixed(2)}`;
                    
                    document.getElementById('successModal').classList.remove('hidden');
                    
                    // Reset form
                    resetRedemptionForm();
                    
                    // Refresh voucher data after a short delay
                    setTimeout(() => {
                        loadVouchers();
                    }, 2000);
                } else {
                    throw new Error('Failed to submit redemption data');
                }
                
            } catch (error) {
                console.error('Redemption error:', error);
                showNotification('Error redeeming vouchers. Please try again.', 'error');
            } finally {
                document.getElementById('redeemText').classList.remove('hidden');
                document.getElementById('redeemLoading').classList.add('hidden');
            }
        }
        
        // Submit to Google Sheets using form submission method
        function submitToGoogleSheets(data) {
            return new Promise((resolve) => {
                // Create a hidden form
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = GOOGLE_APPS_SCRIPT_URL;
                form.target = 'hidden_iframe';
                form.style.display = 'none';
                
                // Add form fields
                Object.keys(data).forEach(key => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = data[key];
                    form.appendChild(input);
                });
                
                // Create hidden iframe for form submission
                const iframe = document.createElement('iframe');
                iframe.name = 'hidden_iframe';
                iframe.style.display = 'none';
                
                // Handle iframe load event
                iframe.onload = function() {
                    // Clean up
                    document.body.removeChild(form);
                    document.body.removeChild(iframe);
                    resolve(true);
                };
                
                // Add to DOM and submit
                document.body.appendChild(iframe);
                document.body.appendChild(form);
                form.submit();
                
                // Fallback timeout
                setTimeout(() => {
                    try {
                        if (document.body.contains(form)) document.body.removeChild(form);
                        if (document.body.contains(iframe)) document.body.removeChild(iframe);
                    } catch (e) {}
                    resolve(true);
                }, 5000);
            });
        }
        
        // Helper function to convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }
        
        // Reset redemption form
        function resetRedemptionForm() {
            document.getElementById('voucherIds').value = '';
            document.getElementById('usageCategory').value = '';
            document.getElementById('customerName').value = '';
            document.getElementById('details').value = '';
            document.getElementById('photoUpload').value = '';
            document.getElementById('validationResults').classList.add('hidden');
            document.getElementById('redemptionForm').classList.add('hidden');
            validatedVouchers = [];
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
                type === 'error' ? 'bg-red-500 text-white' : 
                type === 'success' ? 'bg-green-500 text-white' : 
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Close modal
        function closeModal() {
            document.getElementById('successModal').classList.add('hidden');
        }

        // Auto-uppercase voucher input
        document.getElementById('voucherIds').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98e54615260ca84a',t:'MTc2MDQyNjAwMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
