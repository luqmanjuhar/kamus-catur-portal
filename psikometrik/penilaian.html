<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #ff9800; --dark: #e65100; --bg: #fff3e0; }
    body { background-color: var(--bg); font-family: 'Poppins', sans-serif; padding-bottom: 50px; }
    .main-container { max-width: 800px; margin: 30px auto; padding: 0 15px; }
    .custom-card { background: white; border-radius: 15px; border-top: 5px solid var(--primary); padding: 30px; margin-bottom: 20px; }
    .btn-theme { background-color: var(--primary); color: white; border: none; padding: 12px 40px; border-radius: 50px; width: 100%; font-weight: 600; }
    .score-circle { width: 120px; height: 120px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-direction: column; margin: 0 auto 20px; }
    .cat-box { background: #fffcf5; border-left: 4px solid var(--primary); padding: 15px; margin-bottom: 10px; border-radius: 8px; }
    .question-row { border-bottom: 1px solid #eee; padding: 15px 0; }
  </style>
</head>
<body>
  <div class="main-container">
    <h2 class="text-center mb-4 fw-bold" style="color:var(--dark)">PENILAIAN PEMAIN</h2>
    
    <div id="formCard" class="custom-card">
      <form id="quizForm">
        <div class="row g-3 mb-3">
          <div class="col-md-6"><label>Nama Penuh</label><input type="text" name="nama" class="form-control" required></div>
          <div class="col-md-6"><label>Status</label>
            <select name="status" class="form-select" required><option>KCHERS</option><option>AHLI AKTIF</option><option>ALUMNI</option><option>BUKAN AHLI</option></select>
          </div>
        </div>
        <div id="soalanContainer"></div>
        <button type="submit" id="submitBtn" class="btn-theme mt-4">HANTAR & SIMPAN</button>
      </form>
    </div>

    <div id="resultBox" class="custom-card text-center" style="display:none;">
      <h4 id="resNama" style="color:var(--primary); font-weight:800;">NAMA</h4>
      <div class="score-circle"><span id="resSkor" style="font-size:2.5em; font-weight:800; line-height:1;">0</span>/200</div>
      <div id="resTahap" class="badge bg-dark fs-6 mb-4">TAHAP</div>
      
      <div class="text-start">
        <div class="cat-box"><b>üß† Mental:</b> <span id="s1"></span><br><small id="t1"></small></div>
        <div class="cat-box"><b>‚ù§Ô∏è Emosi:</b> <span id="s2"></span><br><small id="t2"></small></div>
        <div class="cat-box"><b>üìÖ Disiplin:</b> <span id="s3"></span><br><small id="t3"></small></div>
        <div class="cat-box"><b>‚ôüÔ∏è Keputusan:</b> <span id="s4"></span><br><small id="t4"></small></div>
        <div class="cat-box"><b>üöÄ Mindset:</b> <span id="s5"></span><br><small id="t5"></small></div>
      </div>
      <button onclick="downloadPDF()" class="btn btn-success mt-4 rounded-pill px-4">üì• Muat Turun PDF</button>
    </div>
  </div>

  <script>
    const qs = [
      "Saya kekal fokus walaupun game > 4 jam.", "Saya tak mudah mengaku kalah.", "Saya kawal nafas bila genting.", "Tak terganggu provokasi.", "Tenang walau masa suntuk.", "Stamina mental tinggi.", "Tekanan itu motivasi.", "Tak hirau bunyi bising.",
      "Lupa blunder segera.", "Game lepas tak ganggu game baru.", "Poker face.", "Kalah tanggungjawab sendiri.", "Tak salah faktor luar.", "Tenang bila lawan buat move pelik.", "Emosi konsisten.", "Tak takut rating tinggi.",
      "Jadual latihan tetap.", "Analisis game kalah.", "Buat puzzle konsisten.", "Kaji opening.", "Jaga tidur/makan.", "Tulis nota.", "Fokus masa training.", "Korban hiburan.",
      "Check ancaman dulu.", "Ambil risiko terkira.", "Urus masa fikir.", "Ada plan middle-game.", "Yakin gerak hati.", "Tak main laju.", "Ubah strategi jika perlu.", "Cari best move.",
      "Percaya usaha.", "Terima kritikan.", "Suka teknik baru.", "Idola inspirasi.", "Tak takut kalah cuba baru.", "Kualiti > Rating.", "Tanya senior.", "Komited jadi lebih baik."
    ];

    const cont = document.getElementById('soalanContainer');
    qs.forEach((q, i) => {
       if(i%8===0) cont.innerHTML += `<div class="badge bg-dark mt-4 mb-2">BAHAGIAN ${Math.floor(i/8)+1}</div>`;
       cont.innerHTML += `<div class="question-row"><small>${i+1}. ${q}</small><div class="d-flex justify-content-between px-2 mt-2">${[1,2,3,4,5].map(v=>`<label><input type="radio" name="q${i+1}" value="${v}" required><br><span style="font-size:10px">${v}</span></label>`).join('')}</div></div>`;
    });

    document.getElementById('quizForm').onsubmit = function(e) {
       e.preventDefault();
       const btn = document.getElementById('submitBtn');
       btn.innerText = "MENYIMPAN..."; btn.disabled = true;
       
       const fd = new FormData(this);
       let scores = [0,0,0,0,0], total = 0;
       for(let i=1; i<=40; i++) {
          let v = parseInt(fd.get('q'+i));
          total += v;
          scores[Math.floor((i-1)/8)] += v;
       }
       
       let tahap = total >= 161 ? "ELITE" : total >= 121 ? "COMPETITIVE" : total >= 81 ? "DEVELOPING" : "BEGINNER";
       const tips = (s) => s>=32 ? "‚úÖ Cemerlang" : s>=24 ? "‚ö†Ô∏è Sederhana" : "üõë Perlu Fokus";

       const payload = {
          nama: fd.get('nama'), status: fd.get('status'),
          total: total, mental: scores[0], emosi: scores[1], disiplin: scores[2], keputusan: scores[3], mindset: scores[4]
       };

       google.script.run.withSuccessHandler(() => {
          document.getElementById('formCard').style.display = 'none';
          document.getElementById('resultBox').style.display = 'block';
          document.getElementById('resNama').innerText = payload.nama;
          document.getElementById('resSkor').innerText = total;
          document.getElementById('resTahap').innerText = tahap;
          for(let k=0; k<5; k++) {
             document.getElementById('s'+(k+1)).innerText = scores[k]+"/40";
             document.getElementById('t'+(k+1)).innerText = tips(scores[k]);
          }
       }).prosesDanSimpan(payload);
    };

    function downloadPDF() {
      const el = document.getElementById('resultBox');
      html2pdf().set({ margin:0.5, filename:`Prestasi_${document.getElementById('resNama').innerText}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'in',format:'letter'} }).from(el).save();
    }
  </script>
</body>
</html>
