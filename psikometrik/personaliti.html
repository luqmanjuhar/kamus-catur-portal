<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #ff9800; --dark: #e65100; --bg: #fff3e0; }
    body { background-color: var(--bg); font-family: 'Poppins', sans-serif; color: #333; padding-bottom: 50px; }
    .main-container { max-width: 800px; margin: 30px auto; padding: 0 15px; }
    .custom-card { background: white; border: none; border-radius: 15px; border-top: 5px solid var(--primary); padding: 30px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
    .btn-theme { background-color: var(--primary); color: white; border: none; padding: 12px 40px; border-radius: 50px; font-weight: 600; width: 100%; transition: 0.3s; }
    .btn-theme:hover { background-color: var(--dark); }
    .role-badge { background: var(--dark); color: white; padding: 10px 30px; border-radius: 50px; font-size: 1.5em; font-weight: bold; margin: 20px 0; display: inline-block; }
    .score-bar-bg { background: #eee; height: 10px; border-radius: 5px; overflow: hidden; width:100%; }
    .score-bar-fill { background: var(--primary); height: 100%; }
    .option-label { display: block; padding: 12px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: 0.2s; width: 100%; }
    .option-label:hover { background: var(--bg); border-color: var(--primary); }
    input[type="radio"] { margin-right: 10px; accent-color: var(--dark); }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="text-center mb-4"><h2 style="color:var(--dark); font-weight:800;">UJIAN PERSONALITI</h2></div>
    
    <div id="intro-section" class="custom-card">
      <div class="mb-3"><label class="fw-bold">Nama Penuh</label><input type="text" id="intro-name" class="form-control" placeholder="Nama Anda..."></div>
      <div class="mb-4"><label class="fw-bold">Status Keahlian</label>
        <select id="intro-status" class="form-select">
          <option value="">-- Sila Pilih --</option><option>KCHERS</option><option>AHLI AKTIF</option><option>ALUMNI</option><option>BUKAN AHLI</option>
        </select>
      </div>
      <button class="btn-theme" onclick="startQuiz()">MULA UJIAN</button>
    </div>

    <div id="quiz-section" style="display:none;">
      <div id="quiz-container"></div>
      <button class="btn-theme mt-4" onclick="submitQuiz()" id="submitBtn">HANTAR JAWAPAN</button>
    </div>

    <div id="result-container" class="custom-card text-center" style="display:none;">
      <h4 id="display-name" style="color:var(--primary); font-weight:800;">NAMA</h4>
      <p id="display-details" class="small text-muted"></p>
      <div id="final-role" class="role-badge">ROLE</div>
      <div class="text-start mt-4">
        <table class="table table-borderless table-sm">
          <tr><td width="30%">Player</td><td><div class="score-bar-bg"><div id="bar-p" class="score-bar-fill" style="width:0%"></div></div></td><td width="10%" id="val-p">0</td></tr>
          <tr><td>Coach</td><td><div class="score-bar-bg"><div id="bar-c" class="score-bar-fill" style="width:0%"></div></div></td><td id="val-c">0</td></tr>
          <tr><td>Arbiter</td><td><div class="score-bar-bg"><div id="bar-a" class="score-bar-fill" style="width:0%"></div></div></td><td id="val-a">0</td></tr>
          <tr><td>Instructor</td><td><div class="score-bar-bg"><div id="bar-i" class="score-bar-fill" style="width:0%"></div></div></td><td id="val-i">0</td></tr>
          <tr><td>Parent</td><td><div class="score-bar-bg"><div id="bar-par" class="score-bar-fill" style="width:0%"></div></div></td><td id="val-par">0</td></tr>
        </table>
      </div>
      <div class="mt-4 text-start p-3 bg-light rounded"><p id="analysis-text" style="font-size:0.9em;"></p></div>
      <button onclick="downloadPDF()" class="btn btn-success mt-3 rounded-pill px-4">ðŸ“¥ Muat Turun PDF</button>
    </div>
  </div>

  <script>
    // DATA SOALAN (Contoh 3 soalan, anda perlu copy paste 40 soalan penuh di sini dari kod asal)
    const questionsData = [
      { category: "Bahagian 1: Dewan Kejohanan", items: [
          { q: "1. Apa perkara pertama anda cari di dewan?", opts: [{txt: "Papan No 1 & lawan.", type: "p"}, {txt: "Anak murid saya.", type: "c"}, {txt: "Susunan meja & jam.", type: "a"}, {txt: "Suasana ceria.", type: "i"}, {txt: "Tandas & tempat menunggu.", type: "par"}] },
          { q: "2. Reaksi bila budak menangis kalah awal?", opts: [{txt: "Lemah mental.", type: "p"}, {txt: "Analisis game tu.", type: "c"}, {txt: "Sila keluar dewan.", type: "a"}, {txt: "Jom main game santai.", type: "i"}, {txt: "Jom beli aiskrim.", type: "par"}] },
          { q: "3. Dalam beg ada apa?", opts: [{txt: "Coklat & nota opening.", type: "p"}, {txt: "Laptop & ChessBase.", type: "c"}, {txt: "Buku Rules & pen merah.", type: "a"}, {txt: "Gula-gula & set plastik.", type: "i"}, {txt: "Bekal & kerusi lipat.", type: "par"}] },
          // ... Sila copy paste senarai soalan penuh anda di sini ...
      ]}
    ];
    
    let user = {};

    function startQuiz() {
       user.name = document.getElementById('intro-name').value;
       user.status = document.getElementById('intro-status').value;
       if(!user.name || !user.status) return alert("Sila isi maklumat.");
       
       document.getElementById('intro-section').style.display = 'none';
       document.getElementById('quiz-section').style.display = 'block';
       renderQuiz();
    }

    function renderQuiz() {
      const container = document.getElementById('quiz-container');
      let idx = 0;
      questionsData.forEach(sect => {
        container.innerHTML += `<h5 class="mt-4 text-white bg-dark p-2 rounded">${sect.category}</h5>`;
        sect.items.forEach(item => {
           let html = `<div class="custom-card p-3 mb-3 border-start border-4 border-warning"><p class="fw-bold">${item.q}</p>`;
           item.opts.sort(()=>Math.random()-0.5).forEach(opt => html += `<label class="option-label"><input type="radio" name="q${idx}" value="${opt.type}"> ${opt.txt}</label>`);
           container.innerHTML += html + `</div>`;
           idx++;
        });
      });
      user.totalQ = idx;
    }

    function submitQuiz() {
      let scores = {p:0, c:0, a:0, i:0, par:0};
      for(let i=0; i<user.totalQ; i++) {
         let el = document.querySelector(`input[name="q${i}"]:checked`);
         if(el) scores[el.value]++;
      }
      
      let winner = Object.keys(scores).reduce((a, b) => scores[a] > scores[b] ? a : b);
      let roleMap = {'p':'THE PLAYER', 'c':'THE COACH', 'a':'THE ARBITER', 'i':'INSTRUCTOR', 'par':'CHESS PARENT'};
      
      document.getElementById('submitBtn').innerText = "Menyimpan...";
      google.script.run.withSuccessHandler(() => showResult(winner, scores, roleMap)).saveToSheet({
        name: user.name, status: user.status,
        result: roleMap[winner], scores: scores
      });
    }

    function showResult(winner, scores, roleMap) {
      document.getElementById('quiz-section').style.display = 'none';
      document.getElementById('result-container').style.display = 'block';
      document.getElementById('display-name').innerText = user.name;
      document.getElementById('display-details').innerText = `${user.status}`;
      document.getElementById('final-role').innerText = roleMap[winner];
      
      const max = user.totalQ || 1; 
      ['p','c','a','i','par'].forEach(k => {
         document.getElementById(`bar-${k}`).style.width = (scores[k]/max*100*3) + '%';
         document.getElementById(`val-${k}`).innerText = scores[k];
      });
      
      let txt = "";
      if(winner === 'p') txt = "Anda seorang PEJUANG. Fokus pada kemenangan diri sendiri.";
      else if(winner === 'c') txt = "Anda seorang STRATEGIST. Suka melihat orang lain faham.";
      else if(winner === 'a') txt = "Anda PENJAGA UNDANG-UNDANG. Teliti dan objektif.";
      else if(winner === 'i') txt = "Anda PENGGERAK. Suka memupuk minat akar umbi.";
      else txt = "Anda PENYOKONG SETIA. Tulang belakang kejayaan orang lain.";
      document.getElementById('analysis-text').innerText = txt;
    }

    function downloadPDF() {
      const el = document.getElementById('result-container');
      html2pdf().set({ margin:0.5, filename:`Personaliti_${user.name}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'in',format:'letter'} }).from(el).save();
    }
  </script>
</body>
</html>
