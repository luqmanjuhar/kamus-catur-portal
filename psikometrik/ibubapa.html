<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #ff9800; --dark: #e65100; --bg: #fff3e0; }
    body { background-color: var(--bg); font-family: 'Poppins', sans-serif; padding-bottom: 50px; }
    .main-container { max-width: 800px; margin: 30px auto; padding: 0 15px; }
    .custom-card { background: white; border-radius: 15px; border-top: 5px solid var(--primary); padding: 30px; margin-bottom: 20px; }
    .btn-theme { background-color: var(--primary); color: white; border: none; padding: 12px 40px; border-radius: 50px; width: 100%; font-weight: 600; }
    .cat-box { background: #fff; border-left: 5px solid var(--primary); padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
    .likert-opt { text-align: center; margin: 0 5px; flex: 1; }
    .likert-opt input { transform: scale(1.3); accent-color: var(--dark); }
  </style>
</head>
<body>
  <div class="main-container">
    <h2 class="text-center mb-4 fw-bold" style="color:var(--dark)">INVENTORI IBU BAPA</h2>
    
    <div id="formCard" class="custom-card">
      <form id="quizForm">
        <div class="row g-3 mb-4">
          <div class="col-md-6"><label class="fw-bold">Nama Ibu/Bapa</label><input type="text" name="nama" class="form-control" required placeholder="Cth: Puan Siti"></div>
          <div class="col-md-6"><label class="fw-bold">Nama Pelajar</label><input type="text" name="anak" class="form-control" required placeholder="Cth: Aiman"></div>
        </div>
        <div id="soalanContainer"></div>
        <button type="submit" id="submitBtn" class="btn-theme mt-5">ANALISIS & SIMPAN</button>
      </form>
    </div>

    <div id="resultBox" class="custom-card text-center" style="display:none;">
      <h4 id="resTitle" style="color:var(--dark); font-weight:800;">TITLE</h4>
      <div id="resBadge" class="badge bg-secondary mb-3">ZONE</div>
      <div style="font-size:3em; font-weight:800; color:var(--primary); line-height:1;"><span id="resTotal">0</span>/200</div>
      
      <div class="bg-light p-4 rounded mt-3 text-start border-start border-4 border-warning">
        <h6 class="fw-bold text-dark">Ulasan Psikologi:</h6>
        <p id="resReview" class="small mb-3" style="line-height:1.6;"></p>
        <h6 class="fw-bold text-dark mt-3">Langkah Seterusnya:</h6>
        <ul id="resTips" class="small mb-0 ps-3"></ul>
      </div>

      <div class="text-start mt-4">
         <div class="cat-box d-flex justify-content-between"><span>üß† A. Emosi</span><span id="sA" class="fw-bold"></span></div>
         <div class="cat-box d-flex justify-content-between"><span>üìä B. Data</span><span id="sB" class="fw-bold"></span></div>
         <div class="cat-box d-flex justify-content-between"><span>üéÆ C. Control</span><span id="sC" class="fw-bold"></span></div>
         <div class="cat-box d-flex justify-content-between"><span>‚öñÔ∏è D. Balance</span><span id="sD" class="fw-bold"></span></div>
         
         <div class="alert alert-warning mt-3">
           <b>‚ö†Ô∏è Diagnosis Utama:</b> <span id="domType"></span><br>
           <small id="domProb" class="d-block mt-1"></small>
           <hr>
           <small id="domRx" class="text-danger fst-italic fw-bold"></small>
         </div>
      </div>
      <button onclick="downloadPDF()" class="btn btn-success mt-4 rounded-pill px-4">üì• Muat Turun PDF</button>
    </div>
  </div>

  <script>
    const qs = [
      "Fizikal tertekan bila anak kalah.", "Sukar cakap lembut lepas blunder.", "Malu jumpa parent lain.", "Mood ikut prestasi anak.", "Salahkan faktor luar.", "Tunjuk silap segera.", "Menang anak = kejayaan saya.", "Sukar tidur lepas kalah.", "Marah anak dalam kereta.", "Fokus kenapa kalah.", 
      "Semak chess-results kerap.", "Tahu rating lawan dulu.", "Kira rating changes.", "Kecewa rating drop.", "Banding graf anak.", "Target rating wajib.", "Stalk lawan.", "Main sebab rating.", "Hafal rating orang.", "Rating = kepintaran.", 
      "Bagi arahan teknikal.", "Lebih tahu dari coach.", "Tukar coach kerap.", "Pantau training ketat.", "Guna engine buktikan coach salah.", "Paksa latih masa sakit.", "Rungut pasal arbiter.", "Duduk dekat papan.", "Suruh draw/tulis.", "Soal coach depan anak.", 
      "Cuti = Tournament.", "Belanja lebih mampu.", "Bual catur 90%.", "Ponteng sekolah.", "Harap pulangan duit.", "Tiada hobi lain.", "Ungkit duit.", "Gaduh suami isteri.", "Catur satu-satunya jalan.", "Kawan parent catur je."
    ];

    const cont = document.getElementById('soalanContainer');
    qs.forEach((q, i) => {
      let sec = i<10?"A: EMOSI":i<20?"B: DATA":i<30?"C: CONTROL":"D: BALANCE";
      if(i%10===0) cont.innerHTML += `<div class="badge bg-secondary mt-4 mb-2">${sec}</div>`;
      cont.innerHTML += `<div class="border-bottom py-2"><p class="mb-1 small fw-bold">${i+1}. ${q}</p><div class="d-flex justify-content-center">${[1,2,3,4,5].map(v=>`<div class="likert-opt"><input type="radio" name="q${i+1}" value="${v}" required><div style="font-size:9px">${v}</div></div>`).join('')}</div></div>`;
    });

    document.getElementById('quizForm').onsubmit = function(e) {
      e.preventDefault();
      document.getElementById('submitBtn').innerText = "MENYIMPAN...";
      
      const fd = new FormData(this);
      let t=0, sA=0, sB=0, sC=0, sD=0;
      for(let i=1; i<=40; i++) {
        let v = parseInt(fd.get('q'+i));
        t+=v; if(i<=10)sA+=v; else if(i<=20)sB+=v; else if(i<=30)sC+=v; else sD+=v;
      }
      
      let prof = {};
      if(t<=80) {
         prof.title="THE SUPPORTIVE GARDENER"; prof.badge="IBU BAPA IDEAL";
         prof.rev="Tahniah. Anda berada di zon yang sangat sihat. Anda menganggap catur sebagai alat pendidikan, bukan alat untuk memuaskan ego sendiri. Anda menyiram 'bunga' (anak) dan membiarkannya tumbuh mengikut kadarnya sendiri."; 
         prof.tips=["Teruskan memberi sokongan tanpa syarat (Unconditional Love).", "Fokus kepada keseronokan bermain, bukan keputusan.", "Kekalkan jarak yang sihat dengan jurulatih."];
      } else if(t<=120) {
         prof.title="THE ENTHUSIASTIC MANAGER"; prof.badge="ZON BERHATI-HATI";
         prof.rev="Anda sangat komited dan mahukan yang terbaik, tetapi kadangkala semangat anda memberi tekanan tidak sedar kepada anak. Anda mungkin mula terlalu memandang nombor dan ranking."; 
         prof.tips=["Kurangkan melihat chess-results semasa kejohanan.", "Jangan bincang pasal catur dalam perjalanan pulang jika anak kalah.", "Berikan anak ruang untuk bernafas selepas game."];
      } else if(t<=160) {
         prof.title="THE HELICOPTER TIGER"; prof.badge="ZON BAHAYA";
         prof.rev="Amaran. Penglibatan anda terlalu tinggi (over-involved). Identiti diri anda mula terikat dengan prestasi anak. Anak mungkin bermain kerana takut mengecewakan anda, bukan kerana minat."; 
         prof.tips=["Wajibkan 'Zon Bebas Catur' di rumah.", "Berhenti menganalisis game anak. Serahkan 100% pada coach.", "Pertimbangkan untuk tidak hadir ke beberapa kejohanan kecil."];
      } else {
         prof.title="THE OBSESSIVE PARENT"; prof.badge="ZON TOKSIK";
         prof.rev="Situasi ini kritikal. Obsesi anda sedang merosakkan minat anak dan hubungan kekeluargaan. Risiko 'burnout' anak sangat tinggi. Catur bukan lagi permainan, tetapi bebanan hutang emosi."; 
         prof.tips=["Anda memerlukan 'Detox Catur' segera (rehat 1-2 bulan).", "Dapatkan kaunseling atau nasihat profesional.", "Refleksi semula: Adakah ini impian anda atau impian anak?"];
      }

      let max = Math.max(sA,sB,sC,sD);
      let dom="", prob="", rx="";
      if(max===sA){ dom="Emotional Rollercoaster"; prob="Emosi tidak stabil. Anak takut memberitahu keputusan game."; rx="Amalkan teknik pernafasan 4-7-8. 'No Post-Mortem' 2 jam lepas game."; }
      else if(max===sB){ dom="The Rating Slave"; prob="Melihat anak sebagai nombor. Anak takut ambil risiko."; rx="Padam app Elo Calculator. Fokus performance, bukan result."; }
      else if(max===sC){ dom="The Sideline Coach"; prob="Mengelirukan anak dan merosakkan autoriti coach."; rx="Perjanjian bisu: Anda hanya 'Pemandu & Penaja Makanan'."; }
      else { dom="The All-In Gambler"; prob="Menuntut pulangan pelaburan kewangan melalui kemenangan."; rx="Cari hobi lain. Tetapkan bajet ketat. Hujung minggu tanpa catur."; }

      const payload = { nama: fd.get('nama'), anak: fd.get('anak'), total: t, profil: prof.title, skorA: sA, skorB: sB, skorC: sC, skorD: sD, dominan: dom };
      
      google.script.run.withSuccessHandler(() => {
         document.getElementById('formCard').style.display = 'none';
         document.getElementById('resultBox').style.display = 'block';
         document.getElementById('resTotal').innerText = t;
         document.getElementById('resTitle').innerText = prof.title;
         
         let bg = t<=80?"bg-success":t<=120?"bg-warning text-dark":t<=160?"bg-orange":"bg-danger";
         document.getElementById('resBadge').className = `badge ${bg} mb-3 fs-6`;
         document.getElementById('resBadge').innerText = prof.badge;
         
         document.getElementById('resReview').innerText = prof.rev;
         let ul = document.getElementById('resTips'); ul.innerHTML="";
         prof.tips.forEach(x => ul.innerHTML+=`<li>${x}</li>`);

         document.getElementById('sA').innerText = sA+"/50"; document.getElementById('sB').innerText = sB+"/50";
         document.getElementById('sC').innerText = sC+"/50"; document.getElementById('sD').innerText = sD+"/50";
         document.getElementById('domType').innerText = dom; document.getElementById('domProb').innerText = prob; document.getElementById('domRx').innerText = rx;
      }).simpanIbuBapa(payload);
    };

    function downloadPDF() {
      html2pdf().set({ margin:0.4, filename:`Parent_${document.getElementById('resTotal').innerText}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'in',format:'letter'} }).from(document.getElementById('resultBox')).save();
    }
  </script>
</body>
</html>
