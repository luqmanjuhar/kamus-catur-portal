<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Sukan Catur MSSD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        * {
            box-sizing: border-box;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .edit-mode-indicator {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ea580c;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .edit-mode-indicator.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-orange-50 to-orange-100 min-h-full">
    <!-- Indicator for Edit Mode -->
    <div class="edit-mode-indicator" id="editModeIndicator">
        üîÑ MOD EDIT AKTIF
    </div>

    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <header class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-orange-600 text-center">Dashboard Sukan Catur MSSD</h1>
            <p class="text-center text-gray-600 mt-2">Sistem Pendaftaran Kejohanan Catur Peringkat Daerah</p>
        </header>

        <!-- Navigation Tabs -->
        <nav class="bg-white rounded-lg shadow-md p-4 mb-6">
            <div class="flex flex-wrap gap-3 justify-center">
                <button onclick="switchTab('pendaftaran')" class="tab-btn px-6 py-3 rounded-lg font-semibold transition-all bg-orange-600 text-white" data-tab="pendaftaran">
                    üìù Pendaftaran Baru
                </button>
                <button onclick="switchTab('edit')" class="tab-btn px-6 py-3 rounded-lg font-semibold transition-all bg-gray-200 text-gray-700 hover:bg-gray-300" data-tab="edit">
                    ‚úèÔ∏è Edit Pendaftaran
                </button>
                <button onclick="switchTab('dashboard')" class="tab-btn px-6 py-3 rounded-lg font-semibold transition-all bg-gray-200 text-gray-700 hover:bg-gray-300" data-tab="dashboard">
                    üìä Dashboard Pendaftaran
                </button>
            </div>
        </nav>

        <!-- Tab Content: Pendaftaran Baru / Edit -->
        <div id="pendaftaran" class="tab-content active">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-orange-600 mb-6">Pendaftaran Baru</h2>
                
                <form id="registrationForm" onsubmit="handleSubmit(event)">
                    <section class="mb-8">
                        <h3 class="text-xl font-semibold text-orange-600 mb-4 border-b-2 border-orange-300 pb-2">Maklumat Sekolah</h3>
                        
                        <div class="mb-4">
                            <label for="schoolName" class="block text-gray-700 font-medium mb-2">Nama Sekolah *</label>
                            <input type="text" id="schoolName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="Contoh: SK Taman Desa">
                            <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                <p class="text-sm text-blue-800">
                                    <span class="font-semibold">üí° Tips:</span> Anda boleh gunakan singkatan sahaja:
                                </p>
                                <div class="text-xs text-blue-700 mt-1 grid grid-cols-2 gap-2">
                                    <div>‚Ä¢ <strong>SK</strong> - Sekolah Kebangsaan</div>
                                    <div>‚Ä¢ <strong>SMK</strong> - Sekolah Menengah Kebangsaan</div>
                                    <div>‚Ä¢ <strong>SJKC</strong> - Sekolah Jenis Kebangsaan (Cina)</div>
                                    <div>‚Ä¢ <strong>SJKT</strong> - Sekolah Jenis Kebangsaan (Tamil)</div>
                                    <div>‚Ä¢ <strong>SMKA</strong> - Sekolah Menengah Kebangsaan Agama</div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="mb-8">
                        <h3 class="text-xl font-semibold text-orange-600 mb-4 border-b-2 border-orange-300 pb-2">Maklumat Guru</h3>
                        
                        <div id="teachersContainer">
                            <!-- Teacher 1 (Ketua) -->
                            <div class="teacher-entry bg-orange-50 p-4 rounded-lg mb-4" data-teacher-index="0">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-semibold text-orange-700">Guru 1 (Ketua) *</h4>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">Nama Guru *</label>
                                        <input type="text" required class="teacher-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Nama penuh guru">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">Email Guru *</label>
                                        <input type="email" required class="teacher-email w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="email@example.com">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">Nombor Telefon *</label>
                                        <input type="tel" required class="teacher-phone w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="012-345 6789" maxlength="13">
                                    </div>
                                </div>
                            </div>

                            <!-- Teacher 2 (Pengiring) -->
                            <div class="teacher-entry bg-orange-50 p-4 rounded-lg mb-4" data-teacher-index="1">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-semibold text-orange-700">Guru 2 (Pengiring) *</h4>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">Nama Guru *</label>
                                        <input type="text" required class="teacher-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Nama penuh guru">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">Email Guru *</label>
                                        <input type="email" required class="teacher-email w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="email@example.com">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">Nombor Telefon *</label>
                                        <input type="tel" required class="teacher-phone w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="012-345 6789" maxlength="13">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button type="button" onclick="addTeacher()" class="mt-4 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-medium">
                            ‚ûï Tambah Guru Pengiring
                        </button>
                    </section>

                    <section class="mb-8">
                        <h3 class="text-xl font-semibold text-orange-600 mb-4 border-b-2 border-orange-300 pb-2">Pendaftaran Pelajar</h3>
                        
                        <div id="studentsContainer">
                            <!-- Student 1 -->
                            <div class="student-entry bg-orange-50 p-4 rounded-lg mb-4" data-student-index="0">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-semibold text-orange-700">Pelajar 1</h4>
                                    <button type="button" onclick="removeStudent(0)" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors text-sm">
                                        üóëÔ∏è Buang
                                    </button>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">Nama Pelajar *</label>
                                        <input type="text" required class="student-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Nama penuh pelajar">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">Nombor IC *</label>
                                        <input type="text" required class="student-ic w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="XXXXXX-XX-XXXX" maxlength="14">
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">Jantina *</label>
                                        <select required class="student-gender w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                            <option value="">Pilih Jantina</option>
                                            <option value="Lelaki">Lelaki</option>
                                            <option value="Perempuan">Perempuan</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">Kategori *</label>
                                        <select required class="student-category w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                            <option value="">Pilih Kategori</option>
                                            <option value="Bawah 12 Tahun">Bawah 12 Tahun</option>
                                            <option value="Bawah 15 Tahun">Bawah 15 Tahun</option>
                                            <option value="Bawah 18 Tahun">Bawah 18 Tahun</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">ID Pemain</label>
                                        <input type="text" readonly class="student-id w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100" placeholder="Auto-generated">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button type="button" onclick="addStudent()" class="mt-4 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-medium">
                            ‚ûï Tambah Pelajar
                        </button>
                    </section>

                    <div class="flex gap-4 justify-end">
                        <button type="button" onclick="resetForm()" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium">
                            üîÑ Reset
                        </button>
                        <button type="submit" class="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-medium">
                            üíæ Hantar Pendaftaran
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tab Content: Edit Pendaftaran -->
        <div id="edit" class="tab-content">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-orange-600 mb-6">Edit Pendaftaran</h2>
                
                <form id="searchForm" onsubmit="handleSearch(event)" class="max-w-2xl mx-auto">
                    <div class="mb-4">
                        <label for="searchRegId" class="block text-gray-700 font-medium mb-2">ID Pendaftaran *</label>
                        <input type="text" id="searchRegId" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Contoh: MSSD-01-003">
                    </div>
                    
                    <div class="mb-6">
                        <label for="searchPassword" class="block text-gray-700 font-medium mb-2">Kata Laluan (4 Digit Terakhir No Telefon Guru Ketua) *</label>
                        <input type="text" id="searchPassword" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Contoh: 6789" maxlength="4">
                    </div>
                    
                    <button type="submit" class="w-full px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-medium">
                        üîç Cari Pendaftaran
                    </button>
                </form>

                <div id="searchResult" class="mt-6 hidden">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <p class="text-green-800 font-medium">‚úÖ Pendaftaran dijumpai! Sila tukar ke tab "Pendaftaran Baru" untuk mengedit.</p>
                    </div>
                </div>

                <div id="searchError" class="mt-6 hidden">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p class="text-red-800 font-medium">‚ùå Pendaftaran tidak dijumpai atau kata laluan salah.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Dashboard Pendaftaran -->
        <div id="dashboard" class="tab-content">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-orange-600 mb-6">Dashboard Pendaftaran</h2>
                
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <div class="bg-gradient-to-br from-orange-600 to-orange-700 rounded-lg p-6 text-white">
                        <div class="text-3xl font-bold" id="totalRegistrations">0</div>
                        <div class="text-orange-100 mt-2">Jumlah Pendaftaran</div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-amber-600 to-amber-700 rounded-lg p-6 text-white">
                        <div class="text-3xl font-bold" id="totalStudents">0</div>
                        <div class="text-amber-100 mt-2">Jumlah Pelajar</div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-yellow-600 to-yellow-700 rounded-lg p-6 text-white">
                        <div class="text-3xl font-bold" id="totalSchools">0</div>
                        <div class="text-yellow-100 mt-2">Jumlah Sekolah</div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-red-600 to-red-700 rounded-lg p-6 text-white">
                        <div class="text-3xl font-bold" id="totalTeachers">0</div>
                        <div class="text-red-100 mt-2">Jumlah Guru</div>
                    </div>
                </div>

                <!-- Tree Diagram: Breakdown by Category -->
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-6 mb-8">
                    <h3 class="text-xl font-bold text-indigo-800 mb-6 text-center">üìä Analisis Pendaftaran Mengikut Kategori</h3>
                    
                    <div id="treeDiagram" class="space-y-6">
                        <!-- Root Level -->
                        <div class="text-center">
                            <div class="inline-block bg-indigo-600 text-white px-6 py-3 rounded-lg font-bold text-lg">
                                <span id="treeTotal">0</span> Sekolah Berdaftar
                            </div>
                        </div>
                        
                        <div class="flex justify-center">
                            <div class="w-px h-8 bg-gray-400"></div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <!-- Primary Schools -->
                            <div class="text-center">
                                <div class="bg-green-500 text-white px-4 py-2 rounded-lg font-semibold mb-4">
                                    <div class="text-2xl font-bold" id="primarySchools">0</div>
                                    <div class="text-sm">Sekolah Rendah</div>
                                    <div class="text-xs opacity-90">(SK, SJKC, SJKT)</div>
                                </div>
                                
                                <!-- Primary Categories -->
                                <div class="space-y-3">
                                    <div class="bg-green-100 border border-green-300 rounded-lg p-3">
                                        <div class="font-semibold text-green-800 mb-2">Bawah 12 Tahun</div>
                                        <div class="grid grid-cols-2 gap-2 text-sm">
                                            <div class="bg-blue-200 text-blue-800 px-2 py-1 rounded">
                                                <span class="font-bold" id="primary12Male">0</span> Lelaki
                                            </div>
                                            <div class="bg-pink-200 text-pink-800 px-2 py-1 rounded">
                                                <span class="font-bold" id="primary12Female">0</span> Perempuan
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Secondary Schools -->
                            <div class="text-center">
                                <div class="bg-purple-500 text-white px-4 py-2 rounded-lg font-semibold mb-4">
                                    <div class="text-2xl font-bold" id="secondarySchools">0</div>
                                    <div class="text-sm">Sekolah Menengah</div>
                                    <div class="text-xs opacity-90">(SMK, SMKA)</div>
                                </div>
                                
                                <!-- Secondary Categories -->
                                <div class="space-y-3">
                                    <div class="bg-purple-100 border border-purple-300 rounded-lg p-3">
                                        <div class="font-semibold text-purple-800 mb-2">Bawah 15 Tahun</div>
                                        <div class="grid grid-cols-2 gap-2 text-sm">
                                            <div class="bg-blue-200 text-blue-800 px-2 py-1 rounded">
                                                <span class="font-bold" id="secondary15Male">0</span> Lelaki
                                            </div>
                                            <div class="bg-pink-200 text-pink-800 px-2 py-1 rounded">
                                                <span class="font-bold" id="secondary15Female">0</span> Perempuan
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-purple-100 border border-purple-300 rounded-lg p-3">
                                        <div class="font-semibold text-purple-800 mb-2">Bawah 18 Tahun</div>
                                        <div class="grid grid-cols-2 gap-2 text-sm">
                                            <div class="bg-blue-200 text-blue-800 px-2 py-1 rounded">
                                                <span class="font-bold" id="secondary18Male">0</span> Lelaki
                                            </div>
                                            <div class="bg-pink-200 text-pink-800 px-2 py-1 rounded">
                                                <span class="font-bold" id="secondary18Female">0</span> Perempuan
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed School List -->
                <div class="bg-white rounded-lg border border-gray-200 p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">üìã Senarai Sekolah Berdaftar</h3>
                    <div id="registrationsList" class="space-y-4">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data storage in localStorage
        let registrations = JSON.parse(localStorage.getItem('mssdRegistrations') || '{}');
        let currentEditId = null;
        let teacherCount = 2;
        let studentCount = 1;
        // The Google Script URL BASE for submission (POST) and reading (GET?action=read)
        const GOOGLE_SCRIPT_URL_BASE = 'https://script.google.com/macros/s/AKfycbymF7bPqtjqUxjhOEiXTSazWvLo-w6vReobw6vJyl6MPXw57DSMxQ0MCvA8jUdtj9ADKA/exec';

        // --- Core UI Functions ---

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-orange-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.remove('bg-gray-200', 'text-gray-700');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('bg-orange-600', 'text-white');
            
            if (tabName === 'dashboard') {
                updateDashboard();
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-20 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } text-white max-w-md`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // --- Data Formatting and ID Generation ---

        function formatSchoolName(name) {
            name = name.toUpperCase();
            // Standardize school prefixes
            name = name.replace(/SEKOLAH KEBANGSAAN/gi, 'SK');
            name = name.replace(/SEKOLAH MENENGAH KEBANGSAAN AGAMA/gi, 'SMKA');
            name = name.replace(/SEKOLAH MENENGAH KEBANGSAAN/gi, 'SMK');
            name = name.replace(/SEKOLAH JENIS KEBANGSAAN \(CINA\)/gi, 'SJKC');
            name = name.replace(/SEKOLAH JENIS KEBANGSAAN \(TAMIL\)/gi, 'SJKT');
            name = name.replace(/SEKOLAH JENIS KEBANGSAAN/gi, 'SJK');
            return name;
        }

        function formatPhoneNumber(phone) {
            phone = phone.replace(/\D/g, '');
            if (phone.length >= 11) {
                return phone.substring(0, 3) + '-' + phone.substring(3, 6) + ' ' + phone.substring(6, 11);
            } else if (phone.length >= 10) {
                return phone.substring(0, 3) + '-' + phone.substring(3, 6) + ' ' + phone.substring(6, 10);
            }
            return phone;
        }

        function formatIC(ic) {
            ic = ic.replace(/\D/g, '');
            if (ic.length >= 12) {
                return ic.substring(0, 6) + '-' + ic.substring(6, 8) + '-' + ic.substring(8, 12);
            }
            return ic;
        }

        function generatePlayerId(gender, schoolName, studentIndex, category, regId) {
            const year = new Date().getFullYear().toString().slice(-2);
            
            // Category code
            let categoryCode = '15'; 
            if (category.includes('12')) {
                categoryCode = '12';
            } else if (category.includes('15')) {
                categoryCode = '15';
            } else if (category.includes('18')) {
                categoryCode = '18';
            }
            
            // Gender code
            const genderCode = gender === 'Lelaki' ? '01' : '02';
            
            // School number from registration ID (last 3 digits)
            const regIdParts = regId ? regId.split('-') : [];
            const schoolNo = regIdParts.length > 2 ? regIdParts.pop().padStart(3, '0') : '000';
            
            // Player number for this registration (2 digits)
            const playerCount = String(studentIndex + 1).padStart(2, '0');
            
            return `${year}${categoryCode}${genderCode}${schoolNo}${playerCount}`;
        }

        function generateRegistrationId(category) {
            // Count existing registrations
            let categoryCount = 0;
            // This is a simplified sequential counter based on existing registrations count
            categoryCount = Object.keys(registrations).length;
            
            // Category code: 01 for Primary (B12), 02 for Secondary (B15/B18)
            const categoryCode = category.includes('12') ? '01' : '02';
            
            // Sequential count for *all* registrations
            const count = String(categoryCount + 1).padStart(3, '0');
            
            return `MSSD-${categoryCode}-${count}`;
        }

        function updateStudentIds() {
            const schoolName = document.getElementById('schoolName').value;
            const students = document.querySelectorAll('.student-entry');
            
            const firstStudent = students[0];
            if (firstStudent) {
                const firstCategory = firstStudent.querySelector('.student-category').value;
                if (firstCategory) {
                    // Use the editing ID, or generate a potential new one for display
                    const tempRegId = currentEditId || generateRegistrationId(firstCategory);
                    
                    students.forEach((student, index) => {
                        const gender = student.querySelector('.student-gender').value;
                        const category = student.querySelector('.student-category').value;
                        const idField = student.querySelector('.student-id');
                        
                        if (gender && schoolName && category) {
                            idField.value = generatePlayerId(gender, schoolName, index, category, tempRegId);
                        } else {
                            idField.value = 'Auto-generated';
                        }
                    });
                }
            }
        }

        // --- Dynamic Form Management (Teachers & Students) ---

        function addTeacher() {
            const container = document.getElementById('teachersContainer');
            const newTeacher = document.createElement('div');
            const newIndex = container.querySelectorAll('.teacher-entry').length;
            
            newTeacher.className = 'teacher-entry bg-orange-50 p-4 rounded-lg mb-4';
            newTeacher.setAttribute('data-teacher-index', newIndex);
            
            newTeacher.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-semibold text-orange-700">Guru ${newIndex + 1} (Pengiring)</h4>
                    <button type="button" onclick="removeTeacher(${newIndex})" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors text-sm">
                        üóëÔ∏è Buang
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Nama Guru *</label>
                        <input type="text" required class="teacher-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Nama penuh guru">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Email Guru *</label>
                        <input type="email" required class="teacher-email w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="email@example.com">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Nombor Telefon *</label>
                        <input type="tel" required class="teacher-phone w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="012-345 6789" maxlength="13">
                    </div>
                </div>
            `;
            
            container.appendChild(newTeacher);
        }

        function removeTeacher(index) {
            const teachers = document.querySelectorAll('.teacher-entry');
            const teacherToRemove = document.querySelector(`[data-teacher-index="${index}"]`);
            if (teachers.length > 2) {
                teacherToRemove.remove();
                // Re-index and update display names
                document.querySelectorAll('.teacher-entry').forEach((entry, idx) => {
                    entry.setAttribute('data-teacher-index', idx);
                    const title = entry.querySelector('h4');
                    const removeBtn = entry.querySelector('button');
                    if (idx === 0) {
                        title.innerHTML = 'Guru 1 (Ketua) *';
                    } else {
                        title.innerHTML = `Guru ${idx + 1} (Pengiring)`;
                        removeBtn.setAttribute('onclick', `removeTeacher(${idx})`);
                    }
                });
            } else {
                showNotification('Minimum 2 guru diperlukan!', 'error');
            }
        }

        function addStudent() {
            const container = document.getElementById('studentsContainer');
            const newStudent = document.createElement('div');
            const newIndex = container.querySelectorAll('.student-entry').length;
            
            newStudent.className = 'student-entry bg-orange-50 p-4 rounded-lg mb-4';
            newStudent.setAttribute('data-student-index', newIndex);
            
            newStudent.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-semibold text-orange-700">Pelajar ${newIndex + 1}</h4>
                    <button type="button" onclick="removeStudent(${newIndex})" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors text-sm">
                        üóëÔ∏è Buang
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Nama Pelajar *</label>
                        <input type="text" required class="student-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Nama penuh pelajar">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Nombor IC *</label>
                        <input type="text" required class="student-ic w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="XXXXXX-XX-XXXX" maxlength="14">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Jantina *</label>
                        <select required class="student-gender w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                            <option value="">Pilih Jantina</option>
                            <option value="Lelaki">Lelaki</option>
                            <option value="Perempuan">Perempuan</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Kategori *</label>
                        <select required class="student-category w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                            <option value="">Pilih Kategori</option>
                            <option value="Bawah 12 Tahun">Bawah 12 Tahun</option>
                            <option value="Bawah 15 Tahun">Bawah 15 Tahun</option>
                            <option value="Bawah 18 Tahun">Bawah 18 Tahun</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">ID Pemain</label>
                        <input type="text" readonly class="student-id w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100" placeholder="Auto-generated">
                    </div>
                </div>
            `;
            
            container.appendChild(newStudent);
            updateStudentIds();
        }

        function removeStudent(index) {
            const studentToRemove = document.querySelector(`[data-student-index="${index}"]`);
            if (studentToRemove) {
                studentToRemove.remove();
                // Re-index and update display names
                document.querySelectorAll('.student-entry').forEach((entry, idx) => {
                    entry.setAttribute('data-student-index', idx);
                    entry.querySelector('h4').textContent = `Pelajar ${idx + 1}`;
                    const removeBtn = entry.querySelector('button');
                    if (removeBtn) {
                        removeBtn.setAttribute('onclick', `removeStudent(${idx})`);
                    }
                });
                updateStudentIds();
            }
        }

        // --- Data Submission and Persistence ---

        function collectFormData() {
            const schoolName = document.getElementById('schoolName').value;
            
            const teachers = [];
            document.querySelectorAll('.teacher-entry').forEach((entry, index) => {
                teachers.push({
                    name: entry.querySelector('.teacher-name').value,
                    email: entry.querySelector('.teacher-email').value,
                    phone: entry.querySelector('.teacher-phone').value,
                    position: index === 0 ? 'Ketua' : 'Pengiring'
                });
            });
            
            const students = [];
            document.querySelectorAll('.student-entry').forEach((entry, index) => {
                const gender = entry.querySelector('.student-gender').value;
                const category = entry.querySelector('.student-category').value;
                
                // Get the displayed Player ID
                let playerId = entry.querySelector('.student-id').value;
                
                students.push({
                    name: entry.querySelector('.student-name').value,
                    ic: entry.querySelector('.student-ic').value,
                    gender: gender,
                    category: category,
                    playerId: playerId
                });
            });
            
            return { schoolName, teachers, students };
        }

        async function sendToGoogleSheets(regId, data) {
            // POST still uses 'no-cors' mode for fire-and-forget submission, 
            // as this requires specific setup on the server for a full CORS response.
            const payload = {
                action: 'submit', // Explicitly set action for the Google Script
                registrationId: regId,
                schoolName: data.schoolName,
                teachers: data.teachers,
                students: data.students,
                timestamp: new Date().toISOString()
            };

            try {
                await fetch(GOOGLE_SCRIPT_URL_BASE, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                console.log(`Data for ${regId} sent to Google Sheets (opaque response).`);
            } catch (error) {
                console.error('Network Error while sending to Google Sheets:', error);
            }
        }

        function sendWhatsAppNotification(regId, data, isNew) {
            if (!isNew) return;
            
            const categoryCounts = { 'L12': 0, 'P12': 0, 'L15': 0, 'P15': 0, 'L18': 0, 'P18': 0 };
            
            data.students.forEach(student => {
                const genderCode = student.gender === 'Lelaki' ? 'L' : 'P';
                const ageCode = student.category.includes('12') ? '12' : 
                               student.category.includes('15') ? '15' : '18';
                categoryCounts[genderCode + ageCode]++;
            });
            
            const categoryBreakdown = [];
            if (categoryCounts.L12 > 0) categoryBreakdown.push(`L12 - ${categoryCounts.L12} orang`);
            if (categoryCounts.P12 > 0) categoryBreakdown.push(`P12 - ${categoryCounts.P12} orang`);
            if (categoryCounts.L15 > 0) categoryBreakdown.push(`L15 - ${categoryCounts.L15} orang`);
            if (categoryCounts.P15 > 0) categoryBreakdown.push(`P15 - ${categoryCounts.P15} orang`);
            if (categoryCounts.L18 > 0) categoryBreakdown.push(`L18 - ${categoryCounts.L18} orang`);
            if (categoryCounts.P18 > 0) categoryBreakdown.push(`P18 - ${categoryCounts.P18} orang`);
            
            const categoryText = categoryBreakdown.join(', ');
            
            const message = `üì¢ *NOTIFIKASI PENDAFTARAN BERJAYA*%0A%0A` +
                `Assalamualaikum & Salam Sejahtera üëã%0A%0A` +
                `Saya telah berjaya mendaftar pasukan sekolah untuk *PERTANDINGAN CATUR MSSD MUAR* ‚úÖ%0A%0A` +
                `üè´ Nama Sekolah: ${data.schoolName}%0A` +
                `üÜî ID Pendaftaran: ${regId}%0A` +
                `üë©‚Äçüè´ Nama Guru (Ketua): ${data.teachers[0].name}%0A` +
                `üìû No. Telefon Guru: ${data.teachers[0].phone}%0A` +
                `üë• Jumlah Pelajar: ${data.students.length} orang (${categoryText})%0A%0A` +
                `Terima kasih atas sokongan dan penyertaan anda.%0A` +
                `Sebarang maklumat lanjut akan dimaklumkan melalui WhatsApp rasmi MSSD Catur.%0A%0A` +
                `‚ôü "Satukan Pemain, Gilap Bakat, Ukir Kejayaan"`;
            
            const whatsappUrl = `https://wa.me/60182046224?text=${message}`;
            window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
        }

        function handleSubmit(event) {
            event.preventDefault();
            
            const data = collectFormData();
            const isNew = !currentEditId;
            
            // Generate registration ID
            let regId = currentEditId;
            if (!regId && data.students.length > 0) {
                regId = generateRegistrationId(data.students[0].category);
            } else if (!regId) {
                showNotification('‚ùå Sila tambah sekurang-kurangnya satu pelajar.', 'error');
                return;
            }
            
            // Re-generate all player IDs one last time with the final regId before saving
            data.students.forEach((student, index) => {
                student.playerId = generatePlayerId(student.gender, data.schoolName, index, student.category, regId);
            });
            
            // Format timestamp (Kuala Lumpur time)
            const now = new Date().toLocaleString('en-CA', { 
                timeZone: 'Asia/Kuala_Lumpur',
                year: 'numeric',
                month: '2-digit', 
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }).replace(/(\d{4})-(\d{2})-(\d{2}), (\d{2}):(\d{2}):(\d{2})/, '$1-$2-$3T$4:$5:$6+08:00');
            
            // Save to localStorage
            registrations[regId] = {
                ...data,
                registrationId: regId,
                createdAt: registrations[regId]?.createdAt || now,
                updatedAt: now
            };
            
            localStorage.setItem('mssdRegistrations', JSON.stringify(registrations));
            
            sendToGoogleSheets(regId, data);
            
            showNotification(
                isNew 
                    ? `‚úÖ Pendaftaran berjaya! ID Pendaftaran: ${regId}. Sila simpan ID ini untuk tujuan edit.`
                    : `‚úÖ Kemaskini berjaya! ID Pendaftaran: ${regId}`,
                'success'
            );
            
            sendWhatsAppNotification(regId, data, isNew);
            
            resetForm();
            updateDashboard();
        }

        // --- Edit/Search Functions ---

        function handleSearch(event) {
            event.preventDefault();
            
            const regId = document.getElementById('searchRegId').value;
            const password = document.getElementById('searchPassword').value;
            
            const registration = registrations[regId];
            
            const teacherPhone = registration?.teachers[0]?.phone || '';
            const last4Digits = teacherPhone.replace(/\D/g, '').slice(-4);
            
            if (registration && last4Digits === password) {
                loadRegistrationForEdit(regId, registration);
                document.getElementById('searchResult').classList.remove('hidden');
                document.getElementById('searchError').classList.add('hidden');
                
                setTimeout(() => {
                    switchTab('pendaftaran');
                }, 1500);
            } else {
                document.getElementById('searchResult').classList.add('hidden');
                document.getElementById('searchError').classList.remove('hidden');
            }
        }

        function loadRegistrationForEdit(regId, data) {
            currentEditId = regId;
            document.getElementById('editModeIndicator').classList.add('active');
            
            // Reset form structure
            resetForm();
            
            // Load school name
            document.getElementById('schoolName').value = data.schoolName;
            
            // Load teachers
            const teachersContainer = document.getElementById('teachersContainer');
            
            // Add required extra teacher fields
            while (teachersContainer.querySelectorAll('.teacher-entry').length < data.teachers.length) {
                addTeacher();
            }
            
            // Fill teacher data
            data.teachers.forEach((teacher, index) => {
                const entry = teachersContainer.querySelector(`[data-teacher-index="${index}"]`);
                if (entry) {
                    entry.querySelector('.teacher-name').value = teacher.name;
                    entry.querySelector('.teacher-email').value = teacher.email;
                    entry.querySelector('.teacher-phone').value = teacher.phone;
                }
            });
            
            // Load students
            const studentsContainer = document.getElementById('studentsContainer');
            // Remove extra student placeholders
            while (studentsContainer.children.length > 1) {
                studentsContainer.removeChild(studentsContainer.lastChild);
            }
            
            // Add required extra student fields
            for (let i = 1; i < data.students.length; i++) {
                addStudent();
            }
            
            // Fill student data
            data.students.forEach((student, index) => {
                const entry = studentsContainer.querySelector(`[data-student-index="${index}"]`);
                if (entry) {
                    entry.querySelector('.student-name').value = student.name;
                    entry.querySelector('.student-ic').value = student.ic;
                    entry.querySelector('.student-gender').value = student.gender;
                    entry.querySelector('.student-category').value = student.category;
                    
                    // Generate updated player ID based on current registration ID
                    const updatedPlayerId = generatePlayerId(student.gender, data.schoolName, index, student.category, regId);
                    entry.querySelector('.student-id').value = updatedPlayerId;
                }
            });
             updateStudentIds(); // Final update just in case
        }

        function resetForm() {
            currentEditId = null;
            document.getElementById('editModeIndicator').classList.remove('active');
            document.getElementById('registrationForm').reset();
            
            const teachersContainer = document.getElementById('teachersContainer');
            const studentsContainer = document.getElementById('studentsContainer');
            
            // Reset teachers to 2 mandatory fields structure
            teachersContainer.innerHTML = `
                <div class="teacher-entry bg-orange-50 p-4 rounded-lg mb-4" data-teacher-index="0">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-semibold text-orange-700">Guru 1 (Ketua) *</h4>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Nama Guru *</label>
                            <input type="text" required class="teacher-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Nama penuh guru">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Email Guru *</label>
                            <input type="email" required class="teacher-email w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="email@example.com">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Nombor Telefon *</label>
                            <input type="tel" required class="teacher-phone w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="012-345 6789" maxlength="13">
                        </div>
                    </div>
                </div>

                <div class="teacher-entry bg-orange-50 p-4 rounded-lg mb-4" data-teacher-index="1">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-semibold text-orange-700">Guru 2 (Pengiring) *</h4>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Nama Guru *</label>
                            <input type="text" required class="teacher-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Nama penuh guru">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Email Guru *</label>
                            <input type="email" required class="teacher-email w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="email@example.com">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Nombor Telefon *</label>
                            <input type="tel" required class="teacher-phone w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="012-345 6789" maxlength="13">
                        </div>
                    </div>
                </div>
            `;
            
            // Reset students to 1 mandatory field structure
            studentsContainer.innerHTML = `
                <div class="student-entry bg-orange-50 p-4 rounded-lg mb-4" data-student-index="0">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-semibold text-orange-700">Pelajar 1</h4>
                        <button type="button" onclick="removeStudent(0)" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors text-sm">
                            üóëÔ∏è Buang
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Nama Pelajar *</label>
                            <input type="text" required class="student-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Nama penuh pelajar">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Nombor IC *</label>
                            <input type="text" required class="student-ic w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="XXXXXX-XX-XXXX" maxlength="14">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Jantina *</label>
                            <select required class="student-gender w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                <option value="">Pilih Jantina</option>
                                <option value="Lelaki">Lelaki</option>
                                <option value="Perempuan">Perempuan</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Kategori *</label>
                            <select required class="student-category w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                <option value="">Pilih Kategori</option>
                                <option value="Bawah 12 Tahun">Bawah 12 Tahun</option>
                                <option value="Bawah 15 Tahun">Bawah 15 Tahun</option>
                                <option value="Bawah 18 Tahun">Bawah 18 Tahun</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">ID Pemain</label>
                            <input type="text" readonly class="student-id w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100" placeholder="Auto-generated">
                        </div>
                    </div>
                </div>
            `;
            
            // Clear search tab fields/messages
            document.getElementById('searchRegId').value = '';
            document.getElementById('searchPassword').value = '';
            document.getElementById('searchResult').classList.add('hidden');
            document.getElementById('searchError').classList.add('hidden');
        }

        // --- Dashboard Reporting ---
        
        // Function to fetch data from Google Apps Script. 
        // NOTE: Since direct CORS fetch is failing, this function is removed 
        // to prevent the app from crashing. Dashboard will rely solely on localStorage.
        /* async function fetchDashboardData() {
            // ... (Removed problematic fetch logic)
        }
        */

        // Refactored to fetch data asynchronously
        async function updateDashboard() {
            // Display loading indicator briefly, then proceed with local data immediately
            document.getElementById('registrationsList').innerHTML = '<div class="text-center text-gray-500 py-8 text-lg font-semibold text-indigo-700">Memuat data dari storan tempatan...</div>';

            // --- Note: Fetching from Google Sheet API is blocked by CORS. We use local storage (registrations) as the source of truth. ---
            console.error("Dashboard is running on LOCAL DATA ONLY (localStorage). The attempt to fetch live data from Google Sheets failed due to CORS policy.");
            // --- End Note ---
            
            // Allow a brief moment for the loading message to appear before processing local data
            await new Promise(resolve => setTimeout(resolve, 100));

            // --- Dashboard calculation and rendering logic starts here ---
            
            const totalRegs = Object.keys(registrations).length;
            let totalStudents = 0;
            let totalTeachers = 0;
            const schools = new Set();
            
            // Tree diagram counters
            let primarySchoolCount = 0;
            let secondarySchoolCount = 0;
            let primary12Male = 0, primary12Female = 0;
            let secondary15Male = 0, secondary15Female = 0;
            let secondary18Male = 0, secondary18Female = 0;
            
            Object.values(registrations).forEach(reg => {
                totalStudents += reg.students.length;
                totalTeachers += reg.teachers.length;
                schools.add(reg.schoolName);
                
                // Determine school type based on common prefixes
                const schoolName = reg.schoolName.toUpperCase();
                const isPrimary = schoolName.includes('SK') || schoolName.includes('SJKC') || schoolName.includes('SJKT');
                const isSecondary = schoolName.includes('SMK') || schoolName.includes('SMKA');
                
                if (isPrimary) {
                    primarySchoolCount++;
                } else if (isSecondary) {
                    secondarySchoolCount++;
                }
                
                // Count students by category and gender
                reg.students.forEach(student => {
                    const isMale = student.gender === 'Lelaki';
                    
                    if (student.category.includes('12')) {
                        if (isMale) primary12Male++;
                        else primary12Female++;
                    } else if (student.category.includes('15')) {
                        if (isMale) secondary15Male++;
                        else secondary15Female++;
                    } else if (student.category.includes('18')) {
                        if (isMale) secondary18Male++;
                        else secondary18Female++;
                    }
                });
            });
            
            // Update summary cards
            document.getElementById('totalRegistrations').textContent = totalRegs;
            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('totalSchools').textContent = schools.size;
            document.getElementById('totalTeachers').textContent = totalTeachers;
            
            // Update tree diagram
            document.getElementById('treeTotal').textContent = schools.size;
            document.getElementById('primarySchools').textContent = primarySchoolCount;
            document.getElementById('secondarySchools').textContent = secondarySchoolCount;
            document.getElementById('primary12Male').textContent = primary12Male;
            document.getElementById('primary12Female').textContent = primary12Female;
            document.getElementById('secondary15Male').textContent = secondary15Male;
            document.getElementById('secondary15Female').textContent = secondary15Female;
            document.getElementById('secondary18Male').textContent = secondary18Male;
            document.getElementById('secondary18Female').textContent = secondary18Female;
            
            const listContainer = document.getElementById('registrationsList');
            listContainer.innerHTML = '';
            
            if (totalRegs === 0) {
                listContainer.innerHTML = '<div class="text-center text-gray-500 py-8">Tiada pendaftaran lagi.</div>';
                return;
            }
            
            // Sort registrations by latest update time (newest first)
            const sortedRegistrations = Object.entries(registrations).sort(([, a], [, b]) => new Date(b.updatedAt) - new Date(a.updatedAt));
            
            sortedRegistrations.forEach(([regId, data]) => {
                // Generate category summary
                const categorySummary = { 'L12': 0, 'P12': 0, 'L15': 0, 'P15': 0, 'L18': 0, 'P18': 0 };
                data.students.forEach(student => {
                    const genderCode = student.gender === 'Lelaki' ? 'L' : 'P';
                    const ageCode = student.category.includes('12') ? '12' : student.category.includes('15') ? '15' : '18';
                    categorySummary[genderCode + ageCode]++;
                });
                
                const summaryText = Object.entries(categorySummary)
                    .filter(([, count]) => count > 0)
                    .map(([key, count]) => `${key}: ${count}`)
                    .join(' | ');
                
                // Generate teachers list
                const teachersList = data.teachers.map((teacher, index) => 
                    `<div class="text-sm ${index === 0 ? 'font-semibold' : ''}">
                        ${teacher.name} ${index === 0 ? '(Ketua)' : '(Pengiring)'} - ${teacher.phone}
                    </div>`
                ).join('');
                
                // Generate students list
                const studentsList = data.students.map(student => {
                    const genderCode = student.gender === 'Lelaki' ? 'L' : 'P';
                    const ageCode = student.category.includes('12') ? '12' : student.category.includes('15') ? '15' : '18';
                    return `<div class="text-sm flex justify-between">
                        <span>${student.name}</span>
                        <span class="font-medium text-orange-600">${genderCode}${ageCode}</span>
                    </div>`;
                }).join('');

                const card = document.createElement('div');
                card.className = 'bg-gray-50 rounded-lg border border-gray-200';
                card.innerHTML = `
                    <button onclick="toggleSchoolDetails('${regId}')" class="w-full text-left p-4 hover:bg-gray-100 transition-colors rounded-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-xl font-bold text-indigo-900">${data.schoolName}</h3>
                                <p class="text-gray-600 text-sm mt-1">ID: ${regId} | Pelajar: ${data.students.length}</p>
                                <p class="text-gray-500 text-xs mt-1">Dikemaskini: ${new Date(data.updatedAt).toLocaleString('ms-MY', { timeZone: 'Asia/Kuala_Lumpur' })}</p>
                            </div>
                            <div class="text-gray-400">
                                <span id="arrow-${regId}">‚ñº</span>
                            </div>
                        </div>
                    </button>
                    
                    <div id="details-${regId}" class="hidden p-4 pt-0">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-white rounded-lg p-4">
                                <h4 class="font-semibold text-gray-700 mb-3 border-b pb-2">üë®‚Äçüè´ Senarai Guru</h4>
                                <div class="space-y-2 mb-4">
                                    ${teachersList}
                                </div>
                                <div class="bg-orange-50 rounded-lg p-3 mt-3">
                                    <h5 class="font-semibold text-orange-700 text-sm mb-2">Ringkasan Pendaftaran</h5>
                                    <p class="text-xs text-gray-700">Jumlah Pelajar: <span class="font-bold">${data.students.length}</span></p>
                                    <p class="text-xs text-gray-700 mt-1">${summaryText}</p>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg p-4">
                                <h4 class="font-semibold text-gray-700 mb-3 border-b pb-2">üë• Senarai Pelajar</h4>
                                <div class="space-y-2 max-h-48 overflow-y-auto">
                                    ${studentsList}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                listContainer.appendChild(card);
            });
        }

        function toggleSchoolDetails(regId) {
            const detailsDiv = document.getElementById(`details-${regId}`);
            const arrow = document.getElementById(`arrow-${regId}`);
            
            if (detailsDiv.classList.contains('hidden')) {
                detailsDiv.classList.remove('hidden');
                arrow.textContent = '‚ñ≤';
            } else {
                detailsDiv.classList.add('hidden');
                arrow.textContent = '‚ñº';
            }
        }

        // Initialize dashboard state on load
        updateDashboard();
    </script>
</body>
</html>
