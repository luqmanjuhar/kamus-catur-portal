<!doctype html>
<html lang="ms">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Sukan Catur MSSD</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        
        * {
            box-sizing: border-box;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .edit-mode-indicator {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ea580c;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .edit-mode-indicator.active {
            display: block;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gradient-to-br from-orange-50 to-orange-100 min-h-full">
  <div class="edit-mode-indicator" id="editModeIndicator">
   🔄 MOD EDIT AKTIF
  </div>
  <div class="container mx-auto px-4 py-8 max-w-7xl">
   <header class="bg-white rounded-lg shadow-lg p-6 mb-6">
    <h1 class="text-3xl font-bold text-orange-600 text-center">Dashboard Sukan Catur MSSD</h1>
    <p class="text-center text-gray-600 mt-2">Sistem Pendaftaran Kejohanan Catur Peringkat Daerah</p>
   </header>
   <nav class="bg-white rounded-lg shadow-md p-4 mb-6">
    <div class="flex flex-wrap gap-3 justify-center"><button onclick="switchTab('pendaftaran')" class="tab-btn px-6 py-3 rounded-lg font-semibold transition-all bg-orange-600 text-white" data-tab="pendaftaran"> 📝 Pendaftaran Baru </button> <button onclick="switchTab('edit')" class="tab-btn px-6 py-3 rounded-lg font-semibold transition-all bg-gray-200 text-gray-700 hover:bg-gray-300" data-tab="edit"> ✏️ Edit Pendaftaran </button> <button onclick="switchTab('dashboard')" class="tab-btn px-6 py-3 rounded-lg font-semibold transition-all bg-gray-200 text-gray-700 hover:bg-gray-300" data-tab="dashboard"> 📊 Dashboard Pendaftaran </button>
    </div>
   </nav>
   <div id="pendaftaran" class="tab-content active">
    <div class="bg-white rounded-lg shadow-lg p-6">
     <h2 class="text-2xl font-bold text-orange-600 mb-6">Pendaftaran Baru</h2>
     <form id="registrationForm" onsubmit="handleSubmit(event)">
      <section class="mb-8">
       <h3 class="text-xl font-semibold text-orange-600 mb-4 border-b-2 border-orange-300 pb-2">Maklumat Sekolah</h3>
       <div class="mb-4"><label for="schoolName" class="block text-gray-700 font-medium mb-2">Nama Sekolah *</label> <input type="text" id="schoolName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="Contoh: SK Taman Desa">
        <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
         <p class="text-sm text-blue-800"><span class="font-semibold">💡 Tips:</span> Anda boleh gunakan singkatan sahaja:</p>
         <div class="text-xs text-blue-700 mt-1 grid grid-cols-2 gap-2">
          <div>
           • <strong>SK</strong> - Sekolah Kebangsaan
          </div>
          <div>
           • <strong>SMK</strong> - Sekolah Menengah Kebangsaan
          </div>
          <div>
           • <strong>SJKC</strong> - Sekolah Jenis Kebangsaan (Cina)
          </div>
          <div>
           • <strong>SJKT</strong> - Sekolah Jenis Kebangsaan (Tamil)
          </div>
          <div>
           • <strong>SMKA</strong> - Sekolah Menengah Kebangsaan Agama
          </div>
         </div>
        </div>
       </div>
      </section>
      <section class="mb-8">
       <h3 class="text-xl font-semibold text-orange-600 mb-4 border-b-2 border-orange-300 pb-2">Maklumat Guru</h3>
       <div id="teachersContainer">
        <div class="teacher-entry bg-orange-50 p-4 rounded-lg mb-4" data-teacher-index="0">
         <div class="flex justify-between items-center mb-3">
          <h4 class="font-semibold text-orange-700">Guru 1 (Ketua) *</h4>
         </div>
         <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div><label class="block text-gray-700 font-medium mb-2">Nama Guru *</label> <input type="text" required class="teacher-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Nama penuh guru">
          </div>
          <div><label class="block text-gray-700 font-medium mb-2">Email Guru *</label> <input type="email" required class="teacher-email w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="email@example.com">
          </div>
          <div><label class="block text-gray-700 font-medium mb-2">Nombor Telefon *</label> <input type="tel" required class="teacher-phone w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="012-345 6789" maxlength="13">
          </div>
         </div>
        </div>
        <div class="teacher-entry bg-orange-50 p-4 rounded-lg mb-4" data-teacher-index="1">
         <div class="flex justify-between items-center mb-3">
          <h4 class="font-semibold text-orange-700">Guru 2 (Pengiring) *</h4>
         </div>
         <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div><label class="block text-gray-700 font-medium mb-2">Nama Guru *</label> <input type="text" required class="teacher-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Nama penuh guru">
          </div>
          <div><label class="block text-gray-700 font-medium mb-2">Email Guru *</label> <input type="email" required class="teacher-email w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="email@example.com">
          </div>
          <div><label class="block text-gray-700 font-medium mb-2">Nombor Telefon *</label> <input type="tel" required class="teacher-phone w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="012-345 6789" maxlength="13">
          </div>
         </div>
        </div>
       </div><button type="button" onclick="addTeacher()" class="mt-4 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-medium"> ➕ Tambah Guru Pengiring </button>
      </section>
      <section class="mb-8">
       <h3 class="text-xl font-semibold text-orange-600 mb-4 border-b-2 border-orange-300 pb-2">Pendaftaran Pelajar</h3>
       <div id="studentsContainer">
        <div class="student-entry bg-orange-50 p-4 rounded-lg mb-4" data-student-index="0">
         <div class="flex justify-between items-center mb-3">
          <h4 class="font-semibold text-orange-700">Pelajar 1</h4><button type="button" onclick="removeStudent(0)" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors text-sm"> 🗑️ Buang </button>
         </div>
         <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
          <div><label class="block text-gray-700 font-medium mb-2">Nama Pelajar *</label> <input type="text" required class="student-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Nama penuh pelajar">
          </div>
          <div><label class="block text-gray-700 font-medium mb-2">Nombor IC *</label> <input type="text" required class="student-ic w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="XXXXXX-XX-XXXX" maxlength="14">
          </div>
         </div>
         <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div><label class="block text-gray-700 font-medium mb-2">Jantina *</label> <select required class="student-gender w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"> <option value="">Pilih Jantina</option> <option value="Lelaki">Lelaki</option> <option value="Perempuan">Perempuan</option> </select>
          </div>
          <div><label class="block text-gray-700 font-medium mb-2">Kategori *</label> <select required class="student-category w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"> <option value="">Pilih Kategori</option> <option value="Bawah 12 Tahun">Bawah 12 Tahun</option> <option value="Bawah 15 Tahun">Bawah 15 Tahun</option> <option value="Bawah 18 Tahun">Bawah 18 Tahun</option> </select>
          </div>
          <div><label class="block text-gray-700 font-medium mb-2">ID Pemain</label> <input type="text" readonly class="student-id w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100" placeholder="Auto-generated">
          </div>
         </div>
        </div>
       </div><button type="button" onclick="addStudent()" class="mt-4 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-medium"> ➕ Tambah Pelajar </button>
      </section>
      <div class="flex gap-4 justify-end"><button type="button" onclick="resetForm()" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium"> 🔄 Reset </button> <button type="submit" class="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-medium"> 💾 Hantar Pendaftaran </button>
      </div>
     </form>
    </div>
   </div>
   <div id="edit" class="tab-content">
    <div class="bg-white rounded-lg shadow-lg p-6">
     <h2 class="text-2xl font-bold text-orange-600 mb-6">Edit Pendaftaran</h2>
     <form id="searchForm" onsubmit="handleSearch(event)" class="max-w-2xl mx-auto">
      <div class="mb-4"><label for="searchRegId" class="block text-gray-700 font-medium mb-2">ID Pendaftaran *</label> <input type="text" id="searchRegId" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="REG-001-2026">
      </div>
      <div class="mb-6"><label for="searchPassword" class="block text-gray-700 font-medium mb-2">Kata Laluan (4 Digit Terakhir No Telefon Guru Ketua) *</label> <input type="text" id="searchPassword" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="6789" maxlength="4">
      </div><button type="submit" class="w-full px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-medium"> 🔍 Cari Pendaftaran </button>
     </form>
     <div id="searchResult" class="mt-6 hidden">
      <div class="bg-green-50 border border-green-200 rounded-lg p-4">
       <p class="text-green-800 font-medium">✅ Pendaftaran dijumpai! Sila tukar ke tab "Pendaftaran Baru" untuk mengedit.</p>
      </div>
     </div>
     <div id="searchError" class="mt-6 hidden">
      <div class="bg-red-50 border border-red-200 rounded-lg p-4">
       <p class="text-red-800 font-medium">❌ Pendaftaran tidak dijumpai atau kata laluan salah.</p>
      </div>
     </div>
    </div>
   </div>
   <div id="dashboard" class="tab-content">
    <div class="bg-white rounded-lg shadow-lg p-6">
     <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-orange-600">Dashboard Pendaftaran</h2>
      <div class="flex gap-2"><button onclick="showGoogleSheetsChecklist()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium text-sm"> 🔧 Setup Checklist </button> <button onclick="loadFromGoogleSheets()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium text-sm"> 🔄 Segerak dengan Google Sheets </button>
      </div>
     </div><!-- Summary Cards -->
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
      <div class="bg-gradient-to-br from-orange-600 to-orange-700 rounded-lg p-6 text-white">
       <div class="text-3xl font-bold" id="totalRegistrations">
        0
       </div>
       <div class="text-orange-100 mt-2">
        Jumlah Pendaftaran
       </div>
      </div>
      <div class="bg-gradient-to-br from-amber-600 to-amber-700 rounded-lg p-6 text-white">
       <div class="text-3xl font-bold" id="totalStudents">
        0
       </div>
       <div class="text-amber-100 mt-2">
        Jumlah Pelajar
       </div>
      </div>
      <div class="bg-gradient-to-br from-yellow-600 to-yellow-700 rounded-lg p-6 text-white">
       <div class="text-3xl font-bold" id="totalSchools">
        0
       </div>
       <div class="text-yellow-100 mt-2">
        Jumlah Sekolah Layak
       </div>
      </div>
      <div class="bg-gradient-to-br from-red-600 to-red-700 rounded-lg p-6 text-white">
       <div class="text-3xl font-bold" id="totalTeachers">
        0
       </div>
       <div class="text-red-100 mt-2">
        Jumlah Guru
       </div>
      </div>
     </div><!-- Tree Diagram -->
     <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-6 mb-8">
      <h3 class="text-xl font-bold text-indigo-800 mb-6 text-center">📊 Analisis Pendaftaran Mengikut Kategori</h3>
      <div id="treeDiagram" class="space-y-6"><!-- Root Level -->
       <div class="text-center">
        <div class="inline-block bg-indigo-600 text-white px-6 py-3 rounded-lg font-bold text-lg"><span id="treeTotal">0</span> Sekolah Layak Berdaftar
        </div>
        <div class="text-xs text-gray-600 mt-2">
         *Sekolah Rendah (U12) &amp; Sekolah Menengah (U15/U18)
        </div>
       </div><!-- Level 1: School Types -->
       <div class="flex justify-center">
        <div class="w-px h-8 bg-gray-400"></div>
       </div>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-8"><!-- Primary Schools -->
        <div class="text-center">
         <div class="bg-green-500 text-white px-4 py-2 rounded-lg font-semibold mb-4">
          <div class="text-2xl font-bold" id="primarySchools">
           0
          </div>
          <div class="text-sm">
           Sekolah Rendah
          </div>
          <div class="text-xs opacity-90">
           (SK, SJKC, SJKT dengan U12)
          </div>
         </div><!-- Primary Categories -->
         <div class="space-y-3">
          <div class="bg-green-100 border border-green-300 rounded-lg p-3">
           <div class="font-semibold text-green-800 mb-2">
            Bawah 12 Tahun
           </div>
           <div class="grid grid-cols-2 gap-2 text-sm">
            <div class="bg-blue-200 text-blue-800 px-2 py-1 rounded"><span class="font-bold" id="primary12Male">0</span> Lelaki
            </div>
            <div class="bg-pink-200 text-pink-800 px-2 py-1 rounded"><span class="font-bold" id="primary12Female">0</span> Perempuan
            </div>
           </div>
          </div>
         </div>
        </div><!-- Secondary Schools -->
        <div class="text-center">
         <div class="bg-purple-500 text-white px-4 py-2 rounded-lg font-semibold mb-4">
          <div class="text-2xl font-bold" id="secondarySchools">
           0
          </div>
          <div class="text-sm">
           Sekolah Menengah
          </div>
          <div class="text-xs opacity-90">
           (SMK, SMKA dengan U15/U18)
          </div>
         </div><!-- Secondary Categories -->
         <div class="space-y-3">
          <div class="bg-purple-100 border border-purple-300 rounded-lg p-3">
           <div class="font-semibold text-purple-800 mb-2">
            Bawah 15 Tahun
           </div>
           <div class="grid grid-cols-2 gap-2 text-sm">
            <div class="bg-blue-200 text-blue-800 px-2 py-1 rounded"><span class="font-bold" id="secondary15Male">0</span> Lelaki
            </div>
            <div class="bg-pink-200 text-pink-800 px-2 py-1 rounded"><span class="font-bold" id="secondary15Female">0</span> Perempuan
            </div>
           </div>
          </div>
          <div class="bg-purple-100 border border-purple-300 rounded-lg p-3">
           <div class="font-semibold text-purple-800 mb-2">
            Bawah 18 Tahun
           </div>
           <div class="grid grid-cols-2 gap-2 text-sm">
            <div class="bg-blue-200 text-blue-800 px-2 py-1 rounded"><span class="font-bold" id="secondary18Male">0</span> Lelaki
            </div>
            <div class="bg-pink-200 text-pink-800 px-2 py-1 rounded"><span class="font-bold" id="secondary18Female">0</span> Perempuan
            </div>
           </div>
          </div>
         </div>
        </div>
       </div>
      </div>
     </div><!-- Detailed School List -->
     <div class="bg-white rounded-lg border border-gray-200 p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4">📋 Senarai Sekolah Berdaftar</h3>
      <div id="registrationsList" class="space-y-4">
      </div>
     </div>
    </div>
   </div>
  </div><!-- Google Sheets Setup Modal -->
  <div id="setupModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
    <div class="p-6">
     <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-purple-600">🔧 Google Sheets Setup Checklist</h2><button onclick="closeSetupModal()" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
     </div>
     <div class="space-y-6"><!-- Current Configuration -->
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
       <h3 class="text-lg font-semibold text-blue-800 mb-3">📋 Current Configuration</h3>
       <div class="space-y-2 text-sm">
        <div class="flex justify-between"><span class="font-medium">Google Apps Script URL:</span> <span class="font-mono text-xs bg-gray-100 px-2 py-1 rounded" id="currentScriptUrl">Loading...</span>
        </div>
        <div class="flex justify-between"><span class="font-medium">Connection Status:</span> <span id="connectionStatus" class="px-2 py-1 rounded text-xs">Testing...</span>
        </div>
       </div>
      </div><!-- Step-by-Step Setup -->
      <div class="bg-green-50 border border-green-200 rounded-lg p-4">
       <h3 class="text-lg font-semibold text-green-800 mb-4">✅ Setup Steps</h3>
       <div class="space-y-4"><!-- Step 1 -->
        <div class="border-l-4 border-green-500 pl-4">
         <h4 class="font-semibold text-green-700">Step 1: Create Google Spreadsheet</h4>
         <p class="text-sm text-gray-700 mt-1">Create a new Google Spreadsheet with these exact sheet names:</p>
         <ul class="text-xs text-gray-600 mt-2 ml-4 list-disc">
          <li><code>GURU</code> - Teacher information</li>
          <li><code>SEKOLAH</code> - School registration data</li>
          <li><code>PELAJAR</code> - Student information</li>
         </ul>
         <div class="mt-2"><input type="text" id="spreadsheetId" placeholder="Paste your Spreadsheet ID here" class="w-full px-3 py-2 border border-gray-300 rounded text-sm">
          <p class="text-xs text-gray-500 mt-1">Get this from your spreadsheet URL: docs.google.com/spreadsheets/d/<strong>SPREADSHEET_ID</strong>/edit</p>
         </div>
        </div><!-- Step 2 -->
        <div class="border-l-4 border-yellow-500 pl-4">
         <h4 class="font-semibold text-yellow-700">Step 2: Create Google Apps Script</h4>
         <p class="text-sm text-gray-700 mt-1">Go to <a href="https://script.google.com" target="_blank" class="text-blue-600 underline">script.google.com</a> and create a new project</p>
         <div class="bg-gray-100 p-3 rounded mt-2 text-xs font-mono overflow-x-auto">
          <div class="mb-2 font-bold">
           Copy this code to your Apps Script:
          </div>
          <pre id="appsScriptCode">Loading script template...</pre>
         </div>
        </div><!-- Step 3 -->
        <div class="border-l-4 border-blue-500 pl-4">
         <h4 class="font-semibold text-blue-700">Step 3: Deploy as Web App</h4>
         <ol class="text-sm text-gray-700 mt-1 ml-4 list-decimal space-y-1">
          <li>Click "Deploy" → "New deployment"</li>
          <li>Choose type: "Web app"</li>
          <li>Execute as: "Me"</li>
          <li>Who has access: "Anyone"</li>
          <li>Click "Deploy" and copy the Web App URL</li>
         </ol>
         <div class="mt-2"><input type="text" id="webAppUrl" placeholder="Paste your Web App URL here" class="w-full px-3 py-2 border border-gray-300 rounded text-sm">
         </div>
        </div><!-- Step 4 -->
        <div class="border-l-4 border-purple-500 pl-4">
         <h4 class="font-semibold text-purple-700">Step 4: Test Connection</h4>
         <p class="text-sm text-gray-700 mt-1">Click the button below to test your setup:</p><button onclick="testGoogleSheetsConnection()" class="mt-2 px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm"> 🧪 Test Connection </button>
         <div id="testResult" class="mt-2 text-sm"></div>
        </div>
       </div>
      </div><!-- Troubleshooting -->
      <div class="bg-red-50 border border-red-200 rounded-lg p-4">
       <h3 class="text-lg font-semibold text-red-800 mb-3">🚨 Common Issues</h3>
       <div class="space-y-2 text-sm text-gray-700">
        <div>
         <strong>CORS Error:</strong> Make sure your Apps Script is deployed as "Anyone" can access
        </div>
        <div>
         <strong>404 Error:</strong> Check your Web App URL is correct and deployment is active
        </div>
        <div>
         <strong>Permission Error:</strong> Ensure the script has permission to access your spreadsheet
        </div>
        <div>
         <strong>Timeout:</strong> Your script might be taking too long - check for infinite loops
        </div>
       </div>
      </div><!-- Save Configuration -->
      <div class="flex justify-end gap-3"><button onclick="closeSetupModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"> Cancel </button> <button onclick="saveGoogleSheetsConfig()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"> 💾 Save Configuration </button>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
        let registrations = {};
        let currentEditId = null;
        let teacherCount = 2;
        let studentCount = 1;
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwWNUtbfV4VKvsmbGyD4RWNUEVFdKwkk8bOsXuPdBkfgJ_-QFySGx0uJmfsBW5087mlPQ/exec';
        let isLoadingFromSheets = false;

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-orange-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.remove('bg-gray-200', 'text-gray-700');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('bg-orange-600', 'text-white');
            
            if (tabName === 'dashboard') {
                updateDashboard();
                // Auto-sync with Google Sheets when dashboard is opened
                loadFromGoogleSheets();
            }
        }

        function formatSchoolName(name) {
            name = name.toUpperCase();
            name = name.replace(/SEKOLAH KEBANGSAAN/gi, 'SK');
            name = name.replace(/SEKOLAH MENENGAH KEBANGSAAN AGAMA/gi, 'SMKA');
            name = name.replace(/SEKOLAH MENENGAH KEBANGSAAN/gi, 'SMK');
            name = name.replace(/SEKOLAH JENIS KEBANGSAAN \(CINA\)/gi, 'SJKC');
            name = name.replace(/SEKOLAH JENIS KEBANGSAAN \(TAMIL\)/gi, 'SJKT');
            name = name.replace(/SEKOLAH JENIS KEBANGSAAN/gi, 'SJK');
            return name;
        }

        function formatPhoneNumber(phone) {
            phone = phone.replace(/\D/g, '');
            if (phone.length >= 11) {
                return phone.substring(0, 3) + '-' + phone.substring(3, 6) + ' ' + phone.substring(6, 11);
            } else if (phone.length >= 10) {
                return phone.substring(0, 3) + '-' + phone.substring(3, 6) + ' ' + phone.substring(6, 10);
            }
            return phone;
        }

        function formatIC(ic) {
            ic = ic.replace(/\D/g, '');
            if (ic.length >= 12) {
                return ic.substring(0, 6) + '-' + ic.substring(6, 8) + '-' + ic.substring(8, 12);
            }
            return ic;
        }

        document.getElementById('schoolName').addEventListener('input', function(e) {
            e.target.value = formatSchoolName(e.target.value);
        });

        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('teacher-name') || e.target.classList.contains('student-name')) {
                e.target.value = e.target.value.toUpperCase();
            }
            
            if (e.target.classList.contains('teacher-phone')) {
                e.target.value = formatPhoneNumber(e.target.value);
            }
            
            if (e.target.classList.contains('student-ic')) {
                e.target.value = formatIC(e.target.value);
            }
            
            if (e.target.classList.contains('student-gender') || e.target.classList.contains('student-category')) {
                updateStudentIds();
            }
        });

        function generatePlayerId(gender, schoolName, studentIndex, category, regId) {
            const year = new Date().getFullYear().toString().slice(-2);
            
            // Category code based on age group
            let categoryCode = '15'; // default
            if (category.includes('12')) {
                categoryCode = '12';
            } else if (category.includes('15')) {
                categoryCode = '15';
            } else if (category.includes('18')) {
                categoryCode = '18';
            }
            
            // Gender code
            const genderCode = gender === 'Lelaki' ? '01' : '02';
            
            // School number from registration ID (last 2 digits)
            const schoolNo = regId ? regId.split('-').pop().padStart(2, '0') : '00';
            
            // Player number for this registration (2 digits)
            const playerCount = String(studentIndex + 1).padStart(2, '0');
            
            return `${year}${categoryCode}${genderCode}${schoolNo}${playerCount}`;
        }

        function hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash;
        }

        function updateStudentIds() {
            const schoolName = document.getElementById('schoolName').value;
            const students = document.querySelectorAll('.student-entry');
            
            // Get the first student's category to generate registration ID
            const firstStudent = students[0];
            if (firstStudent) {
                const firstCategory = firstStudent.querySelector('.student-category').value;
                if (firstCategory) {
                    const tempRegId = generateRegistrationId(firstCategory);
                    
                    students.forEach((student, index) => {
                        const gender = student.querySelector('.student-gender').value;
                        const category = student.querySelector('.student-category').value;
                        const idField = student.querySelector('.student-id');
                        
                        if (gender && schoolName && category) {
                            idField.value = generatePlayerId(gender, schoolName, index, category, tempRegId);
                        }
                    });
                }
            }
        }

        function addTeacher() {
            const container = document.getElementById('teachersContainer');
            const newTeacher = document.createElement('div');
            newTeacher.className = 'teacher-entry bg-orange-50 p-4 rounded-lg mb-4';
            newTeacher.setAttribute('data-teacher-index', teacherCount);
            
            newTeacher.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-semibold text-orange-700">Guru ${teacherCount + 1} (Pengiring)</h4>
                    <button type="button" onclick="removeTeacher(${teacherCount})" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors text-sm">
                        🗑️ Buang
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Nama Guru *</label>
                        <input type="text" required class="teacher-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Nama penuh guru">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Email Guru *</label>
                        <input type="email" required class="teacher-email w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="email@example.com">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Nombor Telefon *</label>
                        <input type="tel" required class="teacher-phone w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="012-345 6789" maxlength="13">
                    </div>
                </div>
            `;
            
            container.appendChild(newTeacher);
            teacherCount++;
        }

        function removeTeacher(index) {
            const teachers = document.querySelectorAll('.teacher-entry');
            if (teachers.length > 2) {
                const teacher = document.querySelector(`[data-teacher-index="${index}"]`);
                teacher.remove();
            } else {
                showNotification('Minimum 2 guru diperlukan!', 'error');
            }
        }

        function addStudent() {
            const container = document.getElementById('studentsContainer');
            const newStudent = document.createElement('div');
            newStudent.className = 'student-entry bg-orange-50 p-4 rounded-lg mb-4';
            newStudent.setAttribute('data-student-index', studentCount);
            
            newStudent.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-semibold text-orange-700">Pelajar ${studentCount + 1}</h4>
                    <button type="button" onclick="removeStudent(${studentCount})" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors text-sm">
                        🗑️ Buang
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Nama Pelajar *</label>
                        <input type="text" required class="student-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Nama penuh pelajar">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Nombor IC *</label>
                        <input type="text" required class="student-ic w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="XXXXXX-XX-XXXX" maxlength="14">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Jantina *</label>
                        <select required class="student-gender w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                            <option value="">Pilih Jantina</option>
                            <option value="Lelaki">Lelaki</option>
                            <option value="Perempuan">Perempuan</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Kategori *</label>
                        <select required class="student-category w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                            <option value="">Pilih Kategori</option>
                            <option value="Bawah 12 Tahun">Bawah 12 Tahun</option>
                            <option value="Bawah 15 Tahun">Bawah 15 Tahun</option>
                            <option value="Bawah 18 Tahun">Bawah 18 Tahun</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">ID Pemain</label>
                        <input type="text" readonly class="student-id w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100" placeholder="Auto-generated">
                    </div>
                </div>
            `;
            
            container.appendChild(newStudent);
            studentCount++;
            updateStudentIds();
        }

        function removeStudent(index) {
            const student = document.querySelector(`[data-student-index="${index}"]`);
            if (student) {
                student.remove();
                updateStudentIds();
            }
        }

        function generateRegistrationId(category) {
            // Count existing registrations by category
            let categoryCount = 0;
            Object.values(registrations).forEach(reg => {
                const hasCategory = reg.students.some(student => student.category === category);
                if (hasCategory) {
                    categoryCount++;
                }
            });
            
            // Category code: 01 for Bawah 12, 02 for Bawah 15 & 18
            const categoryCode = category.includes('12') ? '01' : '02';
            
            // Sequential count for this category
            const count = String(categoryCount + 1).padStart(2, '0');
            
            return `MSSD-${categoryCode}-${count}`;
        }

        function collectFormData() {
            const schoolName = document.getElementById('schoolName').value;
            
            const teachers = [];
            document.querySelectorAll('.teacher-entry').forEach((entry, index) => {
                teachers.push({
                    name: entry.querySelector('.teacher-name').value,
                    email: entry.querySelector('.teacher-email').value,
                    phone: entry.querySelector('.teacher-phone').value,
                    position: index === 0 ? 'Ketua' : 'Pengiring'
                });
            });
            
            const students = [];
            document.querySelectorAll('.student-entry').forEach((entry, index) => {
                const gender = entry.querySelector('.student-gender').value;
                const category = entry.querySelector('.student-category').value;
                
                // Generate player ID with proper registration ID
                let playerId = entry.querySelector('.student-id').value;
                if (gender && category && schoolName) {
                    const tempRegId = generateRegistrationId(category);
                    playerId = generatePlayerId(gender, schoolName, index, category, tempRegId);
                }
                
                students.push({
                    name: entry.querySelector('.student-name').value,
                    ic: entry.querySelector('.student-ic').value,
                    gender: gender,
                    category: category,
                    playerId: playerId
                });
            });
            
            return { schoolName, teachers, students };
        }

        async function sendToGoogleSheets(regId, data) {
            if (!GOOGLE_SCRIPT_URL) {
                return;
            }
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: currentEditId ? 'update' : 'submit',
                        registrationId: regId,
                        schoolName: data.schoolName,
                        teachers: data.teachers,
                        students: data.students,
                        timestamp: new Date().toISOString()
                    })
                });
            } catch (error) {
                console.error('Error sending to Google Sheets:', error);
            }
        }

        async function loadFromGoogleSheets() {
            if (!GOOGLE_SCRIPT_URL || isLoadingFromSheets) {
                console.log('Sync skipped - already loading or no URL');
                return;
            }
            
            console.log('🔄 Starting Google Sheets sync...');
            isLoadingFromSheets = true;
            showSyncStatus('🔄 Menyegerak dengan Google Sheets...', 'info');
            
            try {
                // Use JSONP approach for no-cors requests
                const callbackName = 'googleSheetsCallback_' + Date.now();
                console.log('📡 Creating JSONP request with callback:', callbackName);
                
                // Create a promise that resolves when callback is called
                const dataPromise = new Promise((resolve, reject) => {
                    // Set up callback function
                    window[callbackName] = function(data) {
                        console.log('📥 Received data from Google Sheets:', data);
                        resolve(data);
                        // Clean up
                        delete window[callbackName];
                        if (script.parentNode) {
                            document.head.removeChild(script);
                        }
                    };
                    
                    // Create script element for JSONP
                    const script = document.createElement('script');
                    const requestUrl = `${GOOGLE_SCRIPT_URL}?action=load&callback=${callbackName}`;
                    console.log('🌐 Request URL:', requestUrl);
                    script.src = requestUrl;
                    
                    script.onerror = (error) => {
                        console.error('❌ Script loading failed:', error);
                        reject(new Error('Failed to load script'));
                        delete window[callbackName];
                        if (script.parentNode) {
                            document.head.removeChild(script);
                        }
                    };
                    
                    script.onload = () => {
                        console.log('✅ Script loaded successfully');
                    };
                    
                    document.head.appendChild(script);
                    
                    // Timeout after 15 seconds (increased from 10)
                    setTimeout(() => {
                        if (window[callbackName]) {
                            console.log('⏰ Request timeout after 15 seconds');
                            reject(new Error('Request timeout'));
                            delete window[callbackName];
                            if (script.parentNode) {
                                document.head.removeChild(script);
                            }
                        }
                    }, 15000);
                });
                
                const data = await dataPromise;
                console.log('📊 Processing received data...');
                
                if (data && typeof data === 'object') {
                    if (data.error) {
                        console.error('❌ Server returned error:', data.error);
                        showSyncStatus('❌ Ralat dari server: ' + data.error, 'error');
                        return;
                    }
                    
                    if (data.registrations && typeof data.registrations === 'object') {
                        console.log('✅ Valid registrations data received:', Object.keys(data.registrations).length, 'entries');
                        
                        // Replace local data with Google Sheets data (no local storage)
                        registrations = data.registrations;
                        
                        // Force update dashboard
                        updateDashboard();
                        
                        const sheetsCount = Object.keys(data.registrations).length;
                        showSyncStatus(`✅ Segerak berjaya! ${sheetsCount} pendaftaran dimuat`, 'success');
                    } else {
                        console.log('ℹ️ No registrations data in response');
                        showSyncStatus('ℹ️ Tiada data pendaftaran dari server', 'info');
                    }
                } else {
                    console.log('⚠️ Invalid or empty response from server');
                    showSyncStatus('⚠️ Respons tidak sah dari server', 'warning');
                }
            } catch (error) {
                console.error('❌ Sync error:', error);
                showSyncStatus('❌ Gagal segerak: ' + error.message, 'error');
            } finally {
                isLoadingFromSheets = false;
                console.log('🏁 Sync process completed');
            }
        }

        async function searchRegistrationOnline(regId, password) {
            if (!GOOGLE_SCRIPT_URL) {
                return { found: false, error: 'No Google Sheets URL configured' };
            }
            
            try {
                const callbackName = 'searchCallback_' + Date.now();
                
                const dataPromise = new Promise((resolve, reject) => {
                    window[callbackName] = function(data) {
                        resolve(data);
                        delete window[callbackName];
                        if (script.parentNode) {
                            document.head.removeChild(script);
                        }
                    };
                    
                    const script = document.createElement('script');
                    const requestUrl = `${GOOGLE_SCRIPT_URL}?action=search&regId=${encodeURIComponent(regId)}&password=${encodeURIComponent(password)}&callback=${callbackName}`;
                    script.src = requestUrl;
                    
                    script.onerror = (error) => {
                        reject(new Error('Failed to load script'));
                        delete window[callbackName];
                        if (script.parentNode) {
                            document.head.removeChild(script);
                        }
                    };
                    
                    document.head.appendChild(script);
                    
                    setTimeout(() => {
                        if (window[callbackName]) {
                            reject(new Error('Request timeout'));
                            delete window[callbackName];
                            if (script.parentNode) {
                                document.head.removeChild(script);
                            }
                        }
                    }, 10000);
                });
                
                return await dataPromise;
                
            } catch (error) {
                console.error('Error searching registration:', error);
                return { found: false, error: error.message };
            }
        }

        function sendWhatsAppNotification(regId, data, isNew) {
            if (!isNew) return;
            
            const categoryCounts = {
                'L12': 0, 'P12': 0,
                'L15': 0, 'P15': 0,
                'L18': 0, 'P18': 0
            };
            
            data.students.forEach(student => {
                const genderCode = student.gender === 'Lelaki' ? 'L' : 'P';
                const ageCode = student.category.includes('12') ? '12' : 
                               student.category.includes('15') ? '15' : '18';
                categoryCounts[genderCode + ageCode]++;
            });
            
            // Generate category breakdown text
            const categoryBreakdown = [];
            if (categoryCounts.L12 > 0) categoryBreakdown.push(`L12 - ${categoryCounts.L12} orang`);
            if (categoryCounts.P12 > 0) categoryBreakdown.push(`P12 - ${categoryCounts.P12} orang`);
            if (categoryCounts.L15 > 0) categoryBreakdown.push(`L15 - ${categoryCounts.L15} orang`);
            if (categoryCounts.P15 > 0) categoryBreakdown.push(`P15 - ${categoryCounts.P15} orang`);
            if (categoryCounts.L18 > 0) categoryBreakdown.push(`L18 - ${categoryCounts.L18} orang`);
            if (categoryCounts.P18 > 0) categoryBreakdown.push(`P18 - ${categoryCounts.P18} orang`);
            
            const categoryText = categoryBreakdown.join(', ');
            
            const message = `📢 *NOTIFIKASI PENDAFTARAN BERJAYA*%0A%0A` +
                `Assalamualaikum & Salam Sejahtera 👋%0A%0A` +
                `Saya telah berjaya mendaftar pasukan sekolah untuk *PERTANDINGAN CATUR MSSD MUAR* ✅%0A%0A` +
                `🏫 Nama Sekolah: ${data.schoolName}%0A` +
                `🆔 ID Pendaftaran: ${regId}%0A` +
                `👩‍🏫 Nama Guru (Ketua): ${data.teachers[0].name}%0A` +
                `📞 No. Telefon Guru: ${data.teachers[0].phone}%0A` +
                `👥 Jumlah Pelajar: ${data.students.length} orang (${categoryText})%0A%0A` +
                `Terima kasih atas sokongan dan penyertaan anda.%0A` +
                `Sebarang maklumat lanjut akan dimaklumkan melalui WhatsApp rasmi MSSD Catur.%0A%0A` +
                `♟ "Satukan Pemain, Gilap Bakat, Ukir Kejayaan"`;
            
            const whatsappUrl = `https://wa.me/60182046224?text=${message}`;
            window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
        }

        function handleSubmit(event) {
            event.preventDefault();
            
            const data = collectFormData();
            const isNew = !currentEditId;
            
            // Generate registration ID based on first student's category
            let regId = currentEditId;
            if (!regId && data.students.length > 0) {
                regId = generateRegistrationId(data.students[0].category);
            }
            
            sendToGoogleSheets(regId, data);
            
            showNotification(
                isNew 
                    ? `✅ Pendaftaran berjaya! ID Pendaftaran: ${regId}. Sila simpan ID ini untuk tujuan edit.`
                    : `✅ Kemaskini berjaya! ID Pendaftaran: ${regId}`,
                'success'
            );
            
            sendWhatsAppNotification(regId, data, isNew);
            
            resetForm();
            
            // Refresh data from Google Sheets
            setTimeout(() => {
                loadFromGoogleSheets();
            }, 2000);
        }

        async function handleSearch(event) {
            event.preventDefault();
            
            const regId = document.getElementById('searchRegId').value;
            const password = document.getElementById('searchPassword').value;
            
            showSyncStatus('🔍 Mencari pendaftaran...', 'info');
            
            const result = await searchRegistrationOnline(regId, password);
            
            if (result.found && result.registration) {
                loadRegistrationForEdit(regId, result.registration);
                document.getElementById('searchResult').classList.remove('hidden');
                document.getElementById('searchError').classList.add('hidden');
                showSyncStatus('✅ Pendaftaran dijumpai!', 'success');
                
                setTimeout(() => {
                    switchTab('pendaftaran');
                }, 1500);
            } else {
                document.getElementById('searchResult').classList.add('hidden');
                document.getElementById('searchError').classList.remove('hidden');
                showSyncStatus('❌ Pendaftaran tidak dijumpai', 'error');
            }
        }

        function loadRegistrationForEdit(regId, data) {
            currentEditId = regId;
            document.getElementById('editModeIndicator').classList.add('active');
            
            // Reset form first
            resetForm();
            
            // Load school name
            document.getElementById('schoolName').value = data.schoolName;
            
            // Load teachers
            const teachersContainer = document.getElementById('teachersContainer');
            const existingTeachers = teachersContainer.querySelectorAll('.teacher-entry');
            
            // Add additional teachers if needed
            while (existingTeachers.length < data.teachers.length) {
                addTeacher();
            }
            
            // Fill teacher data
            data.teachers.forEach((teacher, index) => {
                const entries = teachersContainer.querySelectorAll('.teacher-entry');
                const entry = entries[index];
                if (entry) {
                    entry.querySelector('.teacher-name').value = teacher.name;
                    entry.querySelector('.teacher-email').value = teacher.email;
                    entry.querySelector('.teacher-phone').value = teacher.phone;
                }
            });
            
            // Load students
            const studentsContainer = document.getElementById('studentsContainer');
            const existingStudents = studentsContainer.querySelectorAll('.student-entry');
            
            // Remove existing students except first one
            existingStudents.forEach((student, index) => {
                if (index > 0) {
                    student.remove();
                }
            });
            
            // Add students as needed
            while (studentsContainer.querySelectorAll('.student-entry').length < data.students.length) {
                addStudent();
            }
            
            // Fill student data
            data.students.forEach((student, index) => {
                const entries = studentsContainer.querySelectorAll('.student-entry');
                const entry = entries[index];
                if (entry) {
                    entry.querySelector('.student-name').value = student.name;
                    entry.querySelector('.student-ic').value = student.ic;
                    entry.querySelector('.student-gender').value = student.gender;
                    entry.querySelector('.student-category').value = student.category;
                    
                    // Use existing player ID or generate new one
                    const playerId = student.playerId || generatePlayerId(student.gender, data.schoolName, index, student.category, regId);
                    entry.querySelector('.student-id').value = playerId;
                }
            });
        }

        function resetForm() {
            currentEditId = null;
            document.getElementById('editModeIndicator').classList.remove('active');
            document.getElementById('registrationForm').reset();
            
            const teachersContainer = document.getElementById('teachersContainer');
            const studentsContainer = document.getElementById('studentsContainer');
            
            teachersContainer.innerHTML = `
                <div class="teacher-entry bg-orange-50 p-4 rounded-lg mb-4" data-teacher-index="0">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-semibold text-orange-700">Guru 1 (Ketua) *</h4>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Nama Guru *</label>
                            <input type="text" required class="teacher-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Nama penuh guru">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Email Guru *</label>
                            <input type="email" required class="teacher-email w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="email@example.com">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Nombor Telefon *</label>
                            <input type="tel" required class="teacher-phone w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="012-345 6789" maxlength="13">
                        </div>
                    </div>
                </div>

                <div class="teacher-entry bg-orange-50 p-4 rounded-lg mb-4" data-teacher-index="1">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-semibold text-orange-700">Guru 2 (Pengiring) *</h4>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Nama Guru *</label>
                            <input type="text" required class="teacher-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Nama penuh guru">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Email Guru *</label>
                            <input type="email" required class="teacher-email w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="email@example.com">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Nombor Telefon *</label>
                            <input type="tel" required class="teacher-phone w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="012-345 6789" maxlength="13">
                        </div>
                    </div>
                </div>
            `;
            
            studentsContainer.innerHTML = `
                <div class="student-entry bg-orange-50 p-4 rounded-lg mb-4" data-student-index="0">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-semibold text-orange-700">Pelajar 1</h4>
                        <button type="button" onclick="removeStudent(0)" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors text-sm">
                            🗑️ Buang
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Nama Pelajar *</label>
                            <input type="text" required class="student-name w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Nama penuh pelajar">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Nombor IC *</label>
                            <input type="text" required class="student-ic w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="XXXXXX-XX-XXXX" maxlength="14">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Jantina *</label>
                            <select required class="student-gender w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                <option value="">Pilih Jantina</option>
                                <option value="Lelaki">Lelaki</option>
                                <option value="Perempuan">Perempuan</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Kategori *</label>
                            <select required class="student-category w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                <option value="">Pilih Kategori</option>
                                <option value="Bawah 12 Tahun">Bawah 12 Tahun</option>
                                <option value="Bawah 15 Tahun">Bawah 15 Tahun</option>
                                <option value="Bawah 18 Tahun">Bawah 18 Tahun</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">ID Pemain</label>
                            <input type="text" readonly class="student-id w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100" placeholder="Auto-generated">
                        </div>
                    </div>
                </div>
            `;
            
            teacherCount = 2;
            studentCount = 1;
        }

        function updateDashboard() {
            const totalRegs = Object.keys(registrations).length;
            let totalStudents = 0;
            let totalTeachers = 0;
            
            // Track schools by their valid categories
            const primarySchools = new Set(); // Schools with U12 students
            const secondarySchools = new Set(); // Schools with U15/U18 students
            const allSchools = new Set(); // All registered schools
            
            // Tree diagram counters
            let primarySchoolCount = 0;
            let secondarySchoolCount = 0;
            let primary12Male = 0, primary12Female = 0;
            let secondary15Male = 0, secondary15Female = 0;
            let secondary18Male = 0, secondary18Female = 0;
            
            Object.values(registrations).forEach(reg => {
                totalStudents += reg.students.length;
                totalTeachers += reg.teachers.length;
                allSchools.add(reg.schoolName);
                
                // Determine school type based on name
                const schoolName = reg.schoolName.toUpperCase();
                const isPrimarySchool = schoolName.includes('SK') || schoolName.includes('SJKC') || schoolName.includes('SJKT');
                const isSecondarySchool = schoolName.includes('SMK') || schoolName.includes('SMKA');
                
                // Check what categories this school has registered
                let hasU12 = false;
                let hasU15 = false;
                let hasU18 = false;
                
                // Count students by category and gender
                reg.students.forEach(student => {
                    const isMale = student.gender === 'Lelaki';
                    
                    if (student.category.includes('12')) {
                        hasU12 = true;
                        if (isMale) primary12Male++;
                        else primary12Female++;
                    } else if (student.category.includes('15')) {
                        hasU15 = true;
                        if (isMale) secondary15Male++;
                        else secondary15Female++;
                    } else if (student.category.includes('18')) {
                        hasU18 = true;
                        if (isMale) secondary18Male++;
                        else secondary18Female++;
                    }
                });
                
                // Count schools based on categories they register for
                // Primary schools (RENDAH) - any school that registers U12 students
                if (hasU12) {
                    primarySchools.add(reg.schoolName);
                }
                
                // Secondary schools (MENENGAH) - any school that registers U15 or U18 students
                if (hasU15 || hasU18) {
                    secondarySchools.add(reg.schoolName);
                }
            });
            
            primarySchoolCount = primarySchools.size;
            secondarySchoolCount = secondarySchools.size;
            
            // Calculate total valid schools (primary with U12 + secondary with U15/U18)
            const totalValidSchools = primarySchoolCount + secondarySchoolCount;
            
            // Update summary cards
            document.getElementById('totalRegistrations').textContent = totalRegs;
            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('totalSchools').textContent = totalValidSchools;
            document.getElementById('totalTeachers').textContent = totalTeachers;
            
            // Update tree diagram
            document.getElementById('treeTotal').textContent = totalValidSchools;
            document.getElementById('primarySchools').textContent = primarySchoolCount;
            document.getElementById('secondarySchools').textContent = secondarySchoolCount;
            document.getElementById('primary12Male').textContent = primary12Male;
            document.getElementById('primary12Female').textContent = primary12Female;
            document.getElementById('secondary15Male').textContent = secondary15Male;
            document.getElementById('secondary15Female').textContent = secondary15Female;
            document.getElementById('secondary18Male').textContent = secondary18Male;
            document.getElementById('secondary18Female').textContent = secondary18Female;
            
            const listContainer = document.getElementById('registrationsList');
            listContainer.innerHTML = '';
            
            if (totalRegs === 0) {
                listContainer.innerHTML = '<div class="text-center text-gray-500 py-8">Tiada pendaftaran lagi.</div>';
                return;
            }
            
            Object.entries(registrations).forEach(([regId, data]) => {
                // Generate category summary
                const categorySummary = {
                    'L12': 0, 'P12': 0,
                    'L15': 0, 'P15': 0,
                    'L18': 0, 'P18': 0
                };
                
                data.students.forEach(student => {
                    const genderCode = student.gender === 'Lelaki' ? 'L' : 'P';
                    const ageCode = student.category.includes('12') ? '12' : 
                                   student.category.includes('15') ? '15' : '18';
                    categorySummary[genderCode + ageCode]++;
                });
                
                const summaryText = Object.entries(categorySummary)
                    .filter(([key, count]) => count > 0)
                    .map(([key, count]) => `${key}: ${count}`)
                    .join(' | ');
                
                // Generate teachers list
                const teachersList = data.teachers.map((teacher, index) => 
                    `<div class="text-sm ${index === 0 ? 'font-semibold' : ''}">
                        ${teacher.name} ${index === 0 ? '(Ketua)' : '(Pengiring)'} - ${teacher.phone}
                    </div>`
                ).join('');
                
                // Generate students list
                const studentsList = data.students.map(student => {
                    const genderCode = student.gender === 'Lelaki' ? 'L' : 'P';
                    const ageCode = student.category.includes('12') ? '12' : 
                                   student.category.includes('15') ? '15' : '18';
                    return `<div class="text-sm flex justify-between">
                        <span>${student.name}</span>
                        <span class="font-medium text-orange-600">${genderCode}${ageCode}</span>
                    </div>`;
                }).join('');

                const card = document.createElement('div');
                card.className = 'bg-gray-50 rounded-lg border border-gray-200';
                card.innerHTML = `
                    <button onclick="toggleSchoolDetails('${regId}')" class="w-full text-left p-4 hover:bg-gray-100 transition-colors rounded-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-xl font-bold text-indigo-900">${data.schoolName}</h3>
                                <p class="text-gray-600 text-sm mt-1">ID: ${regId} | Pelajar: ${data.students.length}</p>
                                <p class="text-gray-500 text-xs mt-1">Didaftar: ${new Date(data.createdAt).toLocaleString('ms-MY', { timeZone: 'Asia/Kuala_Lumpur' })}</p>
                            </div>
                            <div class="text-gray-400">
                                <span id="arrow-${regId}">▼</span>
                            </div>
                        </div>
                    </button>
                    
                    <div id="details-${regId}" class="hidden p-4 pt-0">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-white rounded-lg p-4">
                                <h4 class="font-semibold text-gray-700 mb-3 border-b pb-2">👨‍🏫 Senarai Guru</h4>
                                <div class="space-y-2 mb-4">
                                    ${teachersList}
                                </div>
                                <div class="bg-orange-50 rounded-lg p-3 mt-3">
                                    <h5 class="font-semibold text-orange-700 text-sm mb-2">Ringkasan Pendaftaran</h5>
                                    <p class="text-xs text-gray-700">Jumlah Pelajar: <span class="font-bold">${data.students.length}</span></p>
                                    <p class="text-xs text-gray-700 mt-1">${summaryText}</p>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg p-4">
                                <h4 class="font-semibold text-gray-700 mb-3 border-b pb-2">👥 Senarai Pelajar</h4>
                                <div class="space-y-2 max-h-48 overflow-y-auto">
                                    ${studentsList}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                listContainer.appendChild(card);
            });
        }

        function toggleSchoolDetails(regId) {
            const detailsDiv = document.getElementById(`details-${regId}`);
            const arrow = document.getElementById(`arrow-${regId}`);
            
            if (detailsDiv.classList.contains('hidden')) {
                detailsDiv.classList.remove('hidden');
                arrow.textContent = '▲';
            } else {
                detailsDiv.classList.add('hidden');
                arrow.textContent = '▼';
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-20 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } text-white max-w-md`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        function showSyncStatus(message, type) {
            // Remove existing sync status
            const existingStatus = document.getElementById('syncStatus');
            if (existingStatus) {
                existingStatus.remove();
            }
            
            const syncStatus = document.createElement('div');
            syncStatus.id = 'syncStatus';
            syncStatus.className = `fixed bottom-4 right-4 p-3 rounded-lg shadow-lg z-50 text-sm max-w-xs ${
                type === 'success' ? 'bg-green-500 text-white' : 
                type === 'warning' ? 'bg-yellow-500 text-black' : 
                type === 'error' ? 'bg-red-500 text-white' :
                type === 'info' ? 'bg-blue-500 text-white' : 'bg-gray-500 text-white'
            }`;
            syncStatus.textContent = message;
            
            document.body.appendChild(syncStatus);
            
            // Keep loading messages longer, others shorter
            const timeout = type === 'info' ? 5000 : 3000;
            setTimeout(() => {
                if (syncStatus && syncStatus.parentNode) {
                    syncStatus.remove();
                }
            }, timeout);
        }

        // Load data on page load
        loadFromGoogleSheets();
        
        // Auto-sync every 30 seconds when dashboard is active
        setInterval(() => {
            const currentTab = document.querySelector('.tab-content.active');
            if (currentTab && currentTab.id === 'dashboard') {
                loadFromGoogleSheets();
            }
        }, 30000);

        // Google Sheets Setup Functions
        function showGoogleSheetsChecklist() {
            document.getElementById('setupModal').classList.remove('hidden');
            
            // Show current configuration
            document.getElementById('currentScriptUrl').textContent = GOOGLE_SCRIPT_URL || 'Not configured';
            
            // Load saved configuration
            const savedSpreadsheetId = localStorage.getItem('spreadsheetId');
            const savedWebAppUrl = localStorage.getItem('webAppUrl');
            
            if (savedSpreadsheetId) {
                document.getElementById('spreadsheetId').value = savedSpreadsheetId;
            }
            if (savedWebAppUrl) {
                document.getElementById('webAppUrl').value = savedWebAppUrl;
            }
            
            // Generate Apps Script code template
            generateAppsScriptTemplate();
            
            // Test current connection
            testCurrentConnection();
        }

        function closeSetupModal() {
            document.getElementById('setupModal').classList.add('hidden');
        }

        function generateAppsScriptTemplate() {
            const spreadsheetId = document.getElementById('spreadsheetId').value || '1FJnBiWM5cuH0a1Yw0CxAR9zy_LiD1lVtQg9ijXRrPS4';
            
            const scriptTemplate = `// MSSD Catur Registration System - Google Apps Script
// Your spreadsheet ID is already configured below

const SPREADSHEET_ID = '${spreadsheetId}';

function doGet(e) {
  try {
    const action = e.parameter.action;
    const callback = e.parameter.callback;
    
    let result = {};
    
    if (action === 'load') {
      result = loadRegistrations();
    } else if (action === 'search') {
      const regId = e.parameter.regId;
      const password = e.parameter.password;
      result = searchRegistration(regId, password);
    }
    
    // JSONP response
    if (callback) {
      return ContentService
        .createTextOutput(callback + '(' + JSON.stringify(result) + ')')
        .setMimeType(ContentService.MimeType.JAVASCRIPT);
    }
    
    return ContentService
      .createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    const errorResult = { error: error.toString() };
    const callback = e.parameter.callback;
    
    if (callback) {
      return ContentService
        .createTextOutput(callback + '(' + JSON.stringify(errorResult) + ')')
        .setMimeType(ContentService.MimeType.JAVASCRIPT);
    }
    
    return ContentService
      .createTextOutput(JSON.stringify(errorResult))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    
    if (action === 'submit' || action === 'update') {
      return saveRegistration(data);
    }
    
    return ContentService
      .createTextOutput(JSON.stringify({ success: false, error: 'Unknown action' }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({ success: false, error: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function loadRegistrations() {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    
    // Create sheets if they don't exist
    let teacherSheet = ss.getSheetByName('GURU');
    if (!teacherSheet) {
      teacherSheet = ss.insertSheet('GURU');
      teacherSheet.getRange(1, 1, 1, 10).setValues([['ID PENDAFTARAN', 'NAMA SEKOLAH', 'NAMA GURU', 'EMAIL GURU', 'TELEFON GURU', 'JAWATAN GURU', 'URUTAN GURU', 'TARIKH DAFTAR', 'TARIKH KEMASKINI', 'STATUS']]);
    }
    
    let schoolSheet = ss.getSheetByName('SEKOLAH');
    if (!schoolSheet) {
      schoolSheet = ss.insertSheet('SEKOLAH');
      schoolSheet.getRange(1, 1, 1, 13).setValues([['ID PENDAFTARAN', 'NAMA SEKOLAH', 'JENIS SEKOLAH', 'JUMLAH GURU', 'JUMLAH PELAJAR', 'JUMLAH LELAKI', 'JUMLAH PEREMPUAN', 'JUMLAH U12', 'JUMLAH U15', 'JUMLAH U18', 'TARIKH DAFTAR', 'TARIKH KEMASKINI', 'STATUS']]);
    }
    
    let studentSheet = ss.getSheetByName('PELAJAR');
    if (!studentSheet) {
      studentSheet = ss.insertSheet('PELAJAR');
      studentSheet.getRange(1, 1, 1, 13).setValues([['ID PENDAFTARAN', 'NAMA SEKOLAH', 'NAMA PELAJAR', 'NO IC', 'JANTINA', 'KATEGORI UMUR', 'KATEGORI DISPLAY', 'ID PEMAIN', 'GURU KETUA', 'TELEFON GURU', 'TARIKH DAFTAR', 'TARIKH KEMASKINI', 'STATUS']]);
    }
    
    const registrations = {};
    
    // Load data from sheets
    const schoolData = schoolSheet.getDataRange().getValues();
    const teacherData = teacherSheet.getDataRange().getValues();
    const studentData = studentSheet.getDataRange().getValues();
    
    // Process schools (skip header row)
    for (let i = 1; i < schoolData.length; i++) {
      const row = schoolData[i];
      const regId = row[0];
      if (regId) {
        registrations[regId] = {
          schoolName: row[1],
          schoolType: row[2],
          createdAt: row[10],
          updatedAt: row[11],
          status: row[12],
          teachers: [],
          students: []
        };
      }
    }
    
    // Process teachers (skip header row)
    for (let i = 1; i < teacherData.length; i++) {
      const row = teacherData[i];
      const regId = row[0];
      if (regId && registrations[regId]) {
        registrations[regId].teachers.push({
          name: row[2],
          email: row[3],
          phone: row[4],
          position: row[5],
          order: row[6]
        });
      }
    }
    
    // Process students (skip header row)
    for (let i = 1; i < studentData.length; i++) {
      const row = studentData[i];
      const regId = row[0];
      if (regId && registrations[regId]) {
        registrations[regId].students.push({
          name: row[2],
          ic: row[3],
          gender: row[4],
          category: row[5],
          categoryDisplay: row[6],
          playerId: row[7]
        });
      }
    }
    
    return { registrations: registrations };
    
  } catch (error) {
    return { error: 'Failed to load data: ' + error.toString() };
  }
}

function saveRegistration(data) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const teacherSheet = ss.getSheetByName('GURU');
    const schoolSheet = ss.getSheetByName('SEKOLAH');
    const studentSheet = ss.getSheetByName('PELAJAR');
    
    const regId = data.registrationId;
    const timestamp = new Date();
    
    // Determine school type
    const schoolName = data.schoolName.toUpperCase();
    let schoolType = 'LAIN-LAIN';
    if (schoolName.includes('SK ')) schoolType = 'SEKOLAH KEBANGSAAN';
    else if (schoolName.includes('SMK ')) schoolType = 'SEKOLAH MENENGAH KEBANGSAAN';
    else if (schoolName.includes('SJKC ')) schoolType = 'SEKOLAH JENIS KEBANGSAAN (CINA)';
    else if (schoolName.includes('SJKT ')) schoolType = 'SEKOLAH JENIS KEBANGSAAN (TAMIL)';
    else if (schoolName.includes('SMKA ')) schoolType = 'SEKOLAH MENENGAH KEBANGSAAN AGAMA';
    
    // Calculate statistics
    const totalTeachers = data.teachers.length;
    const totalStudents = data.students.length;
    let totalMale = 0, totalFemale = 0;
    let totalU12 = 0, totalU15 = 0, totalU18 = 0;
    
    data.students.forEach(student => {
      if (student.gender === 'Lelaki') totalMale++;
      else totalFemale++;
      
      if (student.category.includes('12')) totalU12++;
      else if (student.category.includes('15')) totalU15++;
      else if (student.category.includes('18')) totalU18++;
    });
    
    // Clear existing data for this registration
    [teacherSheet, schoolSheet, studentSheet].forEach(sheet => {
      const sheetData = sheet.getDataRange().getValues();
      for (let i = sheetData.length - 1; i >= 1; i--) {
        if (sheetData[i][0] === regId) {
          sheet.deleteRow(i + 1);
        }
      }
    });
    
    // Save school data
    schoolSheet.appendRow([
      regId, data.schoolName, schoolType, totalTeachers, totalStudents,
      totalMale, totalFemale, totalU12, totalU15, totalU18,
      timestamp, timestamp, 'AKTIF'
    ]);
    
    // Save teachers
    data.teachers.forEach((teacher, index) => {
      const position = index === 0 ? 'KETUA' : 'PENGIRING';
      const order = index + 1;
      
      teacherSheet.appendRow([
        regId, data.schoolName, teacher.name, teacher.email, teacher.phone,
        position, order, timestamp, timestamp, 'AKTIF'
      ]);
    });
    
    // Save students
    const headTeacher = data.teachers[0];
    data.students.forEach(student => {
      // Generate category display (L12, P15, etc.)
      const genderCode = student.gender === 'Lelaki' ? 'L' : 'P';
      const ageCode = student.category.includes('12') ? '12' : 
                     student.category.includes('15') ? '15' : '18';
      const categoryDisplay = genderCode + ageCode;
      
      studentSheet.appendRow([
        regId, data.schoolName, student.name, student.ic, student.gender,
        student.category, categoryDisplay, student.playerId,
        headTeacher.name, headTeacher.phone, timestamp, timestamp, 'AKTIF'
      ]);
    });
    
    return ContentService
      .createTextOutput(JSON.stringify({ success: true, registrationId: regId }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({ success: false, error: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function searchRegistration(regId, password) {
  try {
    const registrations = loadRegistrations();
    
    if (registrations.error) {
      return { found: false, error: registrations.error };
    }
    
    const registration = registrations.registrations[regId];
    if (!registration) {
      return { found: false, error: 'Registration not found' };
    }
    
    // Verify password (last 4 digits of first teacher's phone)
    if (registration.teachers.length > 0) {
      const phone = registration.teachers[0].phone.replace(/\\D/g, '');
      const last4 = phone.slice(-4);
      
      if (last4 === password) {
        return { found: true, registration: registration };
      }
    }
    
    return { found: false, error: 'Invalid password' };
    
  } catch (error) {
    return { found: false, error: error.toString() };
  }
}`;

            document.getElementById('appsScriptCode').textContent = scriptTemplate;
        }

        function testCurrentConnection() {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.textContent = 'Testing...';
            statusEl.className = 'px-2 py-1 rounded text-xs bg-yellow-200 text-yellow-800';
            
            if (!GOOGLE_SCRIPT_URL) {
                statusEl.textContent = 'Not configured';
                statusEl.className = 'px-2 py-1 rounded text-xs bg-red-200 text-red-800';
                return;
            }
            
            // Test connection
            const callbackName = 'testCallback_' + Date.now();
            
            window[callbackName] = function(data) {
                if (data && !data.error) {
                    statusEl.textContent = 'Connected ✅';
                    statusEl.className = 'px-2 py-1 rounded text-xs bg-green-200 text-green-800';
                } else {
                    statusEl.textContent = 'Error: ' + (data.error || 'Unknown error');
                    statusEl.className = 'px-2 py-1 rounded text-xs bg-red-200 text-red-800';
                }
                delete window[callbackName];
                if (script.parentNode) {
                    document.head.removeChild(script);
                }
            };
            
            const script = document.createElement('script');
            script.src = GOOGLE_SCRIPT_URL + '?action=load&callback=' + callbackName;
            script.onerror = () => {
                statusEl.textContent = 'Connection failed ❌';
                statusEl.className = 'px-2 py-1 rounded text-xs bg-red-200 text-red-800';
                delete window[callbackName];
                if (script.parentNode) {
                    document.head.removeChild(script);
                }
            };
            
            document.head.appendChild(script);
            
            setTimeout(() => {
                if (window[callbackName]) {
                    statusEl.textContent = 'Timeout ⏰';
                    statusEl.className = 'px-2 py-1 rounded text-xs bg-red-200 text-red-800';
                    delete window[callbackName];
                    if (script.parentNode) {
                        document.head.removeChild(script);
                    }
                }
            }, 10000);
        }

        function testGoogleSheetsConnection() {
            const testUrl = document.getElementById('webAppUrl').value;
            const resultEl = document.getElementById('testResult');
            
            if (!testUrl) {
                resultEl.innerHTML = '<div class="text-red-600">❌ Please enter your Web App URL first</div>';
                return;
            }
            
            resultEl.innerHTML = '<div class="text-blue-600">🧪 Testing connection...</div>';
            
            const callbackName = 'testConnectionCallback_' + Date.now();
            
            window[callbackName] = function(data) {
                if (data && !data.error) {
                    resultEl.innerHTML = '<div class="text-green-600">✅ Connection successful! Found ' + (Object.keys(data.registrations || {}).length) + ' registrations.</div>';
                } else {
                    resultEl.innerHTML = '<div class="text-red-600">❌ Connection failed: ' + (data.error || 'Unknown error') + '</div>';
                }
                delete window[callbackName];
                if (script.parentNode) {
                    document.head.removeChild(script);
                }
            };
            
            const script = document.createElement('script');
            script.src = testUrl + '?action=load&callback=' + callbackName;
            script.onerror = () => {
                resultEl.innerHTML = '<div class="text-red-600">❌ Failed to load script. Check your URL and deployment settings.</div>';
                delete window[callbackName];
                if (script.parentNode) {
                    document.head.removeChild(script);
                }
            };
            
            document.head.appendChild(script);
            
            setTimeout(() => {
                if (window[callbackName]) {
                    resultEl.innerHTML = '<div class="text-red-600">⏰ Connection timeout. Check your script and try again.</div>';
                    delete window[callbackName];
                    if (script.parentNode) {
                        document.head.removeChild(script);
                    }
                }
            }, 15000);
        }

        function saveGoogleSheetsConfig() {
            const spreadsheetId = document.getElementById('spreadsheetId').value;
            const webAppUrl = document.getElementById('webAppUrl').value;
            
            if (!spreadsheetId || !webAppUrl) {
                alert('Please fill in both Spreadsheet ID and Web App URL');
                return;
            }
            
            // Save to localStorage
            localStorage.setItem('spreadsheetId', spreadsheetId);
            localStorage.setItem('webAppUrl', webAppUrl);
            
            // Update the global variable
            GOOGLE_SCRIPT_URL = webAppUrl;
            
            // Show success message
            showSyncStatus('✅ Configuration saved! You can now sync with Google Sheets.', 'success');
            
            // Close modal
            closeSetupModal();
            
            // Test the new configuration
            setTimeout(() => {
                loadFromGoogleSheets();
            }, 1000);
        }

        // Load saved configuration on page load
        function loadSavedConfig() {
            const savedWebAppUrl = localStorage.getItem('webAppUrl');
            if (savedWebAppUrl) {
                GOOGLE_SCRIPT_URL = savedWebAppUrl;
            }
            
            // Auto-configure with provided credentials if not already saved
            if (!localStorage.getItem('spreadsheetId')) {
                localStorage.setItem('spreadsheetId', '1FJnBiWM5cuH0a1Yw0CxAR9zy_LiD1lVtQg9ijXRrPS4');
            }
            if (!localStorage.getItem('webAppUrl')) {
                localStorage.setItem('webAppUrl', 'https://script.google.com/macros/s/AKfycbwWNUtbfV4VKvsmbGyD4RWNUEVFdKwkk8bOsXuPdBkfgJ_-QFySGx0uJmfsBW5087mlPQ/exec');
            }
        }

        // Initialize saved config
        loadSavedConfig();
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'996f8e71a479cc5f',t:'MTc2MTg3NjAwMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
