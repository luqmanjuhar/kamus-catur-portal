<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profil Pemain & Kejohanan Catur</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light">
  <style>
    .shimmer {
      position: relative;
      overflow: hidden;
      background: linear-gradient(100deg, rgba(255,255,255,0) 40%, rgba(255,255,255,.35) 50%, rgba(255,255,255,0) 60%) #f59e0b;
      background-size: 200% 100%;
      animation: shimmer 1.2s infinite;
      opacity: .25;
    }
    @keyframes shimmer {
      0% { background-position: -150% 0; }
      100% { background-position: 150% 0; }
    }
    @media print {
      body { background: white; }
      header, #alertBox, #tabs { display: none !important; }
      .card { break-inside: avoid; }
    }
    .btn { transition: transform .06s ease, box-shadow .2s ease; }
    .btn:active { transform: scale(.98); }
    .is-active { box-shadow: inset 0 0 0 2px rgba(234,88,12,.5); }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-orange-50 via-orange-100 to-orange-200 text-slate-800">
  <div class="max-w-6xl mx-auto px-4 py-10">
    <!-- Header -->
    <header class="mb-8">
      <div class="rounded-3xl bg-white/70 backdrop-blur border border-orange-200 shadow-xl">
        <div class="p-6 md:p-8">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h1 class="text-2xl md:text-3xl font-extrabold text-orange-700 tracking-tight">
                Profil Pemain & Kejohanan Catur
              </h1>
              <p class="text-sm md:text-base text-orange-900/80 mt-1">
                Pilih profil pemain untuk lihat maklumat dan pencapaian, atau terokai senarai kejohanan.
              </p>
            </div>
            <div class="flex items-center gap-3">
              <button id="refreshBtn" class="btn inline-flex items-center gap-2 bg-orange-600 hover:bg-orange-700 text-white font-semibold px-4 py-2 rounded-xl shadow">
                <span>Segarkan Data</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="size-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v6h6M20 20v-6h-6M20 8a8 8 0 00-12-6.9M4 16a8 8 0 0012 6.9"/>
                </svg>
              </button>
              <button id="printBtn" class="btn inline-flex items-center gap-2 bg-orange-50 hover:bg-orange-100 text-orange-700 font-semibold px-4 py-2 rounded-xl border border-orange-200 shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="size-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path d="M6 9V4h12v5M6 18h12v2H6z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <rect x="4" y="9" width="16" height="7" rx="2" ry="2" stroke-width="2"></rect>
                </svg>
                <span>Cetak / PDF</span>
              </button>
            </div>
          </div>

          <!-- Tabs -->
          <div id="tabs" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-3">
            <button id="tabProfil" class="tab-btn bg-white border border-orange-300 hover:border-orange-400 text-orange-700 font-semibold px-4 py-3 rounded-xl shadow-sm transition flex items-center justify-center gap-2">
              <span>Profil Pemain</span>
            </button>
            <button id="tabKejohanan" class="tab-btn bg-white border border-orange-300 hover:border-orange-400 text-orange-700 font-semibold px-4 py-3 rounded-xl shadow-sm transition flex items-center justify-center gap-2">
              <span>Senarai Kejohanan</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Status / Alerts -->
    <div id="alertBox" class="hidden mb-6 rounded-xl border border-orange-300 bg-orange-50 text-orange-900 p-4"></div>

    <!-- Section: Profil Pemain -->
    <section id="profilSection">
      <div class="rounded-3xl bg-white/70 backdrop-blur border border-orange-200 shadow-xl mb-6">
        <div class="p-6 md:p-8">
          <div class="grid md:grid-cols-3 gap-4">
            <div class="md:col-span-2">
              <label for="playerSelect" class="block text-sm font-semibold text-orange-900/80 mb-2">
                Pilih Nama Pemain
              </label>
              <div class="relative">
                <select id="playerSelect" class="w-full appearance-none bg-white border border-orange-200 focus:border-orange-400 focus:ring-2 focus:ring-orange-200 rounded-xl px-4 py-3 pr-10 text-slate-800 shadow-sm">
                  <option value="">— Sila pilih nama —</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3 text-orange-600">
                  <svg xmlns="http://www.w3.org/2000/svg" class="size-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </div>
              </div>
              <p id="playerHelp" class="text-xs text-orange-900/70 mt-2">
                Tapis mengikut jurulatih/tahap/jenis/status, kemudian pilih nama untuk melihat profil dan pencapaian.
              </p>
              <p id="filterCount" class="text-xs text-orange-900/60 mt-1"></p>
            </div>

            <div class="grid grid-cols-3 gap-3">
              <div class="rounded-2xl bg-gradient-to-br from-orange-500 to-orange-600 text-white p-4 shadow">
                <div class="text-xs/4 opacity-90">Jumlah Pemain</div>
                <div id="profStatTotal" class="text-2xl font-extrabold mt-1">0</div>
              </div>
              <div class="rounded-2xl bg-white border border-orange-200 p-4 shadow">
                <div class="text-xs/4 text-orange-900/80">Jurulatih</div>
                <div id="profStatCoaches" class="text-2xl font-extrabold text-orange-700 mt-1">0</div>
              </div>
              <div class="rounded-2xl bg-white border border-orange-200 p-4 shadow">
                <div class="text-xs/4 text-orange-900/80">Tahap</div>
                <div id="profStatLevels" class="text-2xl font-extrabold text-orange-700 mt-1">0</div>
              </div>
            </div>
          </div>

          <!-- Penapis Profil -->
          <div class="mt-4 grid lg:grid-cols-4 md:grid-cols-2 gap-3">
            <div>
              <label class="block text-xs font-semibold text-orange-900/80 mb-1">Jurulatih</label>
              <select id="filterCoach" class="w-full bg-white border border-orange-200 focus:border-orange-400 focus:ring-2 focus:ring-orange-200 rounded-xl px-3 py-2.5 text-slate-800 shadow-sm">
                <option value="">Semua</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-semibold text-orange-900/80 mb-1">Tahap</label>
              <select id="filterLevel" class="w-full bg-white border border-orange-200 focus:border-orange-400 focus:ring-2 focus:ring-orange-200 rounded-xl px-3 py-2.5 text-slate-800 shadow-sm">
                <option value="">Semua</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-semibold text-orange-900/80 mb-1">Jenis Kelas</label>
              <select id="filterJenis" class="w-full bg-white border border-orange-200 focus:border-orange-400 focus:ring-2 focus:ring-orange-200 rounded-xl px-3 py-2.5 text-slate-800 shadow-sm">
                <option value="">Semua</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-semibold text-orange-900/80 mb-1">Status</label>
              <select id="filterStatus" class="w-full bg-white border border-orange-200 focus:border-orange-400 focus:ring-2 focus:ring-orange-200 rounded-xl px-3 py-2.5 text-slate-800 shadow-sm">
                <option value="">Semua</option>
                <option value="kchers">KCHERS</option>
                <option value="active">ACTIVE</option>
                <option value="inactive">INACTIVE</option>
                <option value="alumni">ALUMNI</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Profil terpilih -->
      <div id="selectedProfileWrap" class="hidden">
        <article id="selectedProfile" class="rounded-2xl bg-white border border-orange-200 shadow p-5 flex items-start gap-4"></article>
      </div>

      <!-- Papan ringkas Pencapaian (di bawah profil) -->
      <div id="achSummaryWrap" class="hidden mt-4">
        <div class="rounded-3xl bg-white/70 backdrop-blur border border-orange-200 shadow-xl p-5 md:p-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 w-full md:w-auto">
              <div class="rounded-2xl bg-gradient-to-br from-orange-500 to-orange-600 text-white p-4 shadow">
                <div class="text-xs/4 opacity-90">Jumlah Pencapaian</div>
                <div id="achStatTotal" class="text-2xl font-extrabold mt-1">0</div>
              </div>
              <div class="rounded-2xl bg-white border border-orange-200 p-4 shadow">
                <div class="text-xs/4 text-orange-900/80">Peringkat Unik</div>
                <div id="achStatLevels" class="text-2xl font-extrabold text-orange-700 mt-1">0</div>
              </div>
              <div class="rounded-2xl bg-white border border-orange-200 p-4 shadow">
                <div class="text-xs/4 text-orange-900/80">Kategori Unik</div>
                <div id="achStatCats" class="text-2xl font-extrabold text-orange-700 mt-1">0</div>
              </div>
            </div>

            <div class="w-full md:w-auto">
              <div class="text-sm font-semibold text-orange-700 mb-2">Susun mengikut</div>
              <div class="flex flex-wrap items-center gap-2">
                <button id="sortByDate" class="btn inline-flex items-center gap-2 rounded-lg bg-white border border-orange-300 hover:border-orange-400 text-orange-700 text-sm font-semibold px-3 py-1.5 shadow-sm">
                  <svg xmlns="http://www.w3.org/2000/svg" class="size-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M8 7h8M6 11h12M10 15h8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  Tarikh <span id="dateDir" class="text-xs text-orange-600">↓</span>
                </button>
                <div class="relative">
                  <button id="sortByLevel" class="btn inline-flex items-center gap-2 rounded-lg bg-white border border-orange-300 hover:border-orange-400 text-orange-700 text-sm font-semibold px-3 py-1.5 shadow-sm pr-8">
                    <svg xmlns="http://www.w3.org/2000/svg" class="size-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path d="M4 18h16M6 14h12M8 10h8M10 6h4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Peringkat
                    <span id="levelDir" class="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-orange-600">↕</span>
                  </button>
                  <div id="levelMenu" class="hidden absolute z-10 mt-2 w-56 rounded-xl border border-orange-200 bg-white shadow-lg overflow-hidden">
                    <button data-leveldir="asc" class="w-full text-left px-3 py-2 text-sm hover:bg-orange-50">Sekolah → Antarabangsa</button>
                    <button data-leveldir="desc" class="w-full text-left px-3 py-2 text-sm hover:bg-orange-50">Antarabangsa → Sekolah</button>
                  </div>
                </div>
              </div>
              <div id="achSortHint" class="mt-2 text-xs text-orange-900/60">Disusun: Tarikh (↓ baru → lama)</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Senarai Kad Pencapaian -->
      <div id="achievementsWrap" class="hidden mt-4">
        <div class="mb-3 flex items-center justify-between">
          <div class="text-sm text-orange-900/80" id="achMeta">0 rekod</div>
        </div>
        <div id="cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"></div>
      </div>

      <!-- Loader Profil + Pencapaian -->
      <div id="profAchLoader" class="hidden grid grid-cols-1 md:grid-cols-2 gap-5 mt-6">
        <div class="rounded-2xl bg-white p-6 border border-orange-200 shadow flex items-center gap-4">
          <div class="size-20 rounded-full bg-orange-200/50 shimmer"></div>
          <div class="flex-1">
            <div class="h-4 w-2/3 bg-orange-200/50 rounded mb-2"></div>
            <div class="h-3 w-1/2 bg-orange-200/50 rounded"></div>
          </div>
        </div>
        <div class="rounded-2xl bg-white p-4 border border-orange-200 shadow">
          <div class="h-48 w-full bg-orange-200/50 rounded shimmer mb-3"></div>
          <div class="h-4 w-2/3 bg-orange-200/50 rounded mb-2"></div>
          <div class="h-3 w-1/2 bg-orange-200/50 rounded"></div>
        </div>
      </div>

      <!-- Empty state -->
      <div id="profileEmpty" class="hidden">
        <div class="rounded-3xl border border-orange-200 bg-white p-10 text-center shadow">
          <div class="mx-auto mb-4 h-16 w-16 rounded-2xl bg-orange-100 text-orange-600 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="size-8" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <circle cx="12" cy="12" r="9" stroke-width="2"></circle>
              <path d="M8 12h8M12 8v8" stroke-width="2" stroke-linecap="round"></path>
            </svg>
          </div>
          <h3 class="text-lg font-bold text-orange-700">Tiada data dipaparkan</h3>
          <p class="text-sm text-orange-900/80 mt-1">Sila pilih nama pemain.</p>
        </div>
      </div>
    </section>

    <!-- Section: Senarai Kejohanan -->
    <section id="kejohananSection" class="mt-10">
      <div class="rounded-3xl bg-white/70 backdrop-blur border border-orange-200 shadow-xl">
        <div class="p-6 md:p-8">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 class="text-xl md:text-2xl font-extrabold text-orange-700">Senarai Kejohanan</h2>
              <p class="text-sm text-orange-900/80 mt-1">Data dibaca terus dari Google Sheet.</p>
            </div>
            <div class="grid grid-cols-3 gap-3 w-full md:w-auto">
              <div class="rounded-2xl bg-gradient-to-br from-orange-500 to-orange-600 text-white p-4 shadow">
                <div class="text-xs/4 opacity-90">Jumlah Kejohanan</div>
                <div id="tourStatTotal" class="text-2xl font-extrabold mt-1">0</div>
              </div>
              <div class="rounded-2xl bg-white border border-orange-200 p-4 shadow">
                <div class="text-xs/4 text-orange-900/80">Negeri</div>
                <div id="tourStatStates" class="text-2xl font-extrabold text-orange-700 mt-1">0</div>
              </div>
              <div class="rounded-2xl bg-white border border-orange-200 p-4 shadow">
                <div class="text-xs/4 text-orange-900/80">Jenis</div>
                <div id="tourStatTypes" class="text-2xl font-extrabold text-orange-700 mt-1">0</div>
              </div>
            </div>
          </div>

          <!-- Carian + Tapisan Kejohanan -->
          <div class="mt-6 grid lg:grid-cols-5 md:grid-cols-3 gap-3">
            <div class="lg:col-span-2 md:col-span-2">
              <label class="block text-xs font-semibold text-orange-900/80 mb-1">Cari Nama Kejohanan / Penganjur</label>
              <input id="tourSearch" type="text" placeholder="Tulis sebahagian nama kejohanan atau penganjur..."
                     class="w-full bg-white border border-orange-200 focus:border-orange-400 focus:ring-2 focus:ring-orange-200 rounded-xl px-4 py-2.5 text-slate-800 shadow-sm" />
            </div>
            <div>
              <label class="block text-xs font-semibold text-orange-900/80 mb-1">Negeri</label>
              <select id="tourState" class="w-full bg-white border border-orange-200 focus:border-orange-400 focus:ring-2 focus:ring-orange-200 rounded-xl px-3 py-2.5 text-slate-800 shadow-sm">
                <option value="">Semua</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-semibold text-orange-900/80 mb-1">Jenis</label>
              <select id="tourType" class="w-full bg-white border border-orange-200 focus:border-orange-400 focus:ring-2 focus:ring-orange-200 rounded-xl px-3 py-2.5 text-slate-800 shadow-sm">
                <option value="">Semua</option>
                <option value="FIDE Rated">FIDE Rated</option>
                <option value="MCF Rated">MCF Rated</option>
                <option value="Casual">Casual</option>
                <option value="Online">Online</option>
              </select>
            </div>
            <div class="flex items-end">
              <button id="tourExportBtn" class="btn w-full inline-flex items-center justify-center gap-2 bg-white border border-orange-300 hover:border-orange-400 text-orange-700 font-semibold px-4 py-2.5 rounded-xl shadow-sm transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="size-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path d="M12 5v8m0 0l-3-3m3 3l3-3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <rect x="3" y="3" width="18" height="14" rx="2" ry="2" stroke-width="2"></rect>
                </svg>
                Eksport CSV
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Loader Kejohanan -->
      <div id="tourLoader" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 mt-6">
        <div class="rounded-2xl bg-white p-4 border border-orange-200 shadow">
          <div class="h-28 w-full bg-orange-200/50 rounded shimmer mb-3"></div>
          <div class="h-4 w-2/3 bg-orange-200/50 rounded mb-2"></div>
          <div class="h-3 w-1/2 bg-orange-200/50 rounded"></div>
        </div>
        <div class="rounded-2xl bg-white p-4 border border-orange-200 shadow">
          <div class="h-28 w-full bg-orange-200/50 rounded shimmer mb-3"></div>
          <div class="h-4 w-2/3 bg-orange-200/50 rounded mb-2"></div>
          <div class="h-3 w-1/2 bg-orange-200/50 rounded"></div>
        </div>
        <div class="rounded-2xl bg-white p-4 border border-orange-200 shadow">
          <div class="h-28 w-full bg-orange-200/50 rounded shimmer mb-3"></div>
          <div class="h-4 w-2/3 bg-orange-200/50 rounded mb-2"></div>
          <div class="h-3 w-1/2 bg-orange-200/50 rounded"></div>
        </div>
      </div>

      <!-- Empty Kejohanan -->
      <div id="tourEmpty" class="hidden mt-6">
        <div class="rounded-3xl border border-orange-200 bg-white p-10 text-center shadow">
          <div class="mx-auto mb-4 h-16 w-16 rounded-2xl bg-orange-100 text-orange-600 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="size-8" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <circle cx="12" cy="12" r="9" stroke-width="2"></circle>
              <path d="M8 12h8M12 8v8" stroke-width="2" stroke-linecap="round"></path>
            </svg>
          </div>
          <h3 class="text-lg font-bold text-orange-700">Tiada kejohanan ditemui</h3>
          <p class="text-sm text-orange-900/80 mt-1">Semak carian/tapisan atau data Google Sheet.</p>
        </div>
      </div>

      <!-- Results Kejohanan -->
      <div id="tournResults" class="hidden mt-6">
        <div id="tourCards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"></div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="mt-10 text-center text-sm text-orange-900/70">
      <div>Data dimuat daripada Google Sheet secara langsung. Pastikan pautan kekal umum.</div>
      <div class="mt-1 text-xs text-orange-900/60">© <span id="yearNow"></span> Kamus Catur Enterprise. Hak cipta terpelihara.</div>
    </footer>
  </div>

  <script>
    // URLs CSV
    const CSV_URL_PERF = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTV1wrZklXUoqDTohB_hlJU92k8hLqaUCuKiJYlcxxX14sO2YP2wVeC2ge_Qng2bViWsX--IH82asLB/pub?gid=67263338&single=true&output=csv";
    const CSV_URL_TOURN = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTV1wrZklXUoqDTohB_hlJU92k8hLqaUCuKiJYlcxxX14sO2YP2wVeC2ge_Qng2bViWsX--IH82asLB/pub?gid=1759627665&single=true&output=csv";
    const CSV_URL_PROFILE = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSC4K1A01L8hGffDGZi5caGAmCmEofkdPARenPvgsr0JXKs1GgHHVp3-zzSj-BoLbxTdpcXqc3a-MKI/pub?gid=444058901&single=true&output=csv";

    // Kolum Prestasi
    const COLS = {
      timestamp: "Timestamp",
      name: "Name/Nama",
      tournament: "Tournament Name/Nama Kejohanan",
      date: "Date/Tarikh",
      level: "Level/Peringkat",
      category: "Category/Kategori",
      achievement: "Achievement/Pencapaian",
      photoText: "Photo / Gambar",
      remarks: "Remarks/Tambahan",
      photoURL: "URL Photo",
      image: "Image"
    };

    // Kolum Kejohanan
    const TCOLS = {
      name: "Nama Kejohanan",
      organizer: "Nama Penganjur",
      state: "Negeri",
      start: "Tarikh mula",
      end: "Tarikh Tamat",
      fide: "Fide Rated",
      reg: "Link Pendaftaran"
    };

    // Kolum Profil
    const PCOLS = {
      nama: "NAMA",
      jenis: "JENIS KELAS",
      tahap: "TAHAP",
      jurulatih: "JURULATIH",
      status: "STATUS",
      nric: "NO KAD PENGENALAN",
      urlPhoto: "URL Photo"
    };

    // Elemen UI
    const ui = {
      tabProfil: document.getElementById("tabProfil"),
      tabKejohanan: document.getElementById("tabKejohanan"),
      profilSection: document.getElementById("profilSection"),
      kejohananSection: document.getElementById("kejohananSection"),
      refreshBtn: document.getElementById("refreshBtn"),
      printBtn: document.getElementById("printBtn"),
      alertBox: document.getElementById("alertBox"),
    };

    // Profil + Achievements
    const pel = {
      playerSelect: document.getElementById("playerSelect"),
      playerHelp: document.getElementById("playerHelp"),
      profStatTotal: document.getElementById("profStatTotal"),
      profStatCoaches: document.getElementById("profStatCoaches"),
      profStatLevels: document.getElementById("profStatLevels"),

      profAchLoader: document.getElementById("profAchLoader"),
      profileEmpty: document.getElementById("profileEmpty"),

      selectedProfileWrap: document.getElementById("selectedProfileWrap"),
      selectedProfile: document.getElementById("selectedProfile"),

      achSummaryWrap: document.getElementById("achSummaryWrap"),
      achStatTotal: document.getElementById("achStatTotal"),
      achStatLevels: document.getElementById("achStatLevels"),
      achStatCats: document.getElementById("achStatCats"),

      achievementsWrap: document.getElementById("achievementsWrap"),
      achMeta: document.getElementById("achMeta"),
      cards: document.getElementById("cards"),

      filterCoach: document.getElementById("filterCoach"),
      filterLevel: document.getElementById("filterLevel"),
      filterJenis: document.getElementById("filterJenis"),
      filterStatus: document.getElementById("filterStatus"),
      filterCount: document.getElementById("filterCount"),

      sortByDate: document.getElementById("sortByDate"),
      sortByLevel: document.getElementById("sortByLevel"),
      dateDir: document.getElementById("dateDir"),
      achSortHint: document.getElementById("achSortHint"),
    };

    // Kejohanan
    const tel = {
      tourLoader: document.getElementById("tourLoader"),
      tourEmpty: document.getElementById("tourEmpty"),
      tournResults: document.getElementById("tournResults"),
      tourCards: document.getElementById("tourCards"),
      tourSearch: document.getElementById("tourSearch"),
      tourState: document.getElementById("tourState"),
      tourType: document.getElementById("tourType"),
      tourExportBtn: document.getElementById("tourExportBtn"),
      statTotal: document.getElementById("tourStatTotal"),
      statStates: document.getElementById("tourStatStates"),
      statTypes: document.getElementById("tourStatTypes"),
    };

    // Data store
    let perfRows = [];   // semua prestasi
    let profRows = [];   // semua profil
    let tourAll = [];    // semua kejohanan
    let tourFiltered = [];

    // Achievements state
    let currentAchievements = [];
    let sortState = { by: "date", dir: "desc", levelDir: "asc" }; // date | level

    // CSV utils
    function parseCSV(text) {
      const rows = [];
      let i = 0, field = "", row = [], inQuotes = false;
      const pushField = () => { row.push(field); field = ""; };
      const pushRow = () => { rows.push(row); row = []; };
      while (i < text.length) {
        const c = text[i];
        if (inQuotes) {
          if (c === '"') {
            if (text[i + 1] === '"') { field += '"'; i++; }
            else { inQuotes = false; }
          } else field += c;
        } else {
          if (c === '"') inQuotes = true;
          else if (c === ',') pushField();
          else if (c === '\n') { pushField(); pushRow(); }
          else if (c === '\r') {}
          else field += c;
        }
        i++;
      }
      if (field.length > 0 || row.length > 0) { pushField(); pushRow(); }
      return rows;
    }
    function rowsToObjects(rows) {
      if (!rows || rows.length === 0) return [];
      const header = rows[0].map(h => h.trim());
      const idx = Object.fromEntries(header.map((h, i) => [h, i]));
      const out = [];
      for (let r = 1; r < rows.length; r++) {
        const line = rows[r];
        if (!line || line.length === 0) continue;
        const obj = {};
        for (const h of header) obj[h] = line[idx[h]] || "";
        out.push(obj);
      }
      return out;
    }

    // Helpers
    function showAlert(msg, type="info") {
      ui.alertBox.classList.remove("hidden");
      ui.alertBox.textContent = msg;
      ui.alertBox.className = "mb-6 rounded-xl p-4 " + (type==="error" ? "border border-red-300 bg-red-50 text-red-900" : "border border-orange-300 bg-orange-50 text-orange-900");
    }
    function hideAlert() {
      ui.alertBox.classList.add("hidden");
      ui.alertBox.textContent = "";
    }
    function parseDateSafe(val) {
      if (!val) return null;
      const t = (val + "").trim();
      let m = t.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
      if (m) {
        let a = +m[1], b = +m[2], y = +m[3];
        if (y < 100) y = 2000 + y;
        let day, month;
        if (b > 12 && a >= 1 && a <= 12) { month = a; day = b; }
        else if (a > 12 && b >= 1 && b <= 12) { day = a; month = b; }
        else { month = a; day = b; }
        return new Date(y, month - 1, day);
      }
      m = t.match(/^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})$/);
      if (m) return new Date(+m[1], +m[2] - 1, +m[3]);
      const dn = new Date(t);
      return isNaN(dn.getTime()) ? null : dn;
    }
    function formatDate(val) {
      const d = parseDateSafe(val);
      if (!d) return (val || "").toString();
      try { return d.toLocaleDateString("ms-MY", { year:'numeric', month:'long', day:'2-digit' }); } catch { return d.toDateString(); }
    }
    function extractDateFromTitle(title) {
      if (!title) return { cleanTitle: title || "", extractedDate: null };
      let t = title.trim();
      const patterns = [
        /(.*?)[\s,\-:\(\[]\s*(\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4})\s*[)\]]?$/,
        /(.*?)[\s,:\-]\s*(\d{4}[\-]\d{2}[\-]\d{2})$/,
        /(.*?)[\s,:\-]\s*(\d{4}[\/]\d{1,2}[\/]\d{1,2})$/
      ];
      for (const p of patterns) {
        const m = t.match(p);
        if (m) {
          const cleanTitle = m[1].trim().replace(/[\-–,:]$/, '').trim();
          return { cleanTitle, extractedDate: m[2] };
        }
      }
      return { cleanTitle: t, extractedDate: null };
    }
    function normalizeImageURL(u) {
      if (!u) return "";
      let url = u.trim();
      if (url.includes("drive.google.com")) {
        let m = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
        if (m && m[1]) return `https://drive.google.com/thumbnail?id=${m[1]}&sz=w1200`;
        m = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
        if (m && m[1]) return `https://drive.google.com/thumbnail?id=${m[1]}&sz=w1200`;
      }
      if (url.includes("1drv.ms") || url.includes("onedrive.live.com")) {
        if (!url.includes("download=1")) url += (url.includes("?") ? "&" : "?") + "download=1";
        return url;
      }
      if (url.includes("dropbox.com")) {
        url = url.replace("?dl=0", "?raw=1").replace("?dl=1", "?raw=1");
        if (!url.includes("?")) url += "?raw=1";
        return url;
      }
      if (url.includes("photos.app.goo.gl")) return "";
      if (url.includes("imgur.com") && !url.includes("i.imgur.com")) {
        const m = url.match(/imgur\.com\/(gallery\/|a\/)?([a-zA-Z0-9]+)/);
        if (m && m[2]) return `https://i.imgur.com/${m[2]}.jpg`;
      }
      return url;
    }
    function buildBadge(text, colorClass = "bg-orange-100 text-orange-800 border-orange-200") {
      const span = document.createElement("span");
      span.className = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-xs font-semibold border ${colorClass}`;
      span.textContent = text;
      return span;
    }

    // Profil info tambahan
    function formatDOBFromNRIC(nric) {
      const s = (nric || '').replace(/[^0-9]/g,'');
      if (s.length < 6) return '';
      const yy = parseInt(s.slice(0,2),10);
      const mm = parseInt(s.slice(2,4),10);
      const dd = parseInt(s.slice(4,6),10);
      if (!(mm>=1 && mm<=12) || !(dd>=1 && dd<=31)) return '';
      const fullYear = yy <= 29 ? 2000 + yy : 1900 + yy;
      const d = new Date(fullYear, mm-1, dd);
      if (isNaN(d.getTime())) return '';
      try { return d.toLocaleDateString('ms-MY', { year:'numeric', month:'long', day:'2-digit' }); } catch { return d.toDateString(); }
    }
    function computeAgeFromNRIC(nric) {
      const s = (nric || '').replace(/[^0-9]/g,'');
      if (s.length < 6) return null;
      const yy = parseInt(s.slice(0,2),10);
      const mm = parseInt(s.slice(2,4),10);
      const dd = parseInt(s.slice(4,6),10);
      if (!(mm>=1 && mm<=12) || !(dd>=1 && dd<=31)) return null;
      const fullYear = yy <= 29 ? 2000 + yy : 1900 + yy;
      const dob = new Date(fullYear, mm-1, dd);
      if (isNaN(dob.getTime())) return null;
      const today = new Date();
      let age = today.getFullYear() - dob.getFullYear();
      const m = today.getMonth() - dob.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;
      return age;
    }
    function getStatusNorm(s) {
      const t = (s || '').toString().trim().toLowerCase();
      if (!t) return '';
      if (t.includes('kchers')) return 'kchers';
      if (t.includes('alumni')) return 'alumni';
      if (t.includes('inactive') || t.includes('tamat') || t.includes('expired') || t.includes('inaktif')) return 'inactive';
      if (t.includes('active') || t.includes('aktif') || t.includes('valid')) return 'active';
      return t;
    }
    function getTournamentType(val) {
      const t = (val || "").toString().trim().toLowerCase();
      if (!t) return "Casual";
      if (t.includes("fide")) return "FIDE Rated";
      if (t.includes("mcf")) return "MCF Rated";
      if (t.includes("online")) return "Online";
      if (t.startsWith("y") || t === "ya" || t === "yes") return "FIDE Rated";
      if (t.startsWith("n") || t === "tidak" || t === "no") return "Casual";
      return "Casual";
    }

    // Data
    let profileFilters = { coach: "", level: "", jenis: "", status: "" };

    // Loaders
    async function loadProfiles() {
      try {
        const res = await fetch(CSV_URL_PROFILE, { cache: "no-store" });
        if (!res.ok) throw new Error("fail");
        const text = await res.text();
        const rows = rowsToObjects(parseCSV(text));
        profRows = rows.map(r => ({
          [PCOLS.nama]: (r[PCOLS.nama] || "").trim(),
          [PCOLS.jenis]: (r[PCOLS.jenis] || "").trim(),
          [PCOLS.tahap]: (r[PCOLS.tahap] || "").trim(),
          [PCOLS.jurulatih]: (r[PCOLS.jurulatih] || "").trim(),
          [PCOLS.status]: getStatusNorm((r[PCOLS.status] || "").trim()),
          [PCOLS.nric]: (r[PCOLS.nric] || "").trim(),
          [PCOLS.urlPhoto]: (r[PCOLS.urlPhoto] || "").trim(),
        })).filter(o => o[PCOLS.nama]);

        pel.profStatTotal.textContent = profRows.filter(matchesProfile).length.toString();
        pel.profStatCoaches.textContent = new Set(profRows.map(x => x[PCOLS.jurulatih]).filter(Boolean)).size.toString();
        pel.profStatLevels.textContent = new Set(profRows.map(x => x[PCOLS.tahap]).filter(Boolean)).size.toString();

        populateProfileFilters();
        rebuildNameOptions();
        pel.profStatTotal.textContent = profRows.filter(matchesProfile).length.toString();
      } catch (e) {
        pel.playerHelp.textContent = "Gagal memuat profil. Sila cuba lagi.";
      }
    }

    async function loadPerformance() {
      try {
        const res = await fetch(CSV_URL_PERF, { cache: "no-store" });
        if (!res.ok) throw new Error("fail");
        const text = await res.text();
        const rows = rowsToObjects(parseCSV(text));
        perfRows = rows.filter(o => ((o[COLS.name] || "").trim() || (o[COLS.tournament] || "").trim()));
      } catch (e) {
        perfRows = [];
      }
    }

    async function loadTournaments() {
      try {
        tel.tourLoader.classList.remove("hidden");
        tel.tournResults.classList.add("hidden");
        tel.tourEmpty.classList.add("hidden");

        const res = await fetch(CSV_URL_TOURN, { cache: "no-store" });
        if (!res.ok) throw new Error("fail");
        const text = await res.text();
        const rows = rowsToObjects(parseCSV(text));

        tourAll = rows.map(r => ({
          [TCOLS.name]: (r[TCOLS.name] || "").trim(),
          [TCOLS.organizer]: (r[TCOLS.organizer] || "").trim(),
          [TCOLS.state]: (r[TCOLS.state] || "").trim(),
          [TCOLS.start]: (r[TCOLS.start] || "").trim(),
          [TCOLS.end]: (r[TCOLS.end] || "").trim(),
          [TCOLS.fide]: (r[TCOLS.fide] || "").trim(),
          [TCOLS.reg]: (r[TCOLS.reg] || "").trim(),
          __type: getTournamentType(r[TCOLS.fide])
        })).filter(o => o[TCOLS.name] || o[TCOLS.organizer]);

        populateTournamentFilters(tourAll);
        filterAndRenderTournaments(); // Akan papar semua jika tiada carian
      } catch (e) {
        tourAll = [];
        updateTournamentStats(tourAll);
        tel.tournResults.classList.add("hidden");
        tel.tourEmpty.classList.remove("hidden");
      } finally {
        tel.tourLoader.classList.add("hidden");
      }
    }

    // Profil: penapis
    function populateProfileFilters() {
      const coaches = Array.from(new Set(profRows.map(x => x[PCOLS.jurulatih]).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'ms'));
      pel.filterCoach.innerHTML = '<option value="">Semua</option>' + coaches.map(v=>`<option value="${v}">${v}</option>`).join("");

      pel.filterStatus.innerHTML = '<option value="">Semua</option>' +
        '<option value="kchers">KCHERS</option>' +
        '<option value="active">ACTIVE</option>' +
        '<option value="inactive">INACTIVE</option>' +
        '<option value="alumni">ALUMNI</option>';

      updateDependentFilters();
    }

    function updateDependentFilters() {
      const coach = profileFilters.coach || pel.filterCoach.value || "";
      const baseList = coach ? profRows.filter(p => p[PCOLS.jurulatih] === coach) : profRows;

      const levels = Array.from(new Set(baseList.map(x => x[PCOLS.tahap]).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'ms'));
      const jenis = Array.from(new Set(baseList.map(x => x[PCOLS.jenis]).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'ms'));

      const prevLevel = pel.filterLevel.value;
      const prevJenis = pel.filterJenis.value;

      pel.filterLevel.innerHTML = '<option value="">Semua</option>' + levels.map(v=>`<option value="${v}">${v}</option>`).join("");
      pel.filterJenis.innerHTML = '<option value="">Semua</option>' + jenis.map(v=>`<option value="${v}">${v}</option>`).join("");

      if (prevLevel && levels.includes(prevLevel)) pel.filterLevel.value = prevLevel; else { pel.filterLevel.value = ""; profileFilters.level = ""; }
      if (prevJenis && jenis.includes(prevJenis)) pel.filterJenis.value = prevJenis; else { pel.filterJenis.value = ""; profileFilters.jenis = ""; }

      rebuildNameOptions();
      pel.profStatTotal.textContent = profRows.filter(matchesProfile).length.toString();
    }

    function matchesProfile(p) {
      if (profileFilters.coach && p[PCOLS.jurulatih] !== profileFilters.coach) return false;
      if (profileFilters.level && p[PCOLS.tahap] !== profileFilters.level) return false;
      if (profileFilters.jenis && p[PCOLS.jenis] !== profileFilters.jenis) return false;
      if (profileFilters.status) {
        const want = profileFilters.status.toLowerCase();
        if ((p[PCOLS.status] || '').toLowerCase() !== want) return false;
      }
      return true;
    }

    function rebuildNameOptions() {
      const sel = pel.playerSelect;
      const prev = sel.value;
      const allNames = profRows.filter(matchesProfile).map(x => x[PCOLS.nama]);
      const names = Array.from(new Set(allNames)).sort((a,b)=>a.localeCompare(b,'ms'));

      const placeholder = document.createElement('option');
      placeholder.value = ""; placeholder.textContent = "— Sila pilih nama —";

      sel.innerHTML = "";
      sel.appendChild(placeholder);
      for (const n of names) {
        const op = document.createElement('option');
        op.value = n; op.textContent = n;
        sel.appendChild(op);
      }

      pel.filterCount.textContent = names.length ? `${names.length} nama sepadan` : "Tiada nama sepadan dengan tapisan";

      if (prev && names.includes(prev)) {
        sel.value = prev;
      } else {
        sel.value = "";
        pel.selectedProfileWrap.classList.add("hidden");
        pel.achievementsWrap.classList.add("hidden");
        pel.achSummaryWrap.classList.add("hidden");
        pel.profileEmpty.classList.remove("hidden");
      }
    }

    // Kejohanan: penapis dan render
    function populateTournamentFilters(list) {
      const states = Array.from(new Set(list.map(x => x[TCOLS.state]).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'ms'));
      tel.tourState.innerHTML = '<option value="">Semua</option>' + states.map(s=>`<option value="${s}">${s}</option>`).join("");
    }
    function updateTournamentStats(list) {
      tel.statTotal.textContent = list.length.toString();
      tel.statStates.textContent = new Set(list.map(x => x[TCOLS.state]).filter(Boolean)).size.toString();
      tel.statTypes.textContent = new Set(list.map(x => x.__type)).size.toString();
    }
    function filterAndRenderTournaments() {
      const q = tel.tourSearch.value.trim().toLowerCase();
      const st = tel.tourState.value;
      const tp = tel.tourType.value;

      let temp = tourAll.slice();
      if (q) temp = temp.filter(x => (`${x[TCOLS.name]} ${x[TCOLS.organizer]}`.toLowerCase().includes(q)));
      if (st) temp = temp.filter(x => x[TCOLS.state] === st);
      if (tp) temp = temp.filter(x => x.__type === tp);

      // Paparkan semua kejohanan bila tiada carian/tapisan (seperti sebelum ini)
      tourFiltered = (!q && !st && !tp) ? tourAll.slice() : temp;

      // Kemas kini statistik asas berdasarkan hasil semasa
      updateTournamentStats(tourFiltered);

      // Kira jumlah pencapaian dan pemain terlibat daripada hasil semasa
      let achTotal = 0;
      const playersSet = new Set();
      const nameCache = tourFiltered.map(t => (t[TCOLS.name] || '').toLowerCase());
      for (const r of perfRows) {
        const title = (r[COLS.tournament] || '').toLowerCase();
        const player = (r[COLS.name] || '').trim();
        if (!player) continue;
        if (nameCache.some(n => n && title.includes(n))) {
          achTotal++;
          playersSet.add(player);
        }
      }
      const achCountEl = document.getElementById('tourAchCount');
      const achPlayersEl = document.getElementById('tourAchPlayers');
      if (achCountEl) achCountEl.textContent = achTotal.toString();
      if (achPlayersEl) achPlayersEl.textContent = playersSet.size.toString();

      if (!tourFiltered.length) {
        tel.tournResults.classList.add("hidden");
        tel.tourEmpty.classList.remove("hidden");
        tel.tourCards.innerHTML = "";
        return;
      }
      tel.tourEmpty.classList.add("hidden");
      tel.tournResults.classList.remove("hidden");
      renderTournamentCards(tourFiltered);
    }
    function renderTournamentCards(list) {
      const sorted = list.map(x => ({ x, d: parseDateSafe(x[TCOLS.start]) }))
        .sort((a,b) => (b.d?.getTime?.()||0) - (a.d?.getTime?.()||0));
      tel.tourCards.innerHTML = "";
      const frag = document.createDocumentFragment();

      for (const { x } of sorted) {
        const card = document.createElement("article");
        card.className = "rounded-2xl bg-white border border-orange-200 shadow hover:shadow-lg transition overflow-hidden p-4 flex flex-col";

        const title = document.createElement("h3");
        title.className = "text-lg font-extrabold text-orange-700";
        title.textContent = x[TCOLS.name] || "Tanpa Nama Kejohanan";

        const sub = document.createElement("div");
        sub.className = "mt-1 text-sm text-orange-900/80";
        sub.textContent = x[TCOLS.organizer] ? `Penganjur: ${x[TCOLS.organizer]}` : "Penganjur: -";

        const chips = document.createElement("div");
        chips.className = "mt-2 flex flex-wrap items-center gap-2";
        if (x[TCOLS.state]) chips.appendChild(buildBadge(x[TCOLS.state]));

        const dr = document.createElement("div");
        dr.className = "text-sm text-slate-700";
        dr.innerHTML = `<span class="font-semibold text-orange-700">Tarikh:</span> ${x[TCOLS.start] ? formatDate(x[TCOLS.start]) : "-"} ${x[TCOLS.end] ? "hingga " + formatDate(x[TCOLS.end]) : ""}`;

        let color = "bg-slate-100 text-slate-700 border-slate-200";
        if (x.__type === "FIDE Rated") color = "bg-emerald-100 text-emerald-700 border-emerald-200";
        else if (x.__type === "MCF Rated") color = "bg-blue-100 text-blue-700 border-blue-200";
        else if (x.__type === "Online") color = "bg-violet-100 text-violet-700 border-violet-200";
        else color = "bg-amber-100 text-amber-800 border-amber-200";
        chips.appendChild(buildBadge(x.__type, color));

        // Ringkasan pencapaian pelajar yang terlibat (daripada data prestasi)
        const involved = perfRows.filter(r => {
          const tName = (r[COLS.tournament]||'').toLowerCase();
          const name = (x[TCOLS.name]||'').toLowerCase();
          return tName.includes(name) && (r[COLS.name]||'').trim();
        });
        const summary = document.createElement('div');
        summary.className = 'mt-3 rounded-xl border border-orange-200 bg-orange-50 p-3 text-sm text-orange-900/90';
        if (involved.length) {
          const byPlayer = {};
          involved.forEach(r => {
            const n = (r[COLS.name]||'-').trim();
            byPlayer[n] = byPlayer[n] || [];
            byPlayer[n].push(r);
          });
          const total = involved.length;
          const players = Object.keys(byPlayer);
          const head = document.createElement('div');
          head.className = 'font-semibold text-orange-700';
          head.textContent = `Ringkasan Pencapaian (${players.length} pemain, ${total} rekod)`;
          summary.appendChild(head);
          const listWrap = document.createElement('ul');
          listWrap.className = 'mt-2 space-y-1 max-h-40 overflow-auto pr-1';
          players.sort((a,b)=>a.localeCompare(b,'ms')).slice(0,10).forEach(n => {
            const li = document.createElement('li');
            const achTexts = byPlayer[n].map(r => (r[COLS.achievement]||'').toString().trim()).filter(Boolean);
            const chips = achTexts.slice(0,3).map(t => `
              <span class="inline-flex items-center rounded-full border border-orange-200 bg-white px-2 py-0.5 text-[11px] text-orange-700">${t}</span>
            `).join(' ');
            const more = achTexts.length > 3 ? ` <span class="text-[11px] text-orange-700/70">+${achTexts.length-3} lagi</span>` : '';
            li.innerHTML = `<span class='font-medium'>${n}</span> — ${chips || `${byPlayer[n].length} rekod`}${more}`;
            listWrap.appendChild(li);
          });
          if (players.length > 10) {
            const more = document.createElement('div');
            more.className = 'text-xs text-orange-700/80 mt-1';
            more.textContent = `+${players.length-10} pemain lagi`;
            summary.appendChild(more);
          }
          summary.appendChild(listWrap);
        } else {
          summary.textContent = 'Tiada ringkasan pencapaian ditemui untuk kejohanan ini.';
        }

        const footer = document.createElement("div");
        footer.className = "mt-3 flex items-center justify-between";
        const right = document.createElement("div");
        right.className = "flex items-center gap-2";
        if (x[TCOLS.reg]) {
          const a = document.createElement("a");
          a.href = x[TCOLS.reg]; a.target = "_blank"; a.rel = "noopener";
          a.className = "inline-flex items-center gap-2 rounded-lg bg-orange-600 hover:bg-orange-700 text-white text-sm font-semibold px-3 py-1.5 shadow transition";
          a.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="size-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M9 12l2 2 4-4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Pendaftaran';
          right.appendChild(a);
        } else {
          const span = document.createElement("span");
          span.className = "inline-flex items-center gap-2 rounded-lg bg-orange-100 text-orange-700 text-xs font-semibold px-3 py-1.5 border border-orange-200";
          span.textContent = "Tiada pautan";
          right.appendChild(span);
        }

        card.appendChild(title);
        card.appendChild(sub);
        card.appendChild(chips);
        card.appendChild(dr);
        card.appendChild(summary);
        footer.appendChild(document.createElement("div"));
        footer.appendChild(right);
        card.appendChild(footer);

        frag.appendChild(card);
      }

      tel.tourCards.appendChild(frag);
    }

    // PROFIL terpilih
    function renderSelectedProfile(name) {
      const p = profRows.find(x => (x[PCOLS.nama] || "").trim() === name);
      if (!p) {
        pel.selectedProfileWrap.classList.add("hidden");
        return;
      }
      pel.selectedProfileWrap.classList.remove("hidden");
      const wrap = pel.selectedProfile;
      wrap.innerHTML = "";

      const avatarWrap = document.createElement("div");
      avatarWrap.className = "relative shrink-0";
      const imgBox = document.createElement("div");

      const normSt = getStatusNorm(p[PCOLS.status]);
      let ringClass = "ring-0";
      if (normSt === 'kchers') ringClass = "ring-4 ring-orange-500";
      else if (normSt === 'active') ringClass = "ring-4 ring-orange-300";
      else if (normSt === 'alumni') ringClass = "ring-4 ring-red-500";
      else if (normSt === 'inactive') ringClass = "ring-4 ring-black";

      imgBox.className = `size-32 md:size-36 rounded-full overflow-hidden bg-orange-50 border border-orange-200 ${ringClass}`;
      const u = normalizeImageURL(p[PCOLS.urlPhoto]);
      if (u) {
        const img = document.createElement("img");
        img.src = u; img.alt = "Foto pemain"; img.loading = "lazy"; img.referrerPolicy = "no-referrer";
        img.className = "h-full w-full object-cover";
        img.onerror = function() {
          this.src = '';
          this.alt = 'Gambar gagal dimuat';
          this.style.display = 'none';
          const normSt2 = getStatusNorm(p[PCOLS.status]);
          let ringClass2 = "ring-0";
          if (normSt2 === 'kchers') ringClass2 = "ring-4 ring-orange-500";
          else if (normSt2 === 'active') ringClass2 = "ring-4 ring-orange-300";
          else if (normSt2 === 'alumni') ringClass2 = "ring-4 ring-red-500";
          else if (normSt2 === 'inactive') ringClass2 = "ring-4 ring-black";
          imgBox.className = `size-24 md:size-28 rounded-full flex items-center justify-center bg-orange-100 border border-orange-200 text-orange-600 text-xs font-semibold ${ringClass2}`;
          imgBox.textContent = "Tiada gambar";
        };
        imgBox.appendChild(img);
      } else {
        const normSt2 = getStatusNorm(p[PCOLS.status]);
        let ringClass2 = "ring-0";
        if (normSt2 === 'kchers') ringClass2 = "ring-4 ring-orange-500";
        else if (normSt2 === 'active') ringClass2 = "ring-4 ring-orange-300";
        else if (normSt2 === 'alumni') ringClass2 = "ring-4 ring-red-500";
        else if (normSt2 === 'inactive') ringClass2 = "ring-4 ring-black";
        imgBox.className = `size-24 md:size-28 rounded-full flex items-center justify-center bg-orange-100 border border-orange-200 text-orange-600 text-xs font-semibold ${ringClass2}`;
        imgBox.textContent = "Tiada gambar";
      }
      avatarWrap.appendChild(imgBox);

      const body = document.createElement("div");
      body.className = "flex-1 min-w-0";
      const title = document.createElement("h2");
      title.className = "text-xl md:text-2xl font-extrabold text-orange-700 truncate";
      title.textContent = p[PCOLS.nama] || "-";

      const meta = document.createElement("div");
      meta.className = "mt-1 flex flex-wrap items-center gap-2";
      if (p[PCOLS.jenis]) meta.appendChild(buildBadge(p[PCOLS.jenis]));
      if (p[PCOLS.tahap]) meta.appendChild(buildBadge(p[PCOLS.tahap], "bg-amber-100 text-amber-800 border-amber-200"));
      if (p[PCOLS.jurulatih]) meta.appendChild(buildBadge(`Jurulatih: ${p[PCOLS.jurulatih]}`, "bg-emerald-100 text-emerald-700 border-emerald-200"));
      if (p[PCOLS.status]) {
        const norm = getStatusNorm(p[PCOLS.status]);
        let color = "bg-slate-100 text-slate-700 border-slate-200";
        if (norm === 'active') color = "bg-orange-100 text-orange-700 border-orange-200";
        else if (norm === 'kchers') color = "bg-amber-100 text-amber-800 border-amber-200";
        else if (norm === 'alumni') color = "bg-red-200 text-red-800 border-red-300";
        else if (norm === 'inactive') color = "bg-red-100 text-red-700 border-red-200";
        meta.appendChild(buildBadge(`Status: ${norm.toUpperCase()}`, color));
      }

      body.appendChild(title);
      body.appendChild(meta);

      const dob = formatDOBFromNRIC(p[PCOLS.nric]);
      const age = computeAgeFromNRIC(p[PCOLS.nric]);
      if (dob || age !== null) {
        const dobEl = document.createElement('div');
        dobEl.className = 'mt-2 text-sm text-orange-900/80';
        const ageText = (age !== null) ? ` &middot; <span class="font-semibold text-orange-700">Umur:</span> ${age} tahun` : '';
        const dobText = dob ? `<span class="font-semibold text-orange-700">Tarikh Lahir:</span> ${dob}` : '';
        dobEl.innerHTML = `${dobText}${ageText}`;
        body.appendChild(dobEl);
      }

      wrap.appendChild(avatarWrap);
      wrap.appendChild(body);
    }

    // KAD pencapaian
    function buildAchCard(r) {
      const rawDisplay = (r[COLS.photoURL] || "").trim();
      const displayURL = normalizeImageURL(rawDisplay);
      const linkURL = rawDisplay;

      const wrap = document.createElement("article");
      wrap.className = "card group rounded-2xl bg-white border border-orange-200 shadow hover:shadow-lg transition overflow-hidden flex flex-col";

      const media = document.createElement("div");
      media.className = "relative mx-auto mt-4 w-[300px] h-[300px] rounded-xl overflow-hidden bg-orange-50";
      if (displayURL) {
        const img = document.createElement("img");
        img.src = displayURL;
        img.alt = "Gambar kejohanan";
        img.loading = "lazy";
        img.referrerPolicy = "no-referrer";
        img.className = "h-full w-full object-cover";
        img.onerror = function () {
          this.src = '';
          this.alt = 'Gambar gagal dimuat';
          this.style.display = 'none';
          media.innerHTML = `
            <div class="absolute inset-0 flex items-center justify-center">
              <div class="rounded-xl bg-orange-100 text-orange-600 px-2 py-1 text-xs font-semibold">Tiada gambar</div>
            </div>
          `;
        };
        media.appendChild(img);
      } else {
        media.innerHTML = `
          <div class="absolute inset-0 flex items-center justify-center">
            <div class="rounded-xl bg-orange-100 text-orange-600 px-2 py-1 text-xs font-semibold">Tiada gambar</div>
          </div>
        `;
      }

      const body = document.createElement("div");
      body.className = "p-4 flex flex-col";

      const title = document.createElement("h3");
      title.className = "text-base font-extrabold text-orange-700 leading-snug";
      const { cleanTitle, extractedDate } = extractDateFromTitle(r[COLS.tournament] || "");
      title.textContent = cleanTitle || "Tanpa Nama Kejohanan";

      const meta = document.createElement("div");
      meta.className = "mt-1 flex flex-wrap items-center gap-2";
      const dateForBadge = extractedDate || r[COLS.date];
      if (dateForBadge) meta.appendChild(buildBadge(formatDate(dateForBadge)));
      if (r[COLS.level]) meta.appendChild(buildBadge(r[COLS.level]));
      if (r[COLS.category]) meta.appendChild(buildBadge(r[COLS.category]));

      const achievement = document.createElement("p");
      achievement.className = "text-sm text-slate-700 mt-1";
      achievement.innerHTML = "<span class='font-semibold text-orange-700'>Pencapaian:</span> " + (r[COLS.achievement] || "-");

      const remarks = document.createElement("p");
      remarks.className = "text-xs text-slate-600";
      remarks.innerHTML = "<span class='font-semibold text-orange-700'>Catatan:</span> " + (r[COLS.remarks] || "-");

      const footer = document.createElement("div");
      footer.className = "mt-3 flex items-center justify-between";

      const stamp = document.createElement("div");
      stamp.className = "text-[11px] text-orange-900/60";
      stamp.textContent = r[COLS.timestamp] ? `Hantar: ${formatDate(r[COLS.timestamp])}` : "";

      const right = document.createElement("div");
      right.className = "flex items-center gap-2";
      if (linkURL) {
        const viewBtn = document.createElement("a");
        viewBtn.href = linkURL;
        viewBtn.target = "_blank";
        viewBtn.rel = "noopener";
        viewBtn.className = "inline-flex items-center gap-1 rounded-lg bg-orange-600 hover:bg-orange-700 text-white text-xs font-semibold px-3 py-1.5 shadow transition";
        viewBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" class="size-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z" stroke-width="2"/>
            <circle cx="12" cy="12" r="3" stroke-width="2"/>
          </svg>
          Lihat Gambar
        `;
        right.appendChild(viewBtn);
      } else {
        const none = document.createElement("span");
        none.className = "inline-flex items-center gap-2 rounded-lg bg-orange-100 text-orange-700 text-xs font-semibold px-3 py-1.5 border border-orange-200";
        none.textContent = "Tiada pautan";
        right.appendChild(none);
      }

      footer.appendChild(stamp);
      footer.appendChild(right);

      body.appendChild(title);
      body.appendChild(meta);
      body.appendChild(achievement);
      body.appendChild(remarks);
      body.appendChild(footer);

      wrap.appendChild(media);
      wrap.appendChild(body);

      return wrap;
    }

    // RENDER & SORT PENCAPAIAN
    function updateAchDashboard(list) {
      pel.achStatTotal.textContent = list.length.toString();
      pel.achStatLevels.textContent = new Set(list.map(x => (x[COLS.level] || '').trim()).filter(Boolean)).size.toString();
      pel.achStatCats.textContent = new Set(list.map(x => (x[COLS.category] || '').trim()).filter(Boolean)).size.toString();
    }

    function sortFallbackDateDesc(a,b) {
      const da = parseDateSafe(extractDateFromTitle(a[COLS.tournament]||"").extractedDate || a[COLS.date]);
      const db = parseDateSafe(extractDateFromTitle(b[COLS.tournament]||"").extractedDate || b[COLS.date]);
      return (db?.getTime?.()||0) - (da?.getTime?.()||0);
    }

    function sortAchievements() {
      let arr = currentAchievements.slice();

      if (sortState.by === "date") {
        arr.sort((a,b) => {
          const da = parseDateSafe(extractDateFromTitle(a[COLS.tournament]||"").extractedDate || a[COLS.date]);
          const db = parseDateSafe(extractDateFromTitle(b[COLS.tournament]||"").extractedDate || b[COLS.date]);
          const va = da ? da.getTime() : 0;
          const vb = db ? db.getTime() : 0;
          return sortState.dir === "desc" ? (vb - va) : (va - vb);
        });
        pel.achSortHint.textContent = `Disusun: Tarikh (${sortState.dir === "desc" ? "↓ baru → lama" : "↑ lama → baru"})`;
      } else if (sortState.by === "level") {
        const ascGroups = [
          ["school", "sekolah"],
          ["district", "daerah"],
          ["state", "negeri"],
          ["national", "kebangsaan"],
          ["international", "antarabangsa"]
        ];
        const descGroups = [...ascGroups].reverse();
        const orderGroups = sortState.levelDir === 'desc' ? descGroups : ascGroups;
        const score = v => {
          const t = (v||"").toString().trim().toLowerCase();
          for (let i = 0; i < orderGroups.length; i++) {
            if (orderGroups[i].some(k => t.includes(k))) return i;
          }
          return 999;
        };
        arr.sort((a,b) => (score(a[COLS.level]) - score(b[COLS.level])) || sortFallbackDateDesc(a,b));
        pel.achSortHint.textContent = `Disusun: Peringkat (${sortState.levelDir === 'desc' ? 'Antarabangsa → Sekolah' : 'Sekolah → Antarabangsa'})`;
      }

      // Render
      pel.cards.innerHTML = "";
      const frag = document.createDocumentFragment();
      for (const r of arr) frag.appendChild(buildAchCard(r));
      pel.cards.appendChild(frag);
      pel.achMeta.textContent = `${arr.length} rekod`;
      updateAchDashboard(arr);
    }

    function setActiveSortButton() {
      pel.sortByDate.classList.toggle("is-active", sortState.by === "date");
      pel.sortByLevel.classList.toggle("is-active", sortState.by === "level");
      pel.dateDir.textContent = sortState.by === 'date' ? (sortState.dir === 'desc' ? '↓' : '↑') : '↓';
      const ld = document.getElementById('levelDir');
      if (ld) ld.textContent = sortState.by === 'level' ? (sortState.levelDir === 'desc' ? '↓' : '↑') : '↕';
    }

    // Interaksi tab
    function activateTab(which) {
      ui.tabProfil.classList.remove("ring-2","ring-orange-300");
      ui.tabKejohanan.classList.remove("ring-2","ring-orange-300");
      if (which === "profil") {
        ui.tabProfil.classList.add("ring-2","ring-orange-300");
        window.scrollTo({ top: 0, behavior: "smooth" });
      } else {
        ui.tabKejohanan.classList.add("ring-2","ring-orange-300");
        document.getElementById("kejohananSection").scrollIntoView({ behavior: "smooth" });
      }
    }

    // Pilih pemain -> render profil + papan + pencapaian
    function handlePlayerChange() {
      const name = pel.playerSelect.value;

      pel.cards.innerHTML = "";
      pel.achievementsWrap.classList.add("hidden");
      pel.achSummaryWrap.classList.add("hidden");

      if (!name) {
        pel.selectedProfileWrap.classList.add("hidden");
        pel.profileEmpty.classList.remove("hidden");
        return;
      }

      pel.profileEmpty.classList.add("hidden");
      pel.profAchLoader.classList.remove("hidden");

      renderSelectedProfile(name);

      currentAchievements = perfRows.filter(r => (r[COLS.name] || "").trim() === name);

      pel.achSummaryWrap.classList.remove("hidden");
      pel.achievementsWrap.classList.remove("hidden");
      pel.profAchLoader.classList.add("hidden");

      sortState = { by: "date", dir: "desc", levelDir: "asc" };
      setActiveSortButton();
      sortAchievements();
    }

    // Events
    ui.tabProfil.addEventListener("click", () => activateTab("profil"));
    ui.tabKejohanan.addEventListener("click", () => activateTab("kejohanan"));
    ui.refreshBtn.addEventListener("click", async () => {
      await Promise.all([loadProfiles(), loadPerformance(), loadTournaments()]);
      rebuildNameOptions();
      pel.profStatTotal.textContent = profRows.filter(matchesProfile).length.toString();
      handlePlayerChange();
    });
    ui.printBtn.addEventListener("click", () => window.print());
    pel.playerSelect.addEventListener("change", handlePlayerChange);

    // Penapis profil
    pel.filterCoach.addEventListener("change", () => { profileFilters.coach = pel.filterCoach.value; updateDependentFilters(); });
    pel.filterLevel.addEventListener("change", () => { profileFilters.level = pel.filterLevel.value; rebuildNameOptions(); pel.profStatTotal.textContent = profRows.filter(matchesProfile).length.toString(); });
    pel.filterJenis.addEventListener("change", () => { profileFilters.jenis = pel.filterJenis.value; rebuildNameOptions(); pel.profStatTotal.textContent = profRows.filter(matchesProfile).length.toString(); });
    pel.filterStatus.addEventListener("change", () => { profileFilters.status = pel.filterStatus.value; rebuildNameOptions(); pel.profStatTotal.textContent = profRows.filter(matchesProfile).length.toString(); });

    // Sorting buttons
    pel.sortByDate.addEventListener("click", () => {
      if (sortState.by === "date") {
        sortState.dir = sortState.dir === "desc" ? "asc" : "desc";
      } else {
        sortState = { ...sortState, by: "date", dir: "desc" };
      }
      setActiveSortButton();
      sortAchievements();
    });
    pel.sortByLevel.addEventListener("click", (e) => {
      e.stopPropagation();
      const menu = document.getElementById('levelMenu');
      menu.classList.toggle('hidden');
      sortState.by = 'level';
      setActiveSortButton();
    });
    // Tutup menu bila klik luar
    document.addEventListener('click', (e) => {
      const menu = document.getElementById('levelMenu');
      const btn = document.getElementById('sortByLevel');
      if (!menu || !btn) return;
      if (!menu.contains(e.target) && !btn.contains(e.target)) menu.classList.add('hidden');
    });
    // Pilihan dalam menu
    document.querySelectorAll('#levelMenu [data-leveldir]').forEach(btn => {
      btn.addEventListener('click', () => {
        sortState.by = 'level';
        sortState.levelDir = btn.getAttribute('data-leveldir') === 'desc' ? 'desc' : 'asc';
        document.getElementById('levelMenu').classList.add('hidden');
        setActiveSortButton();
        sortAchievements();
      });
    });

    // Kejohanan: carian & tapisan
    tel.tourSearch.addEventListener('input', filterAndRenderTournaments);
    tel.tourState.addEventListener('change', filterAndRenderTournaments);
    tel.tourType.addEventListener('change', filterAndRenderTournaments);
    tel.tourExportBtn.addEventListener('click', () => {
      // Eksport CSV daripada paparan semasa
      const header = ["Nama Kejohanan","Nama Penganjur","Negeri","Tarikh Mula","Tarikh Tamat","Jenis","Link Pendaftaran"];
      const rows = tourFiltered.map(x => [
        x[TCOLS.name]||"", x[TCOLS.organizer]||"", x[TCOLS.state]||"",
        x[TCOLS.start]||"", x[TCOLS.end]||"", x.__type||"", x[TCOLS.reg]||""
      ]);
      const csv = [header, ...rows].map(r => r.map(v => `"${(v||"").toString().replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = "kejohanan.csv"; a.click();
      URL.revokeObjectURL(url);
    });

    // Init
    (async function init() {
      hideAlert();
      activateTab("profil");
      document.getElementById('yearNow').textContent = new Date().getFullYear();

      await Promise.all([loadProfiles(), loadPerformance(), loadTournaments()]);
      // Selepas muat turun kejohanan, papar semua tanpa carian
      filterAndRenderTournaments();
      // Profil: paparkan kosong dahulu
      document.getElementById('profileEmpty').classList.remove('hidden');
    })();
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97f0d26e729ba84a',t:'MTc1Nzg2Mjc0MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
