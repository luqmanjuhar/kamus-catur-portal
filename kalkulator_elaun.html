<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Elaun Jurulatih</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#F37324',
                        'primary-hover': '#E56214',
                        'secondary': '#DC3C2C',
                        'secondary-hover': '#C92C1C',
                        'tertiary': '#F99E4C',
                        'tertiary-light': '#FBD0A4',
                        'dark-text': '#333333',
                        'light-bg': '#FFFDF7'
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #FFFDF7;
            color: #333333;
        }

        .chess-pattern {
            background-image: linear-gradient(45deg, rgba(249, 158, 76, 0.2) 25%, transparent 25%), linear-gradient(-45deg, rgba(249, 158, 76, 0.2) 25%, transparent 25%), linear-gradient(45deg, transparent 75%, rgba(249, 158, 76, 0.2) 75%), linear-gradient(-45deg, transparent 75%, rgba(249, 158, 76, 0.2) 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        
        .slot-container,
        .student-container {
            border-left: 3px solid #F37324;
            padding-left: 12px;
            margin-bottom: 12px;
        }

        .subtotal-box {
            background-color: rgba(249, 158, 76, 0.1);
            border-left: 4px solid #F37324;
            padding: 8px 12px;
            margin-top: 8px;
        }

        input:focus,
        select:focus {
            border-color: #F37324;
            outline: none;
            box-shadow: 0 0 0 3px rgba(243, 115, 36, 0.2);
        }

        input[type="checkbox"]:checked {
            background-color: #F37324;
            border-color: #F37324;
        }

        #statusMessage {
            transition: opacity 0.5s;
        }
    </style>
</head>

<body>
    <div class="min-h-screen">
        <header class="bg-primary text-white py-6 chess-pattern">
            <div class="container mx-auto px-4 flex flex-col items-center">
                <img src="https://raw.githubusercontent.com/luqmanjuhar/chesstrainercalculator/main/Asset%2028.png" alt="Logo Akademi" class="h-16 mb-4">
                <h1 class="text-3xl font-bold text-center">Kalkulator Elaun Jurulatih Catur</h1>
            </div>
        </header>

        <main class="container mx-auto px-4 py-8">
            <section class="bg-white rounded-lg shadow-lg p-6 mb-8 border border-primary">
                <h2 class="text-2xl font-bold mb-4 text-primary border-b pb-2">Bahagian 1: Maklumat Jurulatih</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-dark-text mb-2" for="nama">Nama Jurulatih</label>
                        <select id="nama" class="w-full px-4 py-2 border border-tertiary rounded-lg">
                            <option>Memuatkan jurulatih...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-dark-text mb-2" for="bulan">Bulan Laporan</label>
                        <select id="bulan" class="w-full px-4 py-2 border border-tertiary rounded-lg">
                            <option value="Januari">Januari</option>
                            <option value="Februari">Februari</option>
                            <option value="Mac">Mac</option>
                            <option value="April">April</option>
                            <option value="Mei">Mei</option>
                            <option value="Jun">Jun</option>
                            <option value="Julai">Julai</option>
                            <option value="Ogos">Ogos</option>
                            <option value="September">September</option>
                            <option value="Oktober">Oktober</option>
                            <option value="November">November</option>
                            <option value="Disember">Disember</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-dark-text mb-2" for="tarikhPenyata">Tarikh Penyata</label>
                        <input type="date" id="tarikhPenyata" class="w-full px-4 py-2 border border-tertiary rounded-lg">
                    </div>
                    <div>
                        <label class="block text-dark-text mb-2" for="jenisBank">Jenis Bank</label>
                        <input type="text" id="jenisBank" placeholder="Cth: Maybank, CIMB" class="w-full px-4 py-2 border border-tertiary rounded-lg bg-gray-100" readonly>
                    </div>
                    <div>
                        <label class="block text-dark-text mb-2" for="noAkaun">No. Akaun Bank</label>
                        <input type="text" id="noAkaun" placeholder="Cth: 1234567890" class="w-full px-4 py-2 border border-tertiary rounded-lg bg-gray-100" readonly>
                    </div>
                </div>
            </section>

            <section class="bg-white rounded-lg shadow-lg p-6 mb-8 border border-primary">
                <h2 class="text-2xl font-bold mb-4 text-primary border-b pb-2">Bahagian 2: Maklumat Kelas Catur</h2>
                
                <div class="mt-6">
                    <h3 class="text-xl font-semibold mb-4 text-primary">Kelas Fizikal</h3>
                    <p class="text-dark-text mb-4">Tandakan sekolah atau slot kelas yang dikendalikan:</p>
                    <div id="kelasContainer" class="space-y-6"></div>
                    <button id="tambahKelas" class="mt-4 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-hover transition">+ Tambah Sekolah/Lokasi (Fizikal)</button>
                </div>

                <div class="mt-8 pt-6 border-t">
                    <h3 class="text-xl font-semibold mb-4 text-primary">Kelas Pembangunan Catur (Online)</h3>
                    <p class="text-dark-text mb-4">Tandakan kumpulan atau slot kelas yang dikendalikan:</p>
                    <div id="pembangunanContainer" class="space-y-6"></div>
                    <button id="tambahKelasPembangunan" class="mt-4 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-hover transition">+ Tambah Kumpulan (Pembangunan)</button>
                </div>
                
                <div class="mt-8 pt-6 border-t">
                    <h3 class="text-xl font-semibold mb-4 text-primary">Kelas Online (Peribadi/Kumpulan)</h3>
                    <div id="onlineStudentsContainer" class="space-y-4"></div>
                    <button id="tambahPelajarOnline" class="mt-4 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-hover transition">+ Tambah Pelajar</button>
                    <div class="subtotal-box mt-6">
                        <h4 class="font-medium text-dark-text">Subtotal Kelas Online</h4>
                        <div class="subtotal-details text-sm mt-1">
                            <p class="font-medium">Jumlah: <span class="subtotal-online-jumlah">RM0.00</span></p>
                        </div>
                    </div>
                </div>
            </section>

            <section class="bg-white rounded-lg shadow-lg p-6 mb-8 border border-primary">
                <h2 class="text-2xl font-bold mb-4 text-primary border-b pb-2">Bahagian 3: Elaun, Bonus & Pengurangan</h2>

                <div class="mt-6">
                    <h3 class="text-xl font-semibold mb-4 text-primary">Elaun Tambahan & Bonus</h3>
                    <div class="space-y-4">
                        <h4 class="font-semibold text-lg text-dark-text mt-4 border-b pb-2">Elaun Tambahan</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-dark-text mb-2">Elaun Penyertaan Kejohanan (RM)</label>
                                <input type="number" id="elaunKejohanan" class="tambahan-bonus w-full px-4 py-2 border border-tertiary rounded-lg" value="0">
                            </div>
                            <div>
                                <label class="block text-dark-text mb-2">Elaun Makan (RM)</label>
                                <input type="number" id="elaunMakan" class="tambahan-bonus w-full px-4 py-2 border border-tertiary rounded-lg" value="0">
                            </div>
                            <div>
                                <label class="block text-dark-text mb-2">Elaun Arbiter (RM)</label>
                                <input type="number" id="elaunArbiter" class="tambahan-bonus w-full px-4 py-2 border border-tertiary rounded-lg" value="0">
                            </div>
                            <div>
                                <label class="block text-dark-text mb-2">Elaun Pembantu (RM)</label>
                                <input type="number" id="elaunPembantu" class="tambahan-bonus w-full px-4 py-2 border border-tertiary rounded-lg" value="0">
                            </div>
                        </div>

                        <h4 class="font-semibold text-lg text-dark-text mt-6 border-b pb-2">Bonus</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-dark-text mb-2">Bonus Tahunan (RM)</label>
                                <input type="number" id="bonusTahunan" class="tambahan-bonus w-full px-4 py-2 border border-tertiary rounded-lg" value="0">
                            </div>
                            <div>
                                <label class="block text-dark-text mb-2">Bonus Perayaan (RM)</label>
                                <input type="number" id="bonusPerayaan" class="tambahan-bonus w-full px-4 py-2 border border-tertiary rounded-lg" value="0">
                            </div>
                            <div>
                                <label class="block text-dark-text mb-2">Bonus Pencapaian Pelajar (RM)</label>
                                <input type="number" id="bonusPelajar" class="tambahan-bonus w-full px-4 py-2 border border-tertiary rounded-lg" value="0">
                            </div>
                            <div>
                                <label class="block text-dark-text mb-2">Bonus Pencapaian Jurulatih (RM)</label>
                                <input type="number" id="bonusJurulatih" class="tambahan-bonus w-full px-4 py-2 border border-tertiary rounded-lg" value="0">
                            </div>
                        </div>

                        <div class="subtotal-box mt-4">
                            <h4 class="font-medium text-dark-text">Subtotal Elaun Tambahan & Bonus</h4>
                            <div class="subtotal-details text-sm mt-1">
                                <p class="font-medium mt-1">Jumlah: <span class="subtotal-tambahan-bonus-jumlah text-primary">RM0.00</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-8 pt-6 border-t">
                    <h3 class="text-xl font-semibold mb-4 text-primary">Pengurangan</h3>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-dark-text mb-2">Penyertaan Kejohanan (RM)</label>
                                <input type="number" id="kejohanan" class="pengurangan w-full px-4 py-2 border border-tertiary rounded-lg" value="0">
                            </div>
                            <div>
                                <label class="block text-dark-text mb-2">Komitmen Yuran Bulanan (RM)</label>
                                <input type="number" id="yuran" class="pengurangan w-full px-4 py-2 border border-tertiary rounded-lg" value="0">
                            </div>
                            <div>
                                <label class="block text-dark-text mb-2">Sistem Rakaman (Google Workspace) (RM)</label>
                                <input type="number" id="rakaman" class="pengurangan w-full px-4 py-2 border border-tertiary rounded-lg" value="0">
                            </div>
                            <div>
                                <label class="block text-dark-text mb-2">Pembelian Peralatan Catur (RM)</label>
                                <input type="number" id="peralatan" class="pengurangan w-full px-4 py-2 border border-tertiary rounded-lg" value="0">
                            </div>
                        </div>
                        <div>
                            <label class="block text-dark-text mb-2">Lain-lain Pengurangan</label>
                            <div class="flex items-center">
                                <input type="text" id="lainKeterangan" placeholder="Keterangan" class="flex-grow px-4 py-2 border border-tertiary rounded-l-lg">
                                <input type="number" id="lainPengurangan" class="pengurangan w-32 px-4 py-2 border-t border-b border-r border-tertiary rounded-r-lg" value="0">
                            </div>
                        </div>
                        <div class="subtotal-box mt-4">
                            <h4 class="font-medium text-dark-text">Subtotal Pengurangan</h4>
                            <div class="subtotal-details text-sm mt-1">
                                <p class="font-medium mt-1">Jumlah: <span class="subtotal-pengurangan-jumlah text-secondary">RM0.00</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section class="bg-tertiary-light rounded-lg shadow-lg p-6 mb-8 border border-tertiary">
                <h2 class="text-2xl font-semibold mb-4 text-primary">Ringkasan Elaun</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="bg-white p-4 rounded-lg shadow border border-tertiary">
                        <h3 class="font-medium text-dark-text">Jumlah Kelas Fizikal</h3>
                        <p class="text-2xl font-bold text-primary">RM <span id="jumlahFizikal">0.00</span></p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border border-tertiary">
                        <h3 class="font-medium text-dark-text">Jumlah Kelas Pembangunan</h3>
                        <p class="text-2xl font-bold text-primary">RM <span id="jumlahPembangunan">0.00</span></p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border border-tertiary">
                        <h3 class="font-medium text-dark-text">Jumlah Kelas Online</h3>
                        <p class="text-2xl font-bold text-primary">RM <span id="jumlahOnline">0.00</span></p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border border-tertiary">
                        <h3 class="font-medium text-dark-text">Jumlah Elaun Tambahan & Bonus</h3>
                        <p class="text-2xl font-bold text-primary">RM <span id="jumlahTambahanBonus">0.00</span></p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border border-tertiary">
                        <h3 class="font-medium text-dark-text">Jumlah Pengurangan</h3>
                        <p class="text-2xl font-bold text-secondary">RM <span id="jumlahPengurangan">0.00</span></p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border border-tertiary">
                        <h3 class="font-medium text-dark-text">Jumlah Bersih</h3>
                        <p class="text-2xl font-bold text-primary">RM <span id="jumlahBersih">0.00</span></p>
                    </div>
                </div>
            </section>
            
            <div class="flex flex-col md:flex-row justify-center items-center space-y-3 md:space-y-0 md:space-x-4">
                <button id="kiraButton" class="w-full md:w-auto px-6 py-3 bg-primary text-white font-medium rounded-lg hover:bg-primary-hover transition shadow-lg">Kira Elaun</button>
                <button id="saveButton" class="w-full md:w-auto px-6 py-3 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition shadow-lg">Cetak & Simpan PDF</button>
                <button id="resetButton" class="w-full md:w-auto px-6 py-3 bg-dark-text text-white font-medium rounded-lg hover:bg-gray-600 transition shadow-lg">Reset</button>
            </div>

            <div id="statusMessage" class="text-center mt-4 font-medium opacity-0"></div>
        </main>
    </div>

    <script>
        // ====================================================================
        // SKRIP KALKULATOR ELAUN
        // ====================================================================

        // Menyimpan data bank jurulatih yang diambil dari Google Sheet
        let coachBankDetails = {};

        // --- TEMPLAT HTML DINAMIK ---
        // Templat untuk menambah seksyen kelas fizikal baru
        const fizikalTemplate = (counter) => `
            <div class="border border-tertiary rounded-lg p-4 hover:bg-light-bg">
                <div class="flex items-center mb-3">
                    <input type="checkbox" id="kelas${counter}" class="kelas-fizikal w-5 h-5 text-primary mr-3 border-tertiary" checked>
                    <div class="flex-grow">
                        <label for="kelas${counter}" class="block font-medium text-lg text-dark-text">Sekolah/Lokasi ${counter}</label>
                        <input type="text" placeholder="Nama Sekolah/Lokasi" class="nama-lokasi mt-1 w-full px-3 py-2 border border-tertiary rounded-lg">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm text-dark-text">Bulan</label>
                    <select class="kelas-bulan w-full md:w-1/2 px-3 py-2 border border-tertiary rounded-lg">
                        <option value="Januari">Januari</option><option value="Februari">Februari</option><option value="Mac">Mac</option><option value="April">April</option><option value="Mei">Mei</option><option value="Jun">Jun</option><option value="Julai">Julai</option><option value="Ogos">Ogos</option><option value="September">September</option><option value="Oktober">Oktober</option><option value="November">November</option><option value="Disember">Disember</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm text-dark-text">Bilangan Pelajar (Per Slot)</label>
                        <select class="pelajar-rate w-full px-3 py-2 border border-tertiary rounded-lg">
                            <option value="70">0 - 5 pelajar</option><option value="100">6 - 10 pelajar</option><option value="120">11 - 15 pelajar</option><option value="150" selected>16 - 20 pelajar</option><option value="170">21 - 25 pelajar</option><option value="200">26 - 30 pelajar</option><option value="220">31 - 35 pelajar</option><option value="250">36 - 40 pelajar</option>
                        </select>
                    </div>
                </div>
                <div class="slots-list space-y-3"></div>
                <div class="flex justify-end mt-3">
                    <button class="tambah-slot px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-hover transition" data-type="fizikal">+ Tambah Slot</button>
                </div>
                <div class="subtotal-box mt-4">
                    <h4 class="font-medium text-dark-text">Subtotal Kelas Fizikal</h4>
                    <div class="subtotal-details text-sm mt-1">
                        <p>Elaun Jurulatih: <span class="subtotal-pelajar">RM0.00</span></p>
                        <p>Jumlah Mileage: <span class="subtotal-jarak">RM0.00</span></p>
                        <p class="font-medium mt-1">Jumlah Keseluruhan: <span class="subtotal-jumlah">RM0.00</span></p>
                    </div>
                </div>
            </div>`;

        // Templat untuk menambah seksyen kelas pembangunan baru
        const pembangunanTemplate = (counter) => `
            <div class="border border-tertiary rounded-lg p-4 hover:bg-light-bg">
                <div class="flex items-center mb-3">
                    <input type="checkbox" id="pembangunan${counter}" class="kelas-pembangunan w-5 h-5 text-primary mr-3 border-tertiary" checked>
                    <div class="flex-grow">
                        <label for="pembangunan${counter}" class="block font-medium text-lg text-dark-text">Kumpulan ${counter}</label>
                        <input type="text" placeholder="Nama Kumpulan" class="nama-lokasi mt-1 w-full px-3 py-2 border border-tertiary rounded-lg">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm text-dark-text">Bulan</label>
                    <select class="kelas-bulan w-full md:w-1/2 px-3 py-2 border border-tertiary rounded-lg">
                        <option value="Januari">Januari</option><option value="Februari">Februari</option><option value="Mac">Mac</option><option value="April">April</option><option value="Mei">Mei</option><option value="Jun">Jun</option><option value="Julai">Julai</option><option value="Ogos">Ogos</option><option value="September">September</option><option value="Oktober">Oktober</option><option value="November">November</option><option value="Disember">Disember</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm text-dark-text">Bilangan Pelajar (Per Slot)</label>
                        <select class="pelajar-rate w-full px-3 py-2 border border-tertiary rounded-lg">
                            <option value="80" selected>7 - 10 pelajar</option>
                            <option value="100">11 - 15 pelajar</option>
                        </select>
                    </div>
                </div>
                <div class="slots-list space-y-3"></div>
                <div class="flex justify-end mt-3">
                    <button class="tambah-slot px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-hover transition" data-type="pembangunan">+ Tambah Slot</button>
                </div>
                <div class="subtotal-box mt-4">
                    <h4 class="font-medium text-dark-text">Subtotal Kelas Pembangunan</h4>
                    <div class="subtotal-details text-sm mt-1">
                        <p>Elaun Jurulatih: <span class="subtotal-pelajar">RM0.00</span></p>
                        <p class="font-medium mt-1">Jumlah Keseluruhan: <span class="subtotal-jumlah">RM0.00</span></p>
                    </div>
                </div>
            </div>`;

        // Templat untuk slot kelas fizikal
        const slotFizikalTemplate = (slotCounter) => `
            <div class="slot-container">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <span class="font-medium text-dark-text">Slot ${slotCounter}:</span>
                        <input type="date" class="slot-tarikh w-full mt-1 px-3 py-2 border border-tertiary rounded-lg">
                    </div>
                    <div>
                        <span class="font-medium text-dark-text">Kenderaan:</span>
                        <select class="slot-kenderaan w-full mt-1 px-3 py-2 border border-tertiary rounded-lg">
                            <option value="kereta">Kereta</option>
                            <option value="motor">Motor</option>
                        </select>
                    </div>
                    <div>
                        <span class="font-medium text-dark-text">Jarak (KM):</span>
                        <select class="slot-jarak w-full mt-1 px-3 py-2 border border-tertiary rounded-lg">
                            <option value="0">0 - 5 KM</option><option value="10">6 - 10 KM</option><option value="20">11 - 20 KM</option><option value="30">21 - 30 KM</option><option value="40">31 - 40 KM</option><option value="60">41 - 50 KM</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button class="hapus-slot px-3 py-2 bg-secondary text-white rounded-lg hover:bg-secondary-hover transition">Hapus</button>
                    </div>
                </div>
            </div>`;
            
        // Templat untuk slot kelas pembangunan
        const slotPembangunanTemplate = (slotCounter) => `
            <div class="slot-container">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <span class="font-medium text-dark-text">Slot ${slotCounter}:</span>
                        <input type="date" class="slot-tarikh w-full mt-1 px-3 py-2 border border-tertiary rounded-lg">
                    </div>
                    <div class="flex items-end">
                        <button class="hapus-slot px-3 py-2 bg-secondary text-white rounded-lg hover:bg-secondary-hover transition">Hapus</button>
                    </div>
                </div>
            </div>`;

        // Templat untuk pelajar online
        const onlineStudentTemplate = () => `
            <div class="student-container p-4 border border-tertiary rounded-lg">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm text-dark-text mb-1">Nama Pelajar</label>
                        <input type="text" class="online-student-name w-full px-3 py-2 border border-tertiary rounded-lg" placeholder="Nama pelajar">
                    </div>
                    <div>
                        <label class="block text-sm text-dark-text mb-1">Jenis Kelas</label>
                        <select class="online-class-type w-full px-3 py-2 border border-tertiary rounded-lg">
                            <option value="peribadi">Kelas Peribadi</option>
                            <option value="kumpulan">Kelas Kumpulan</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-dark-text mb-1">Tahap</label>
                        <select class="online-class-level w-full px-3 py-2 border border-tertiary rounded-lg">
                            <option value="beginner">Beginner</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advance">Advance</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-between items-center mt-3">
                    <div class="text-sm">
                        <span class="font-medium text-dark-text">Elaun: </span>
                        <span class="online-student-fee text-secondary font-medium">RM65.00</span>
                    </div>
                    <button class="hapus-pelajar px-3 py-2 bg-secondary text-white rounded-lg hover:bg-secondary-hover transition">Hapus</button>
                </div>
            </div>`;


        // --- FUNGSI UTAMA & EVENT LISTENERS ---
        document.addEventListener("DOMContentLoaded", function () {
            // 1. Inisialisasi borang
            const today = new Date().toISOString().split("T")[0];
            document.getElementById("tarikhPenyata").value = today;
            
            // 2. Muat turun data jurulatih dari server
            google.script.run.withSuccessHandler(setupCoachDropdown).getCoachData();

            // 3. Pasang event listeners untuk butang utama
            document.getElementById("nama").addEventListener("change", updateBankDetails);
            document.getElementById("tambahKelas").addEventListener("click", () => addKelas("fizikal"));
            document.getElementById("tambahKelasPembangunan").addEventListener("click", () => addKelas("pembangunan"));
            document.getElementById("tambahPelajarOnline").addEventListener("click", addPelajarOnline);
            document.getElementById("kiraButton").addEventListener("click", calculateAll);
            document.getElementById("resetButton").addEventListener("click", resetForm);
            document.getElementById("saveButton").addEventListener("click", generateAndSave);

            // 4. Pasang event listener global untuk borang (delegation)
            // Ini akan mengira semula setiap kali ada perubahan
            const mainContent = document.querySelector("main");
            mainContent.addEventListener("change", calculateAll);
            mainContent.addEventListener("input", calculateAll);
            mainContent.addEventListener("click", function(event) {
                if (event.target.classList.contains("tambah-slot")) {
                    addSlot(event.target);
                }
                if (event.target.classList.contains("hapus-slot")) {
                    event.target.closest(".slot-container").remove();
                    calculateAll();
                }
                if (event.target.classList.contains("hapus-pelajar")) {
                    event.target.closest(".student-container").remove();
                    calculateAll();
                }
            });
            
            // 5. Tambah satu blok kelas permulaan untuk setiap jenis
            addKelas("fizikal");
            addKelas("pembangunan");
            addPelajarOnline();
        });

        /**
         * Mengisi dropdown nama jurulatih dengan data dari server.
         * @param {object} coachData Objek data jurulatih.
         */
        function setupCoachDropdown(coachData) {
            coachBankDetails = coachData;
            const coachSelect = document.getElementById("nama");
            coachSelect.innerHTML = ""; // Kosongkan pilihan sedia ada

            if (Object.keys(coachBankDetails).length === 0) {
                coachSelect.innerHTML = "<option>Gagal memuatkan data.</option>";
                return;
            }

            Object.keys(coachBankDetails).forEach(name => {
                const option = document.createElement("option");
                option.value = name;
                option.textContent = name;
                coachSelect.appendChild(option);
            });
            
            updateBankDetails(); // Kemas kini maklumat bank untuk jurulatih pertama
        }

        /**
         * Mengemas kini medan bank dan no. akaun berdasarkan jurulatih yang dipilih.
         */
        function updateBankDetails() {
            const selectedCoach = document.getElementById("nama").value;
            const details = coachBankDetails[selectedCoach];
            if (details) {
                document.getElementById("jenisBank").value = details.bank;
                document.getElementById("noAkaun").value = details.acc;
            } else {
                document.getElementById("jenisBank").value = "";
                document.getElementById("noAkaun").value = "";
            }
        }

        /**
         * Menambah blok kelas baru (fizikal atau pembangunan).
         * @param {string} type Jenis kelas: 'fizikal' atau 'pembangunan'.
         */
        function addKelas(type) {
            const container = document.getElementById(type === "fizikal" ? "kelasContainer" : "pembangunanContainer");
            const classCounter = container.children.length + 1;
            const template = type === "fizikal" ? fizikalTemplate(classCounter) : pembangunanTemplate(classCounter);
            container.insertAdjacentHTML("beforeend", template);
            addSlot(container.lastElementChild.querySelector(".tambah-slot"));
        }
        
        /**
         * Menambah slot masa baru ke dalam blok kelas.
         * @param {HTMLElement} button Butang 'Tambah Slot' yang ditekan.
         */
        function addSlot(button) {
            const slotsList = button.closest(".border").querySelector(".slots-list");
            const slotCounter = slotsList.children.length + 1;
            const type = button.dataset.type;
            const template = type === "fizikal" ? slotFizikalTemplate(slotCounter) : slotPembangunanTemplate(slotCounter);
            slotsList.insertAdjacentHTML("beforeend", template);
            calculateAll();
        }

        /**
         * Menambah blok pelajar online baru.
         */
        function addPelajarOnline() {
            document.getElementById("onlineStudentsContainer").insertAdjacentHTML("beforeend", onlineStudentTemplate());
            calculateAll();
        }

        /**
         * Mengira semua subtotal dan jumlah keseluruhan borang.
         */
        function calculateAll() {
            let totalFizikal = Array.from(document.querySelectorAll("#kelasContainer > div"))
                .reduce((total, el) => total + calculateLokasiSubtotal(el), 0);

            let totalPembangunan = Array.from(document.querySelectorAll("#pembangunanContainer > div"))
                .reduce((total, el) => total + calculateLokasiSubtotal(el), 0);

            let totalOnline = Array.from(document.querySelectorAll(".student-container"))
                .reduce((total, el) => total + calculateOnlineSubtotal(el), 0);

            let totalTambahan = Array.from(document.querySelectorAll(".tambahan-bonus"))
                .reduce((total, el) => total + (parseFloat(el.value) || 0), 0);

            let totalPengurangan = Array.from(document.querySelectorAll(".pengurangan"))
                .reduce((total, el) => total + (parseFloat(el.value) || 0), 0);

            // Kemas kini subtotal di UI
            document.querySelector(".subtotal-online-jumlah").textContent = `RM${totalOnline.toFixed(2)}`;
            document.querySelector(".subtotal-tambahan-bonus-jumlah").textContent = `RM${totalTambahan.toFixed(2)}`;
            document.querySelector(".subtotal-pengurangan-jumlah").textContent = `RM${totalPengurangan.toFixed(2)}`;

            // Kemas kini ringkasan akhir
            document.getElementById("jumlahFizikal").textContent = totalFizikal.toFixed(2);
            document.getElementById("jumlahPembangunan").textContent = totalPembangunan.toFixed(2);
            document.getElementById("jumlahOnline").textContent = totalOnline.toFixed(2);
            document.getElementById("jumlahTambahanBonus").textContent = totalTambahan.toFixed(2);
            document.getElementById("jumlahPengurangan").textContent = totalPengurangan.toFixed(2);
            
            const jumlahBersih = totalFizikal + totalPembangunan + totalOnline + totalTambahan - totalPengurangan;
            document.getElementById("jumlahBersih").textContent = jumlahBersih.toFixed(2);
        }

        /**
         * Mengira subtotal untuk satu blok lokasi (fizikal atau pembangunan).
         * @param {HTMLElement} lokasiElement Elemen div untuk satu lokasi/kumpulan.
         * @returns {number} Jumlah subtotal untuk lokasi tersebut.
         */
        function calculateLokasiSubtotal(lokasiElement) {
            const checkbox = lokasiElement.querySelector('input[type="checkbox"]');
            if (!checkbox || !checkbox.checked) {
                lokasiElement.querySelectorAll(".subtotal-pelajar, .subtotal-jarak, .subtotal-jumlah").forEach(el => el.textContent = "RM0.00");
                return 0;
            }

            const rate = parseFloat(lokasiElement.querySelector(".pelajar-rate").value) || 0;
            const slots = lokasiElement.querySelectorAll(".slot-container");
            let elaunJurulatih = slots.length * rate;

            let totalMileage = Array.from(slots).reduce((total, slot) => {
                let mileageValue = parseFloat(slot.querySelector(".slot-jarak")?.value) || 0;
                if (slot.querySelector(".slot-kenderaan")?.value === "motor") {
                    mileageValue /= 2;
                }
                return total + mileageValue;
            }, 0);

            const subtotal = elaunJurulatih + totalMileage;

            // Kemas kini UI untuk subtotal lokasi ini
            lokasiElement.querySelector(".subtotal-pelajar").textContent = `RM${elaunJurulatih.toFixed(2)}`;
            if (lokasiElement.querySelector(".subtotal-jarak")) {
                lokasiElement.querySelector(".subtotal-jarak").textContent = `RM${totalMileage.toFixed(2)}`;
            }
            lokasiElement.querySelector(".subtotal-jumlah").textContent = `RM${subtotal.toFixed(2)}`;
            
            return subtotal;
        }

        /**
         * Mengira subtotal untuk satu pelajar online.
         * @param {HTMLElement} studentElement Elemen div untuk satu pelajar.
         * @returns {number} Jumlah yuran untuk pelajar tersebut.
         */
        function calculateOnlineSubtotal(studentElement) {
            const classType = studentElement.querySelector(".online-class-type").value;
            const classLevel = studentElement.querySelector(".online-class-level").value;
            let fee = 0;

            if (classType === "peribadi") {
                if (classLevel === "beginner") fee = 65;
                else if (classLevel === "intermediate") fee = 75;
                else if (classLevel === "advance") fee = 25;
            } else if (classType === "kumpulan") {
                if (classLevel === "beginner") fee = 50;
                else if (classLevel === "intermediate") fee = 60;
            }

            studentElement.querySelector(".online-student-fee").textContent = `RM${fee.toFixed(2)}`;
            return fee;
        }

        /**
         * Mengosongkan dan menetapkan semula semua medan dalam borang.
         */
        function resetForm() {
            if (confirm("Adakah anda pasti untuk reset semua maklumat?")) {
                document.getElementById("nama").selectedIndex = 0;
                document.getElementById("bulan").value = "Januari";

                document.querySelectorAll('input[type="number"], input[type="text"]').forEach(input => {
                    if (input.id !== "nama" && input.id !== "jenisBank" && input.id !== "noAkaun") {
                        input.value = (input.type === "number") ? "0" : "";
                    }
                });

                document.getElementById("kelasContainer").innerHTML = "";
                document.getElementById("pembangunanContainer").innerHTML = "";
                document.getElementById("onlineStudentsContainer").innerHTML = "";

                addKelas("fizikal");
                addKelas("pembangunan");
                addPelajarOnline();

                updateBankDetails();
                document.getElementById("tarikhPenyata").value = new Date().toISOString().split("T")[0];
            }
        }
        
        /**
         * Mengumpul data borang dan menghantarnya ke Google Apps Script untuk disimpan.
         */
        function generateAndSave() {
            const saveButton = document.getElementById("saveButton");
            const statusMessage = document.getElementById("statusMessage");

            saveButton.disabled = true;
            saveButton.innerText = "Menyimpan...";
            statusMessage.textContent = "Menjana PDF dan menyimpan rekod...";
            statusMessage.className = "text-center mt-4 font-medium text-blue-600 opacity-100";
            
            const parseCurrency = (text) => parseFloat(text.replace("RM", "").trim()) || 0;

            // Kumpul semua data dari borang ke dalam satu objek
            const reportData = {
                coachName: document.getElementById("nama").value,
                month: document.getElementById("bulan").value,
                statementDate: document.getElementById("tarikhPenyata").value,
                bankInfo: {
                    bank: document.getElementById("jenisBank").value,
                    acc: document.getElementById("noAkaun").value
                },
                baseAmount: parseCurrency(document.getElementById("jumlahFizikal").textContent) +
                            parseCurrency(document.getElementById("jumlahPembangunan").textContent) +
                            parseCurrency(document.getElementById("jumlahOnline").textContent),
                extraAllowance: parseCurrency(document.getElementById("jumlahTambahanBonus").textContent),
                deductions: parseCurrency(document.getElementById("jumlahPengurangan").textContent),
                netAmount: parseCurrency(document.getElementById("jumlahBersih").textContent),
                fizikal: [],
                pembangunan: [],
                online: [],
                tambahanBonusDetails: [],
                penguranganDetails: []
            };

            // Kumpul butiran kelas fizikal
            document.querySelectorAll("#kelasContainer .border").forEach(container => {
                if (container.querySelector('input[type="checkbox"]:checked')) {
                    const kelasData = {
                        nama: container.querySelector(".nama-lokasi").value || "Lokasi Tidak Dinamakan",
                        elaunPerSlot: parseFloat(container.querySelector(".pelajar-rate").value) || 0,
                        slots: []
                    };
                    container.querySelectorAll(".slot-container").forEach(slot => {
                        kelasData.slots.push({
                            tarikh: slot.querySelector(".slot-tarikh").value,
                            kenderaan: slot.querySelector(".slot-kenderaan").value,
                            jarakValue: slot.querySelector(".slot-jarak").value
                        });
                    });
                    reportData.fizikal.push(kelasData);
                }
            });

            // Kumpul butiran kelas pembangunan
            document.querySelectorAll("#pembangunanContainer .border").forEach(container => {
                if (container.querySelector('input[type="checkbox"]:checked')) {
                    reportData.pembangunan.push({
                        nama: container.querySelector(".nama-lokasi").value || "Kumpulan Tidak Dinamakan",
                        jumlah: container.querySelector(".subtotal-jumlah").textContent
                    });
                }
            });
            
            // Kumpul butiran pelajar online
            document.querySelectorAll(".student-container").forEach(container => {
                const studentName = container.querySelector(".online-student-name").value;
                if (studentName) {
                    reportData.online.push({
                        nama: studentName,
                        jumlah: container.querySelector(".online-student-fee").textContent
                    });
                }
            });
            
            // Fungsi bantuan untuk menambah butiran jika nilainya lebih besar dari 0
            const addDetailIfPositive = (detailsArray, inputId, description) => {
                const value = parseFloat(document.getElementById(inputId).value);
                if (value > 0) {
                    detailsArray.push({
                        keterangan: description,
                        jumlah: "RM" + value.toFixed(2)
                    });
                }
            };
            
            // Kumpul butiran elaun tambahan & bonus
            addDetailIfPositive(reportData.tambahanBonusDetails, "elaunKejohanan", "Elaun Penyertaan Kejohanan");
            addDetailIfPositive(reportData.tambahanBonusDetails, "elaunMakan", "Elaun Makan");
            addDetailIfPositive(reportData.tambahanBonusDetails, "elaunArbiter", "Elaun Arbiter");
            addDetailIfPositive(reportData.tambahanBonusDetails, "elaunPembantu", "Elaun Pembantu");
            addDetailIfPositive(reportData.tambahanBonusDetails, "bonusTahunan", "Bonus Tahunan");
            addDetailIfPositive(reportData.tambahanBonusDetails, "bonusPerayaan", "Bonus Perayaan");
            addDetailIfPositive(reportData.tambahanBonusDetails, "bonusPelajar", "Bonus Pencapaian Pelajar");
            addDetailIfPositive(reportData.tambahanBonusDetails, "bonusJurulatih", "Bonus Pencapaian Jurulatih");

            // Kumpul butiran pengurangan
            addDetailIfPositive(reportData.penguranganDetails, "kejohanan", "Penyertaan Kejohanan");
            addDetailIfPositive(reportData.penguranganDetails, "yuran", "Komitmen Yuran Bulanan");
            addDetailIfPositive(reportData.penguranganDetails, "rakaman", "Sistem Rakaman");
            addDetailIfPositive(reportData.penguranganDetails, "peralatan", "Pembelian Peralatan");
            
            const lainPenguranganValue = parseFloat(document.getElementById("lainPengurangan").value);
            if (lainPenguranganValue > 0) {
                reportData.penguranganDetails.push({
                    keterangan: document.getElementById("lainKeterangan").value || "Lain-lain",
                    jumlah: "RM" + lainPenguranganValue.toFixed(2)
                });
            }

            // Panggil fungsi server Google Apps Script
            google.script.run
                .withSuccessHandler(response => {
                    if (response.status === 'success') {
                        statusMessage.textContent = response.message;
                        statusMessage.className = "text-center mt-4 font-medium text-green-600 opacity-100";
                        window.open(response.pdfUrl, "_blank"); // Buka PDF di tab baru
                    } else {
                        throw new Error(response.message || "Ralat tidak diketahui dari server.");
                    }
                    saveButton.disabled = false;
                    saveButton.innerText = "Cetak & Simpan PDF";
                })
                .withFailureHandler(error => {
                    statusMessage.textContent = `Ralat: ${error.message}`;
                    statusMessage.className = "text-center mt-4 font-medium text-red-600 opacity-100";
                    saveButton.disabled = false;
                    saveButton.innerText = "Cetak & Simpan PDF";
                })
                .saveRecordAndGeneratePdf(reportData);
                
            // Sembunyikan mesej status selepas beberapa saat
            setTimeout(() => {
                statusMessage.style.opacity = '0';
            }, 7000);
        }
    </script>
</body>
</html>
