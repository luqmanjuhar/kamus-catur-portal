/**
 * @fileoverview Script untuk menguruskan dan mengira elaun jurulatih,
 * menjana slip PDF, dan menyediakan papan pemuka untuk jurulatih.
 * @version 2.0
 */

// ================================================================= //
//                            KONFIGURASI                            //
// ================================================================= //

const JURULATIH_SHEET_NAME = 'Jurulatih';
const REKOD_SHEET_NAME = 'Rekod Elaun';
const DETAIL_REKOD_SHEET_NAME = 'Rekod Terperinci';
const PDF_FOLDER_NAME = 'Slip Gaji Jurulatih';


// ================================================================= //
//                        TITIK MASUK UTAMA (WEB APP)                //
// ================================================================= //

/**
 * Mengendalikan permintaan GET ke aplikasi web.
 * Bertindak sebagai penghala (router) untuk memaparkan halaman yang betul.
 * @param {object} e Objek acara daripada permintaan GET.
 * @returns {HtmlService.HtmlOutput} Output HTML untuk dipaparkan.
 */
function doGet(e) {
  if (e.parameter.page === 'dashboard') {
    return HtmlService.createHtmlOutputFromFile('Dashboard.html').setTitle('Dashboard Jurulatih');
  }
  return HtmlService.createHtmlOutputFromFile('Index').setTitle('Kalkulator Elaun Jurulatih');
}


// ================================================================= //
//                       FUNGSI UNTUK ADMIN                          //
// ================================================================= //

/**
 * Mendapatkan data semua jurulatih dari spreadsheet.
 * @returns {object} Objek yang memetakan nama jurulatih kepada maklumat bank dan akaun mereka.
 */
function getCoachData() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(JURULATIH_SHEET_NAME);
    if (!sheet || sheet.getLastRow() < 2) return {};

    const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 3).getValues();
    const coachMap = {};

    data.forEach(row => {
      const [name, bank, acc] = row;
      if (name) {
        coachMap[name] = { bank, acc };
      }
    });

    return coachMap;
  } catch (e) {
    Logger.log(`Error in getCoachData: ${e.message}`);
    return {};
  }
}

/**
 * Menyimpan rekod elaun ke dalam spreadsheet dan menjana slip gaji dalam format PDF.
 * @param {object} reportData Data lengkap laporan elaun daripada antara muka pengguna (UI).
 * @returns {object} Objek status yang mengandungi mesej kejayaan/ralat dan URL PDF.
 */
function saveRecordAndGeneratePdf(reportData) {
  try {
    // 1. Kira jumlah tuntutan dan jana PDF
    reportData.totalMileage = calculateTotalMileage(reportData.fizikal);
    const pdfUrl = generateAndSavePayslip(reportData);
    if (!pdfUrl || pdfUrl.startsWith('Error')) {
      throw new Error(pdfUrl || 'Gagal menjana PDF.');
    }

    // 2. Sediakan data untuk disimpan
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const uniqueId = `${new Date().toISOString().slice(0, 10)}-${Math.random().toString(36).substr(2, 5).toUpperCase()}`;
    const recordDate = new Date();

    // 3. Simpan ringkasan rekod
    const summarySheet = ss.getSheetByName(REKOD_SHEET_NAME);
    const summaryRow = createSummaryRow(reportData, uniqueId, recordDate, pdfUrl);
    summarySheet.appendRow(summaryRow);

    // 4. Simpan rekod terperinci
    const detailSheet = ss.getSheetByName(DETAIL_REKOD_SHEET_NAME);
    const detailRows = createDetailRows(reportData, uniqueId, recordDate);
    if (detailRows.length > 0) {
      detailSheet.getRange(detailSheet.getLastRow() + 1, 1, detailRows.length, detailRows[0].length).setValues(detailRows);
    }

    return {
      status: 'success',
      message: 'Rekod berjaya disimpan dan PDF telah dijana!',
      pdfUrl: pdfUrl
    };
  } catch (e) {
    Logger.log(`Error in saveRecordAndGeneratePdf: ${e.message} \nStack: ${e.stack}`);
    return {
      status: 'error',
      message: e.message
    };
  }
}


// ================================================================= //
//                       FUNGSI UNTUK JURULATIH                      //
// ================================================================= //

/**
 * Mendapatkan senarai nama semua jurulatih untuk paparan login.
 * @returns {string[]} Senarai nama jurulatih.
 */
function getCoachNames() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(JURULATIH_SHEET_NAME);
    if (sheet.getLastRow() < 2) return [];

    const range = sheet.getRange(2, 1, sheet.getLastRow() - 1, 1);
    return range.getValues().flat().filter(String);
  } catch (e) {
    Logger.log(`Error in getCoachNames: ${e.message}`);
    return [];
  }
}

/**
 * Mengesahkan maklumat login jurulatih.
 * @param {object} credentials Objek yang mengandungi `coachName` dan `accNumber`.
 * @returns {object} Objek yang menandakan kejayaan atau kegagalan pengesahan.
 */
function verifyCoachLogin(credentials) {
  try {
    const coachData = getCoachData();
    const coachInfo = coachData[credentials.coachName];
    const normalize = (str) => str ? String(str).replace(/[\s-]+/g, '') : '';

    if (coachInfo && normalize(coachInfo.acc) === normalize(credentials.accNumber)) {
      return { success: true };
    }
    return { success: false, message: "Nama atau nombor akaun tidak sah." };
  } catch (e) {
    Logger.log(`Error in verifyCoachLogin: ${e.message}`);
    return { success: false, message: "Ralat pada sistem." };
  }
}

/**
 * Mendapatkan senarai ID Rujukan yang tersedia untuk jurulatih tertentu.
 * @param {string} coachName Nama jurulatih.
 * @returns {string[]} Senarai ID Rujukan yang unik.
 */
function getAvailableReferenceIDs(coachName) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(REKOD_SHEET_NAME);
    if (sheet.getLastRow() < 2) return [];

    const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 4).getValues();
    const ids = data
      .filter(row => row[3] === coachName && row[0])
      .map(row => row[0]);

    return [...new Set(ids)]; // Pulangkan ID yang unik sahaja
  } catch (e) {
    Logger.log(`Error in getAvailableReferenceIDs: ${e.message}`);
    return [];
  }
}

/**
 * Mendapatkan rekod elaun berdasarkan ID Rujukan dan nama jurulatih.
 * @param {string} selectedId ID Rujukan yang dipilih.
 * @param {string} coachName Nama jurulatih yang sedang login.
 * @returns {object} Objek yang mengandungi data ringkasan atau mesej ralat.
 */
function getCoachRecords(selectedId, coachName) {
  if (!coachName || !selectedId) {
    return { error: "Sesi atau ID tidak sah." };
  }
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const logSheet = ss.getSheetByName(REKOD_SHEET_NAME);
    const textFinder = logSheet.getRange("A:A").createTextFinder(selectedId);
    const foundCell = textFinder.findNext();

    if (!foundCell) {
      return { error: `ID Rujukan ${selectedId} tidak ditemui.` };
    }

    const summaryRowIndex = foundCell.getRow();
    const summaryRecord = logSheet.getRange(summaryRowIndex, 1, 1, logSheet.getLastColumn()).getValues()[0];

    // Sahkan bahawa rekod ini milik jurulatih yang betul
    if (summaryRecord[3] !== coachName) {
      return { error: "Anda tidak mempunyai akses kepada rekod ini." };
    }

    const summaryResult = [{
      statementDate: summaryRecord[2],
      month: summaryRecord[4],
      netAmount: summaryRecord[10],
      payslipUrl: summaryRecord[11]
    }];

    return { idRujukan: selectedId, summary: summaryResult };
  } catch (e) {
    Logger.log(`Error in getCoachRecords: ${e.message}`);
    return { error: "Gagal membaca data rekod." };
  }
}


// ================================================================= //
//               FUNGSI BANTUAN (INTERNAL HELPERS)                   //
// ================================================================= //

/**
 * Mengira jumlah tuntutan mileage daripada data kelas fizikal.
 * @param {object[]} fizikalArray Senarai objek kelas fizikal.
 * @returns {number} Jumlah tuntutan mileage.
 */
function calculateTotalMileage(fizikalArray) {
  return fizikalArray.reduce((total, kelas) => {
    return total + kelas.slots.reduce((subTotal, slot) => {
      return subTotal + calculateMileageClaim(slot);
    }, 0);
  }, 0);
}

/**
 * Mengira tuntutan mileage untuk satu slot kelas.
 * @param {object} slot Objek slot yang mengandungi `jarakValue` dan `kenderaan`.
 * @returns {number} Jumlah tuntutan mileage untuk slot tersebut.
 */
function calculateMileageClaim(slot) {
  let mileage = parseFloat(slot.jarakValue) || 0;
  if (mileage > 0 && slot.kenderaan === 'motor') {
    mileage /= 2;
  }
  return mileage;
}

/**
 * Mencipta baris data untuk helaian ringkasan rekod.
 * @param {object} data Data laporan.
 * @param {string} id ID unik untuk rekod.
 * @param {Date} date Tarikh rekod dibuat.
 * @param {string} url URL ke PDF slip gaji.
 * @returns {any[]} Array yang mewakili satu baris dalam spreadsheet.
 */
function createSummaryRow(data, id, date, url) {
  return [
    id, date, new Date(data.statementDate),
    data.coachName, data.month, data.baseAmount,
    data.extraAllowance, data.deductions, ' ', ' ',
    data.netAmount, url
  ];
}

/**
 * Mencipta barisan data untuk helaian rekod terperinci.
 * @param {object} reportData Data laporan.
 * @param {string} uniqueId ID unik untuk rekod.
 * @param {Date} recordDate Tarikh rekod dibuat.
 * @returns {any[][]} Array 2D yang mewakili semua baris terperinci.
 */
function createDetailRows(reportData, uniqueId, recordDate) {
  const detailRows = [];
  const coachName = reportData.coachName;
  const parseCurrency = (text) => parseFloat(String(text).replace(/[^0-9.-]+/g, "")) || 0;
  
  const addRow = (date, type, description, amount) => {
    detailRows.push([uniqueId, recordDate, coachName, date, type, description, amount]);
  };
  
  // Elaun Kelas Fizikal & Mileage
  reportData.fizikal.forEach(kelas => {
    kelas.slots.forEach(slot => {
      const kelasTarikh = slot.tarikh ? new Date(slot.tarikh) : null;
      addRow(kelasTarikh, 'Kelas Fizikal - Elaun', kelas.nama, kelas.elaunPerSlot);
      const mileageClaim = calculateMileageClaim(slot);
      if (mileageClaim > 0) {
        addRow(kelasTarikh, 'Kelas Fizikal - Mileage', `Perjalanan ke ${kelas.nama}`, mileageClaim);
      }
    });
  });

  // Butiran lain
  reportData.pembangunan.forEach(item => addRow('', 'Kelas Pembangunan', item.nama, parseCurrency(item.jumlah)));
  reportData.online.forEach(item => addRow('', 'Kelas Online', item.nama, parseCurrency(item.jumlah)));
  reportData.tambahanBonusDetails.forEach(item => addRow('', 'Bonus/Elaun Tambahan', item.keterangan, parseCurrency(item.jumlah)));
  reportData.penguranganDetails.forEach(item => addRow('', 'Potongan', item.keterangan, -Math.abs(parseCurrency(item.jumlah))));

  return detailRows;
}

/**
 * Menjana dan menyimpan slip gaji sebagai fail PDF di Google Drive.
 * @param {object} reportData Data laporan untuk dipaparkan pada slip gaji.
 * @returns {string} URL fail PDF yang telah dibuat atau mesej ralat.
 */
function generateAndSavePayslip(reportData) {
  try {
    const mainFolder = getOrCreateFolder(PDF_FOLDER_NAME);
    const statementDate = new Date(reportData.statementDate);
    const year = statementDate.getFullYear().toString();
    const month = ('0' + (statementDate.getMonth() + 1)).slice(-2) + ' - ' + statementDate.toLocaleString('ms-MY', { month: 'long' });

    const yearFolder = getOrCreateFolder(year, mainFolder);
    const monthFolder = getOrCreateFolder(month, yearFolder);

    const htmlContent = createPayslipHtml(reportData);
    const fileName = `Slip-${year}-${('0' + (statementDate.getMonth() + 1)).slice(-2)}-${reportData.coachName}.pdf`;
    const pdfBlob = Utilities.newBlob(htmlContent, MimeType.HTML, fileName).getAs(MimeType.PDF);
    const pdfFile = monthFolder.createFile(pdfBlob);

    Logger.log('PDF saved successfully: ' + pdfFile.getUrl());
    return pdfFile.getUrl();
  } catch (e) {
    Logger.log(`Error in generateAndSavePayslip: ${e.message}`);
    return `Error creating PDF: ${e.message}`;
  }
}

/**
 * Mencipta kandungan HTML untuk slip gaji dengan watermark dan butiran syarikat.
 * @param {object} data Data laporan elaun.
 * @returns {string} Rentetan HTML yang lengkap.
 */
function createPayslipHtml(data) {
  // Pautan ke logo syarikat anda
  const logoUrl = 'https://raw.githubusercontent.com/luqmanjuhar/chesstrainercalculator/main/Asset%2028.png';
  
  // Maklumat Syarikat
  const companyDetails = {
    name: 'KAMUS CATUR ENTERPRISE (CT0099869-W)',
    address: 'NO 7A, JALAN PULAI PERDANA 11/2, TAMAN SRI PULAI PERDANA, 81300, JOHOR BAHRU, JOHOR',
    contact: 'TEL: 018-2046224 | EMEL: kamus.catur@gmail.com'
  };

  const css = `
    <style>
      body { font-family: Arial, sans-serif; color: #333; font-size: 10pt; }
      .container { 
          border: 1px solid #ccc; 
          padding: 25px; 
          width: 700px; 
          margin: auto; 
          /* --- BAHAGIAN WATERMARK DIMASUKKAN DI SINI --- */
          background-image: url('${logoUrl}');
          background-repeat: no-repeat;
          background-position: center;
          background-size: 400px; /* Saiz watermark, boleh laras */
      }
      .content-wrapper {
          /* Wrapper ini memastikan kandungan tidak terjejas oleh watermark */
          background-color: rgba(255, 255, 255, 0.95); /* Latar belakang sedikit putih untuk pastikan teks boleh dibaca */
          padding: 20px;
      }
      .header { text-align: center; border-bottom: 2px solid #F37324; padding-bottom: 10px; margin-bottom: 20px; }
      .header h2 { margin: 0; font-size: 16pt; color: #F37324; }
      .header p { margin: 5px 0 0; }
      .company-details { font-size: 8pt; color: #555; margin-top: 10px; line-height: 1.4; }
      h3 { color: #E56214; border-bottom: 1px solid #FBD0A4; padding-bottom: 5px; margin-top: 25px; }
      .info-table { width: 100%; margin-bottom: 25px; }
      .info-table td { padding: 4px; }
      .details-table { width: 100%; border-collapse: collapse; margin-bottom: 25px; }
      .details-table th, .details-table td { text-align: left; padding: 8px; border-bottom: 1px solid #eee; }
      .details-table th { background-color: #F37324; color: white; font-weight: bold; }
      .details-table .amount { text-align: right; }
      .summary-section { margin-top: 20px; padding-top: 10px; border-top: 2px solid #F37324; }
      .summary-table { width: 50%; float: right; }
      .summary-table td { padding: 5px; }
      .summary-table .label { text-align: right; font-weight: bold; padding-right: 15px; }
      .summary-table .total { font-weight: bold; color: #F37324; border-top: 1px solid #333; }
    </style>
  `;

  const buildRows = (items, descKey = 'nama', valKey = 'jumlah') => {
    if (!items || items.length === 0) return '<tr><td colspan="2" style="text-align:center;color:#888;">Tiada rekod</td></tr>';
    return items.map(item => `
      <tr>
        <td>${item[descKey]}</td>
        <td class="amount">${item[valKey]}</td>
      </tr>
    `).join('');
  };

  const fizikalRows = data.fizikal.map(k => ({
    nama: `Elaun Kelas Fizikal - ${k.nama}`,
    jumlah: `RM ${(k.elaunPerSlot * k.slots.length).toFixed(2)}`
  }));
  
  if (data.totalMileage > 0) {
    fizikalRows.push({
      nama: 'Tuntutan Mileage',
      jumlah: `RM ${data.totalMileage.toFixed(2)}`
    });
  }

  const html = `
  <!DOCTYPE html>
  <html>
  <head>${css}</head>
  <body>
    <div class="container">
      <div class="content-wrapper">
        <div class="header">
          <h2>SLIP ELAUN JURULATIH</h2>
          <div class="company-details">
            <p><strong>${companyDetails.name}</strong></p>
            <p>${companyDetails.address}</p>
            <p>${companyDetails.contact}</p>
          </div>
          <p style="margin-top: 15px;">Bulan: ${data.month}</p>
        </div>
        
        <table class="info-table">
          <tr>
            <td><b>Nama Jurulatih:</b></td><td>${data.coachName}</td>
            <td><b>Tarikh Penyata:</b></td><td>${new Date(data.statementDate).toLocaleDateString('ms-MY')}</td>
          </tr>
          <tr>
            <td><b>Bank:</b></td><td>${data.bankInfo.bank}</td>
            <td><b>No. Akaun:</b></td><td>${data.bankInfo.acc}</td>
          </tr>
        </table>
        
        <h3>PENDAPATAN ELAUN</h3>
        <table class="details-table">
          <thead><tr><th>Keterangan</th><th class="amount">Jumlah</th></tr></thead>
          <tbody>
            ${buildRows(fizikalRows)}
            ${buildRows(data.pembangunan)}
            ${buildRows(data.online)}
            ${buildRows(data.tambahanBonusDetails, 'keterangan')}
          </tbody>
        </table>
        
        <h3>POTONGAN</h3>
        <table class="details-table">
          <thead><tr><th>Keterangan</th><th class="amount">Jumlah</th></tr></thead>
          <tbody>
            ${buildRows(data.penguranganDetails, 'keterangan')}
          </tbody>
        </table>
        
        <div class="summary-section">
          <table class="summary-table">
            <tr><td class="label">Jumlah Pendapatan:</td><td class="amount">RM ${(data.baseAmount + data.extraAllowance).toFixed(2)}</td></tr>
            <tr><td class="label">Jumlah Potongan:</td><td class="amount">RM ${data.deductions.toFixed(2)}</td></tr>
            <tr><td class="label total">JUMLAH BERSIH:</td><td class="amount total">RM ${data.netAmount.toFixed(2)}</td></tr>
          </table>
          <div style="clear:both;"></div>
        </div>
      </div>
    </div>
  </body>
  </html>`;
  return html;
}

/**
 * Mendapatkan folder sedia ada atau mencipta folder baru jika tiada.
 * @param {string} folderName Nama folder yang dicari/dicipta.
 * @param {DriveApp.Folder} [parentFolder=DriveApp] Folder induk. Lalai adalah folder root.
 * @returns {DriveApp.Folder} Objek folder.
 */
function getOrCreateFolder(folderName, parentFolder = DriveApp) {
  const folders = parentFolder.getFoldersByName(folderName);
  return folders.hasNext() ? folders.next() : parentFolder.createFolder(folderName);
}
